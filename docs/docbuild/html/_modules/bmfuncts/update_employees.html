

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bmfuncts.update_employees &mdash; BiblioMeter 5.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=ce74c6a2"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BiblioMeter
              <img src="../../_static/BM-logo.ico" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Description</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../description.html">BiblioMeter description</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GUI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gui.html">BiblioMeter <cite>bmgui</cite> package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../functions.html">BiblioMeter <cite>bmfuncts</cite> package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BiblioMeter</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bmfuncts.update_employees</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bmfuncts.update_employees</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module of functions for the update of the employees database.&quot;&quot;&quot;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;update_employees&#39;</span><span class="p">,]</span>

<span class="c1"># Standard library imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># 3rd party imports</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># local imports</span>
<span class="kn">import</span> <span class="nn">bmfuncts.employees_globals</span> <span class="k">as</span> <span class="nn">eg</span>
<span class="kn">import</span> <span class="nn">bmfuncts.pub_globals</span> <span class="k">as</span> <span class="nn">pg</span>

<span class="k">def</span> <span class="nf">_set_employees_paths</span><span class="p">(</span><span class="n">bibliometer_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_set_employees_paths` sets the full paths towards</span>
<span class="sd">    4 working folders:</span>
<span class="sd">    - &#39;months2add_employees_folder_path&#39;: the folder containing</span>
<span class="sd">    the employees Excel file(s) to add; this file must contain</span>
<span class="sd">    one sheet per month for a given year.</span>
<span class="sd">    - &#39;all_years_employees_folder_path&#39;: the folder hosting</span>
<span class="sd">    the employees ExcelL file which name is given by the global</span>
<span class="sd">    &#39;EMPLOYEES_ARCHI&#39; at key &#39;all_years_employees&#39; containing a sheet per year.</span>
<span class="sd">    - &#39;one_year_employees_folder_path&#39;: the folder hosting</span>
<span class="sd">    the annual employees Excel files which names are built</span>
<span class="sd">    by adding the year value to the string given by the global</span>
<span class="sd">    &#39;EMPLOYEES_ARCHI&#39; at key &#39;one_year_employees_filebase&#39;.</span>
<span class="sd">    - &#39;backup_folder_path&#39;: the folder hosting the back-up file</span>
<span class="sd">    of the employees EXCEL file in case of a potential corruption</span>
<span class="sd">    of the active employees file.</span>

<span class="sd">    Args:</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        (tup): Tuple of the 4 built paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">root_employees_folder_alias</span>       <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ARCHI</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span>
    <span class="n">all_years_employees_folder_alias</span>  <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ARCHI</span><span class="p">[</span><span class="s2">&quot;all_years_employees&quot;</span><span class="p">]</span>
    <span class="n">one_year_employees_folder_alias</span>   <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ARCHI</span><span class="p">[</span><span class="s2">&quot;one_year_employees&quot;</span><span class="p">]</span>
    <span class="n">months2add_employees_folder_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ARCHI</span><span class="p">[</span><span class="s2">&quot;complementary_employees&quot;</span><span class="p">]</span>
    <span class="n">backup_folder_alias</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_BACKUP</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span>

    <span class="c1"># Setting useful paths</span>
    <span class="n">root_employees_folder_path</span>       <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_employees_folder_alias</span><span class="p">)</span>
    <span class="n">months2add_employees_folder_path</span> <span class="o">=</span> <span class="n">root_employees_folder_path</span> <span class="o">/</span> \
                                       <span class="n">Path</span><span class="p">(</span><span class="n">months2add_employees_folder_alias</span><span class="p">)</span>
    <span class="n">all_years_employees_folder_path</span>  <span class="o">=</span> <span class="n">root_employees_folder_path</span> <span class="o">/</span> \
                                       <span class="n">Path</span><span class="p">(</span><span class="n">all_years_employees_folder_alias</span><span class="p">)</span>
    <span class="n">one_year_employees_folder_path</span>   <span class="o">=</span> <span class="n">root_employees_folder_path</span> <span class="o">/</span> \
                                       <span class="n">Path</span><span class="p">(</span><span class="n">one_year_employees_folder_alias</span><span class="p">)</span>
    <span class="n">backup_folder_path</span>               <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">backup_folder_alias</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">months2add_employees_folder_path</span><span class="p">,</span> <span class="n">all_years_employees_folder_path</span><span class="p">,</span>
            <span class="n">one_year_employees_folder_path</span><span class="p">,</span> <span class="n">backup_folder_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_sheet_month</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_check_sheet_month` checks if the mandatory column names</span>
<span class="sd">    of the dataframe &#39;df&#39; are present and if the sheet name &#39;sheet_name&#39; is</span>
<span class="sd">    formatted as mmyyyy where yyyy stands for the &#39;year&#39; and mm stands</span>
<span class="sd">    for the month (always written with two digits). It returns messages</span>
<span class="sd">    related to the check status. The year returned is None if the sheet name</span>
<span class="sd">    is not correctly formatted or the month is not in possible months.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (dataframe): The dataframe to be checked.</span>
<span class="sd">        sheet_name (str): The sheet name to be checked.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tup): Tuple of 3 strings = (year, sheet_name_error, col_error).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting lists of columns</span>
    <span class="n">useful_col_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Initializing error messages</span>
    <span class="n">col_error</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sheet_name_error</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">missing_column</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">useful_col_list</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_column</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">col_error</span>  <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The column(s) &#39;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">missing_column</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; is (are) missing or misspelled &quot;</span>
        <span class="n">col_error</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;in sheet name &#39;</span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>


    <span class="n">possible_months</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;01&#39;</span><span class="p">,</span> <span class="s1">&#39;02&#39;</span><span class="p">,</span> <span class="s1">&#39;03&#39;</span><span class="p">,</span> <span class="s1">&#39;04&#39;</span><span class="p">,</span> <span class="s1">&#39;05&#39;</span><span class="p">,</span> <span class="s1">&#39;06&#39;</span><span class="p">,</span> <span class="s1">&#39;07&#39;</span><span class="p">,</span> <span class="s1">&#39;08&#39;</span><span class="p">,</span> <span class="s1">&#39;09&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;11&#39;</span><span class="p">,</span> <span class="s1">&#39;12&#39;</span><span class="p">]</span>
    <span class="n">year</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">re_mmyyyy</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\d</span><span class="si">{6}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">re_mmyyyy</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">sheet_name</span><span class="p">):</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">sheet_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">possible_months</span><span class="p">:</span>
            <span class="n">year</span>  <span class="o">=</span> <span class="n">sheet_name</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sheet_name_error</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Month &#39;</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s2">&#39; is not among possible months &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;in sheet name &#39;</span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sheet_name_error</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The sheet name &#39;</span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;is not correctly formated as mmyyyy.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">year</span><span class="p">,</span> <span class="n">sheet_name_error</span><span class="p">,</span> <span class="n">col_error</span>


<span class="k">def</span> <span class="nf">_add_sheets_to_workbook</span><span class="p">(</span><span class="n">file_full_path</span><span class="p">,</span> <span class="n">df_to_add</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_add_sheets_to_workbook` add the dataframe &#39;df_to_add&#39;</span>
<span class="sd">    as sheet named &#39;sheet_name&#39; to the existing Excel file</span>
<span class="sd">    with full path &#39;file_full_path&#39;. If the sheet name already</span>
<span class="sd">    exists it is overwritten by the new one.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">file_full_path</span><span class="p">,</span>  <span class="c1"># https://github.com/PyCQA/pylint/issues/3060 pylint: disable=abstract-class-instantiated</span>
                        <span class="n">engine</span> <span class="o">=</span> <span class="s1">&#39;openpyxl&#39;</span><span class="p">,</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
                        <span class="n">if_sheet_exists</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">df_to_add</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_update_months_history</span><span class="p">(</span><span class="n">months2add_file_path</span><span class="p">,</span>
                           <span class="n">one_year_employees_folder_path</span><span class="p">,</span>
                           <span class="n">one_year_employees_basename_alias</span><span class="p">,</span>
                           <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_update_months_history` update the file</span>
<span class="sd">    pointed by &#39;year_months_file_path&#39; for a year.</span>
<span class="sd">    More specifically only the new months contained in the EXCEL file</span>
<span class="sd">    pointed by &#39;months2add_file_path&#39; are added as new sheets</span>
<span class="sd">    named mmyyyy where mm stands for the month and yyyy for the year.</span>
<span class="sd">    The sheets are checked using the local function &#39;_check_sheet_month&#39;</span>
<span class="sd">    of the module &#39;BiblioMeterUpdateEmployees&#39; of the package &#39;bmfuncts&#39;.</span>
<span class="sd">    This function returns error messages if the sheets to add are misconfigured.</span>
<span class="sd">    If no error is returned, the sheets are added using the local function</span>
<span class="sd">    &#39;_add_sheets_to_workbook&#39; of the module &#39;BiblioMeterUpdateEmployees&#39;</span>
<span class="sd">    of the package &#39;bmfuncts&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        months2add_file_path (path): Full path to the employees EXCEL file</span>
<span class="sd">                                     with one sheet per months to update the employees file.</span>
<span class="sd">        one_year_employees_folder_path (path): Full path to the folder containing</span>
<span class="sd">                                               the files gathering the employees per year.</span>
<span class="sd">        one_year_employees_basename_alias (path): Base for building the file name of the file</span>
<span class="sd">                                                  gathering the employees for a year.</span>
<span class="sd">        replace (bool): If true, existing sheets are replaced in the EXCEL file (default: True).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple of 5 str): (year, year_months_file_path, sheet_name_message,</span>
<span class="sd">                           col_message, years2add_message).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df_months_to_add</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">months2add_file_path</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">months_to_add</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_months_to_add</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">years_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months_to_add</span><span class="p">:</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="n">_check_sheet_month</span><span class="p">(</span><span class="n">df_months_to_add</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">month</span><span class="p">)</span>
        <span class="n">month_year</span><span class="p">,</span> <span class="n">month_sheet_name_error</span><span class="p">,</span> <span class="n">month_col_error</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">month_sheet_name_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">month_sheet_name_error</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">month_col_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">month_col_error</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">month_year</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">month_sheet_name_error</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">years_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_year</span><span class="p">)</span>

    <span class="n">years_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">years_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">years_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">years2add_error</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Too many years covered by the file of months &#39;</span>
                           <span class="s1">&#39;to add while expected only one.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">years2add_error</span>

    <span class="n">year</span> <span class="o">=</span> <span class="n">years_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">one_year_employees_basename_alias</span>
    <span class="n">year_months_file_path</span> <span class="o">=</span> <span class="n">one_year_employees_folder_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">year_months_file_path</span><span class="p">):</span>
        <span class="c1"># if the file already exits we update with new sheets</span>
        <span class="n">df_months_dict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">year_months_file_path</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span><span class="p">:</span> <span class="c1"># we only add missing months</span>
            <span class="n">months_present</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_months_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">months_to_add</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">months_to_add</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">months_present</span><span class="p">))</span>
            <span class="n">months_to_add</span>  <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">months_to_add</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months_to_add</span><span class="p">:</span>
            <span class="n">_add_sheets_to_workbook</span><span class="p">(</span><span class="n">year_months_file_path</span><span class="p">,</span> <span class="n">df_months_to_add</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">month</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if the file is not present we create a new Excel file with one sheet per month</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">months_to_add</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># we add the first month</span>
        <span class="n">df_months_to_add</span><span class="p">[</span><span class="n">month</span><span class="p">]</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">year_months_file_path</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">month</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months_to_add</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="c1"># we add the other months</span>
            <span class="n">_add_sheets_to_workbook</span><span class="p">(</span><span class="n">year_months_file_path</span><span class="p">,</span> <span class="n">df_months_to_add</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">month</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">year</span><span class="p">,</span> <span class="n">year_months_file_path</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_add_column_keep_history</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_add_column_keep_history` creates 4 new columns</span>
<span class="sd">    defined by the global &#39;EFFECTIF_ADD_COLS&#39; at the keys &#39;dpts_list&#39;,</span>
<span class="sd">    &#39;servs_list&#39;, &#39;months_list&#39; and &#39;years_list&#39;.</span>
<span class="sd">    These columns contain, for each employee, the lists of its departments</span>
<span class="sd">    and services affiliation per available months.</span>
<span class="sd">        ex: if for an employee the column of key &#39;months_list&#39; contains</span>
<span class="sd">        [&#39;01&#39;, &#39;02&#39;, &#39;03&#39;, &#39;04&#39;, &#39;05&#39;, &#39;06&#39;, &#39;07&#39;, &#39;08&#39;, &#39;09&#39;]</span>
<span class="sd">        and the colummn of key dpts_list&#39; contains</span>
<span class="sd">        [&#39;DTCH&#39;, &#39;DTCH&#39;, &#39;DTCH&#39;, &#39;DTNM&#39;, &#39;DTNM&#39;, &#39;DTNM&#39;, &#39;DTNM&#39;, &#39;DTNM&#39;, &#39;DTNM&#39;],</span>
<span class="sd">        then the employee was part of &#39;DTCH&#39; from January to March and was part</span>
<span class="sd">        of &#39;DTNM&#39; from April to September.</span>
<span class="sd">    The function uses the columns defined by the global `EMPLOYEES_USEFUL_COLS`</span>
<span class="sd">    at keys &#39;dpt&#39; and &#39;serv&#39; that contain, for each employee,</span>
<span class="sd">    a list of at most 12 tuples:</span>
<span class="sd">        [(mm_1, yyyy_1, dep_1),(mm_2, yyyy_2, dep_2), ..., (mm_n, yyyy_n, dep_n)]</span>
<span class="sd">    witch are re-casted in 3 lists [mm_1, mm_2, ..., mm_n],</span>
<span class="sd">        [yyyy_1, yyyy_2, ..., yyyy_n], [dep_1, dep_2, ..., dep_n].</span>

<span class="sd">    Args:</span>
<span class="sd">        df (dataframe): The dataframe to which the 4 columns are added.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dataframe): The updated dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">col_eff_dpt_alias</span>     <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;dpt&#39;</span><span class="p">]</span>
    <span class="n">col_eff_service_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;serv&#39;</span><span class="p">]</span>
    <span class="n">col_add_dpts_alias</span>    <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="p">[</span><span class="s1">&#39;dpts_list&#39;</span><span class="p">]</span>
    <span class="n">col_add_servs_alias</span>   <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="p">[</span><span class="s1">&#39;servs_list&#39;</span><span class="p">]</span>
    <span class="n">col_add_month_alias</span>   <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="p">[</span><span class="s1">&#39;months_list&#39;</span><span class="p">]</span>
    <span class="n">col_add_year_alias</span>    <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="p">[</span><span class="s1">&#39;years_list&#39;</span><span class="p">]</span>

    <span class="c1"># Converting the list of tuples[(mm_1, yyyy_1, item_1), ...(mm_n, yyyy_n, item_n)]</span>
    <span class="c1"># into a list of 3 lists [[mm_1,...,mm_n], [yyyy_1,....yyyy_n],[item_1,....,item_n]]</span>
    <span class="c1"># where &#39;item&#39; stands for department.</span>
    <span class="c1"># The 2 lists of 3 lists are put into the two new columns</span>
    <span class="c1"># named &#39;col_add_dpts_alias&#39; and &#39;col_add_servs_alias&#39;</span>
    <span class="n">cols_tup_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">col_eff_dpt_alias</span><span class="p">,</span> <span class="n">col_add_dpts_alias</span><span class="p">),</span>
                     <span class="p">(</span><span class="n">col_eff_service_alias</span><span class="p">,</span> <span class="n">col_add_servs_alias</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">cols_tup</span> <span class="ow">in</span> <span class="n">cols_tup_list</span><span class="p">:</span>
        <span class="n">col_in</span><span class="p">,</span> <span class="n">col_out</span> <span class="o">=</span>  <span class="n">cols_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cols_tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col_out</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_in</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))])</span>

    <span class="c1"># Exploding the 2 lists of 3 lists into the columns</span>
    <span class="c1"># named &#39;months&#39;, &#39;years&#39;, &#39;Dpts&#39; and &#39;Servs&#39;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">col_add_dpts_alias</span><span class="p">,</span> <span class="n">col_add_servs_alias</span><span class="p">]:</span>
        <span class="n">new_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_add_month_alias</span><span class="p">,</span><span class="n">col_add_year_alias</span><span class="p">,</span><span class="n">col</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">_add_column_firstname_initial</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_add_column_firstname_initial` adds a new column defined by</span>
<span class="sd">    the global &#39;EMPLOYEES_ADD_COLS&#39; at the key &#39;first_name_initials&#39; containing</span>
<span class="sd">    the initials of the firstname.</span>
<span class="sd">        ex: PIERRE --&gt;P, JEAN-PIERRE --&gt; JP , JEAN-PIERRE MARIE --&gt; JPM.</span>
<span class="sd">    It uses the columns defined by the global `EMPLOYEES_USEFUL_COLS` at key &#39;first_name&#39;</span>
<span class="sd">    that contains the full first name for each employee.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (dataframe): The dataframe to which the column is added.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dataframe): The updated dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Internal functions</span>
    <span class="k">def</span> <span class="nf">_get_firstname_initials</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">row</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">row_list</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">initial_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row_list</span><span class="p">]</span>
        <span class="n">initials</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">initial_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">initials</span>

    <span class="n">col_in</span>  <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]</span>
    <span class="n">col_out</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="p">[</span><span class="s1">&#39;first_name_initials&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col_out</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_in</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_get_firstname_initials</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">_add_column_full_name</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_add_column_full_name` adds a new column defined by</span>
<span class="sd">    the global &#39;EMPLOYEES_ADD_COLS&#39; at the key &#39;employee_full_name&#39; containing</span>
<span class="sd">    the employee full name composed by the last name and the first name initials.</span>
<span class="sd">        ex: if last name is SIMONATO and first name initials are JP --&gt; full name is SIMONATO JP.</span>
<span class="sd">    It uses the columns defined by the global `EMPLOYEES_USEFUL_COLS` at key &#39;name&#39;</span>
<span class="sd">    that contains the last name for each employee and it uses the previously added column</span>
<span class="sd">    defined by the global `EMPLOYEES_ADD_COLS` at key &#39;first_name_initials&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (dataframe): The dataframe to which the column is added.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dataframe): The updated dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">col_last_name_alias</span>          <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">col_first_name_initial_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="p">[</span><span class="s1">&#39;first_name_initials&#39;</span><span class="p">]</span>
    <span class="n">col_full_name_alias</span>          <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="p">[</span><span class="s1">&#39;employee_full_name&#39;</span><span class="p">]</span>

    <span class="n">df</span><span class="p">[</span><span class="n">col_full_name_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_last_name_alias</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">col_first_name_initial_alias</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">_select_employee_dpt_and_serv</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_select_employee_dpt_and_serv` select the department</span>
<span class="sd">    and the service of an employee among the list of departments</span>
<span class="sd">    and services of affiliation during the year.</span>
<span class="sd">    The rule is to choose the department and the service corresponding</span>
<span class="sd">    to the first available month of the year.</span>
<span class="sd">        ex: The column defined by the global  &#39;EMPLOYEES_USEFUL_COLS&#39;</span>
<span class="sd">        at key &#39;dpt&#39; contains the list of tuples (mm, yyyy, dpt) such as</span>
<span class="sd">        x = [(&#39;04&#39;, &#39;2019&#39;, &#39;DTBH&#39;), (&#39;05&#39;, &#39;2019&#39;, &#39;DTBH&#39;),</span>
<span class="sd">        (&#39;06&#39;, &#39;2019&#39;, &#39;DTNM&#39;), ..., (&#39;12&#39;, &#39;2019&#39;, &#39;DTNM&#39;)].</span>
<span class="sd">        We select DTBH = x[0][-1] as the first occurrence.</span>
<span class="sd">        The last occurrence would be DTNM = x[-1][-1].</span>

<span class="sd">    Args:</span>
<span class="sd">        df (dataframe): The dataframe to be modified.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dataframe): The updated dataframe.</span>

<span class="sd">    Note:</span>
<span class="sd">        A more fair full allocation would be department/service where the employee</span>
<span class="sd">        spent the maximum time during the year</span>
<span class="sd">        using: lambda x: max((count := Counter([y[2] for y in x])), key = count.get)</span>
<span class="sd">        where &#39;Counter&#39; is a method of &#39;collections&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">col_dpt_alias</span>  <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;dpt&#39;</span><span class="p">]</span>
    <span class="n">col_serv_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;serv&#39;</span><span class="p">]</span>

    <span class="n">cols_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_dpt_alias</span><span class="p">,</span> <span class="n">col_serv_alias</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_list</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">_build_year_month_dpt</span><span class="p">(</span><span class="n">year_months_file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_build_year_month_dpt` builds a dataframe</span>
<span class="sd">    for a year by merging all employees information available</span>
<span class="sd">    by month in an Excel workbook, which full path is defined</span>
<span class="sd">    by the variable &#39;year_months_file_path&#39;.</span>
<span class="sd">    This workbook contains a worksheet per month.</span>
<span class="sd">    These worksheets are labelled mmyyyy where mm stands for the month</span>
<span class="sd">    (01, 02, ..., 12) and yyyy stands for the year (2019, 2020, ...).</span>
<span class="sd">    All the worksheets must at least contain the columns which names</span>
<span class="sd">    are defined by the keys &#39;matricule&#39;, &#39;first_name&#39;, &#39;name&#39;, &#39;dpt&#39;</span>
<span class="sd">    and &#39;serv&#39; in the global &#39;EMPLOYEES_USEFUL_COLS&#39;.</span>
<span class="sd">    The function merges the list of sheets and builds the new columns</span>
<span class="sd">    defined by the global &#39;EMPLOYEES_ADD_COLS&#39; using the local functions</span>
<span class="sd">    &#39;_add_column_keep_history&#39;, &#39;_add_column_firstname_initial&#39; and &#39;_add_column_full_name&#39;</span>
<span class="sd">    of the module &#39;update_employees&#39; of the package &#39;bmfuncts&#39;.</span>
<span class="sd">    The columns added at keys &#39;months_list&#39;, &#39;years_list&#39;, &#39;dpts_list&#39; and &#39;servs_list&#39;</span>
<span class="sd">    contains lists formated as : [item_1, item_2, ... items_n] of the n items</span>
<span class="sd">    of the n available months and where item_i stands for month, year, department</span>
<span class="sd">    and service respectively.</span>
<span class="sd">    Finally, a single department and service is selected for each employee using</span>
<span class="sd">    the local function &#39;_select_employee_dpt_and_serv&#39; of the module &#39;update_employees&#39;</span>
<span class="sd">    of the package &#39;bmfuncts&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">       year_months_file_path (path): The path to the Excel file</span>
<span class="sd">                                     that contains a sheet per month of a year.</span>

<span class="sd">    Returns:</span>
<span class="sd">       (dataframe): The built employees dataframe.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The globals EMPLOYEES_ADD_COLS and EMPLOYEES_USEFUL_COLS are imported</span>
<span class="sd">        from the module &#39;employees_globals&#39; of the package &#39;bmfuncts&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Internal functions</span>
    <span class="k">def</span> <span class="nf">_set_tup</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="c1"># Setting lists of columns</span>
    <span class="n">useful_col_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">add_col_list</span>    <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Setting useful aliases from globals</span>
    <span class="n">dpt_col_alias</span>       <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;dpt&#39;</span><span class="p">]</span>
    <span class="n">firstname_col_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]</span>
    <span class="n">name_col_alias</span>      <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">matricule_col_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;matricule&#39;</span><span class="p">]</span>
    <span class="n">serv_col_alias</span>      <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;serv&#39;</span><span class="p">]</span>

    <span class="c1"># Reading the sheets from the excel file as a dict</span>
    <span class="c1"># {sheet-name: sheet-content dataframe}</span>
    <span class="n">df_dict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">year_months_file_path</span><span class="p">,</span>
                            <span class="n">sheet_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">usecols</span> <span class="o">=</span> <span class="n">useful_col_list</span><span class="p">)</span>

    <span class="c1"># Concatenating the sheets from the &#39;sheet_names&#39;</span>
    <span class="c1"># list into the dataframe &#39;df_eff_year&#39;</span>
    <span class="n">list_df_eff_month</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sheet_name</span><span class="p">,</span><span class="n">df_eff_month</span> <span class="ow">in</span> <span class="n">df_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">sheet_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Extraction of the month mm for the sheet name mmyyyy</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">sheet_name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>    <span class="c1"># Extraction of year yyyy for the sheet name mmyyyy</span>

        <span class="c1"># For the sheet &#39;sheet_name&#39; of the dataframe &#39;df_eff_month&#39;</span>
        <span class="c1"># replacing each cell of column &#39;dpt_col_alias&#39;/&#39;serv_col_alias&#39; that specifies</span>
        <span class="c1"># the employee department dpt/service by a tuple (month,year,dpt)/(month,year,serv)</span>
        <span class="k">for</span> <span class="n">col_keep_history</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dpt_col_alias</span><span class="p">,</span> <span class="n">serv_col_alias</span><span class="p">]:</span>
            <span class="n">df_eff_month</span><span class="p">[</span><span class="n">col_keep_history</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_eff_month</span><span class="p">[</span><span class="n">col_keep_history</span><span class="p">]</span><span class="o">.</span>\
                                             <span class="n">apply</span><span class="p">(</span><span class="n">_set_tup</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">))</span>

        <span class="n">list_df_eff_month</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_eff_month</span><span class="p">)</span>

    <span class="n">df_eff_year</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">list_df_eff_month</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Aggregating all the information related to one matriculate</span>
    <span class="c1"># as a list without duplicates, for each column (except &#39;Matricule&#39;)</span>
    <span class="n">df_eff_year_singlemat</span> <span class="o">=</span> <span class="n">df_eff_year</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">matricule_col_alias</span><span class="p">)</span><span class="o">.</span>\
                                                <span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span><span class="o">.</span>\
                                                <span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># Recasting lists into string if its length is equal to 1</span>
    <span class="n">col_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">matricule_col_alias</span><span class="p">,</span>
               <span class="n">name_col_alias</span><span class="p">,</span>
               <span class="n">serv_col_alias</span><span class="p">,</span>
               <span class="n">dpt_col_alias</span><span class="p">,</span>
               <span class="n">firstname_col_alias</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">useful_col_list</span><span class="p">)</span> <span class="o">-</span> <span class="n">col_set</span><span class="p">:</span>
        <span class="n">df_eff_year_singlemat</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_eff_year_singlemat</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span>\
                                     <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c1"># Dealing with same matriculate for different lastnames and firstnames</span>
    <span class="n">employees_df</span> <span class="o">=</span> <span class="n">df_eff_year_singlemat</span><span class="o">.</span><span class="n">explode</span><span class="p">([</span><span class="n">name_col_alias</span><span class="p">])</span>
    <span class="n">employees_df</span> <span class="o">=</span> <span class="n">employees_df</span><span class="o">.</span><span class="n">explode</span><span class="p">([</span><span class="n">firstname_col_alias</span><span class="p">])</span>

    <span class="c1"># Adding 6 new columns</span>
    <span class="n">employees_df</span> <span class="o">=</span> <span class="n">_add_column_keep_history</span><span class="p">(</span><span class="n">employees_df</span><span class="p">)</span>
    <span class="n">employees_df</span> <span class="o">=</span> <span class="n">_add_column_firstname_initial</span><span class="p">(</span><span class="n">employees_df</span><span class="p">)</span>
    <span class="n">employees_df</span> <span class="o">=</span> <span class="n">_add_column_full_name</span><span class="p">(</span><span class="n">employees_df</span><span class="p">)</span>
    <span class="n">employees_df</span> <span class="o">=</span> <span class="n">_select_employee_dpt_and_serv</span><span class="p">(</span><span class="n">employees_df</span><span class="p">)</span>

    <span class="n">employees_df</span> <span class="o">=</span> <span class="n">employees_df</span><span class="p">[</span><span class="n">useful_col_list</span> <span class="o">+</span> <span class="n">add_col_list</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">employees_df</span>


<div class="viewcode-block" id="update_employees">
<a class="viewcode-back" href="../../functions.html#bmfuncts.update_employees.update_employees">[docs]</a>
<span class="k">def</span> <span class="nf">update_employees</span><span class="p">(</span><span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `update_employees` update the file defined by the global</span>
<span class="sd">    &#39;EMPLOYEES_ARCHI&#39; at key &#39;employees_file_name&#39; using the file defined</span>
<span class="sd">    by the global &#39;EMPLOYEES_ARCHI&#39; at key &quot;one_year_employees_filebase&quot;</span>
<span class="sd">    and the year &#39;year&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        bibliometer_path (path): The path to the working folder.</span>
<span class="sd">        progress_callback (function): Function for updating ProgressBar </span>
<span class="sd">                                      tkinter widget status (default = None).</span>
<span class="sd">        replace (bool): Optional (default = True); if true, existing sheets</span>
<span class="sd">                        are replaced in employees EXCEL files specific to a year.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple): Tuple of 5 strings; a first string giving the employees year</span>
<span class="sd">                 if no error is raised; then 4 strings specifying errors related</span>
<span class="sd">                 respectively to files number, sheet-name, column name and number</span>
<span class="sd">                 of years to update; these 4 strings are set to &quot;None&quot; when no error is raised.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting useful file name aliases</span>
    <span class="n">one_year_employees_basename_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ARCHI</span><span class="p">[</span><span class="s2">&quot;one_year_employees_filebase&quot;</span><span class="p">]</span>
    <span class="n">all_years_employees_file_alias</span>    <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ARCHI</span><span class="p">[</span><span class="s2">&quot;employees_file_name&quot;</span><span class="p">]</span>

    <span class="c1"># Getting useful employees paths</span>
    <span class="p">(</span><span class="n">months2add_employees_folder_path</span><span class="p">,</span>
     <span class="n">all_years_employees_folder_path</span><span class="p">,</span>
     <span class="n">one_year_employees_folder_path</span><span class="p">,</span>
     <span class="n">backup_folder_path</span><span class="p">)</span> <span class="o">=</span> <span class="n">_set_employees_paths</span><span class="p">(</span><span class="n">bibliometer_path</span><span class="p">)</span>

    <span class="c1"># Setting full paths to useful files</span>
    <span class="n">all_years_file_path</span>        <span class="o">=</span> <span class="n">all_years_employees_folder_path</span> <span class="o">/</span> \
                                 <span class="n">Path</span><span class="p">(</span><span class="n">all_years_employees_file_alias</span><span class="p">)</span>
    <span class="n">all_years_file_backup_path</span> <span class="o">=</span> <span class="n">backup_folder_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">all_years_employees_file_alias</span><span class="p">)</span>

    <span class="c1"># Setting the list of files available to add (expected only one)</span>
    <span class="n">months2add_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">months2add_employees_folder_path</span><span class="p">)</span>
                             <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.xlsx&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;~&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">months2add_files</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">files_number_error</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Too many files present in  &#39;</span><span class="si">{</span><span class="n">months2add_employees_folder_path</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                              <span class="s2">&quot;while expecting only one&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">files_number_error</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">months2add_files</span><span class="p">:</span>
        <span class="n">files_number_error</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No file present in &#39;</span><span class="si">{</span><span class="n">months2add_employees_folder_path</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
                              <span class="s2">&quot;no update possible&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">files_number_error</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">months2add_file_path</span> <span class="o">=</span> <span class="n">months2add_employees_folder_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">months2add_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="p">(</span><span class="n">employees_year</span><span class="p">,</span>
     <span class="n">year_months_file_path</span><span class="p">,</span>
     <span class="n">sheet_name_error</span><span class="p">,</span>
     <span class="n">column_error</span><span class="p">,</span>
     <span class="n">years2add_error</span><span class="p">)</span> <span class="o">=</span> <span class="n">_update_months_history</span><span class="p">(</span><span class="n">months2add_file_path</span><span class="p">,</span>
                                               <span class="n">one_year_employees_folder_path</span><span class="p">,</span>
                                               <span class="n">one_year_employees_basename_alias</span><span class="p">,</span>
                                               <span class="n">replace</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">employees_year</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">year_months_file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sheet_name_error</span><span class="p">,</span> <span class="n">column_error</span><span class="p">,</span> <span class="n">years2add_error</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Building the dataframe employees_df by concatenating</span>
    <span class="c1"># the months of the current year</span>
    <span class="n">employees_df</span> <span class="o">=</span> <span class="n">_build_year_month_dpt</span><span class="p">(</span><span class="n">year_months_file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>

    <span class="c1"># Saving employees_df as a sheet mame after employees_year,</span>
    <span class="c1"># in the workbook pointed by all_years_file_path</span>
    <span class="n">all_years_file_status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">all_years_file_path</span><span class="p">)</span>
    <span class="n">all_years_file_backup_status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">all_years_file_backup_path</span><span class="p">)</span>
    <span class="n">all_years_file_error</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">all_years_file_status</span><span class="p">:</span>
        <span class="n">_add_sheets_to_workbook</span><span class="p">(</span><span class="n">all_years_file_path</span><span class="p">,</span> <span class="n">employees_df</span><span class="p">,</span> <span class="n">employees_year</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">all_years_file_backup_status</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">all_years_file_backup_path</span><span class="p">,</span> <span class="n">all_years_file_path</span><span class="p">)</span>
        <span class="n">_add_sheets_to_workbook</span><span class="p">(</span><span class="n">all_years_file_path</span><span class="p">,</span> <span class="n">employees_df</span><span class="p">,</span> <span class="n">employees_year</span><span class="p">)</span>
        <span class="n">all_years_file_error</span>  <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The file:&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">all_years_file_path</span><span class="si">}</span><span class="s2">&#39; </span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">has been copied from the backup file:&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">all_years_file_backup_path</span><span class="si">}</span><span class="s2">&#39; </span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">and then updated.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">employees_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">all_years_file_path</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">employees_year</span><span class="p">)</span>
        <span class="n">all_years_file_error</span>  <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The file &#39;</span><span class="si">{</span><span class="n">all_years_file_path</span><span class="si">}</span><span class="s2">&#39; has been &quot;</span>
        <span class="n">all_years_file_error</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;created with a sheet named &#39;</span><span class="si">{</span><span class="n">employees_year</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

    <span class="c1"># Copying the all-years employees file updated to the backup folder</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">all_years_file_path</span><span class="p">,</span> <span class="n">backup_folder_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">employees_year</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">all_years_file_error</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, BiblioMeter team, Liten, Leti, CEA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>