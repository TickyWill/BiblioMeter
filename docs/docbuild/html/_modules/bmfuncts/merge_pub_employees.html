

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bmfuncts.merge_pub_employees &mdash; BiblioMeter 5.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=ce74c6a2"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BiblioMeter
              <img src="../../_static/BM-logo.ico" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Description</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../description.html">BiblioMeter description</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GUI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gui.html">BiblioMeter <cite>bmgui</cite> package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../functions.html">BiblioMeter <cite>bmfuncts</cite> package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BiblioMeter</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bmfuncts.merge_pub_employees</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bmfuncts.merge_pub_employees</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module of functions for the merge of employees information with the publications list </span>
<span class="sd">of the Institute taking care of:</span>
<span class="sd">- Potential discrepancy between author-name spelling and employee-name spelling;</span>
<span class="sd">- Complementary database to the Institute employees database </span>
<span class="sd">with young researchers affiliated to the Institute;</span>
<span class="sd">- Inappropriate affiliation to the Institute of external collaborators;</span>
<span class="sd">- Creation of list of Institute authors with selected attributes;</span>
<span class="sd">- Creation of full reference for each publication.&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;recursive_year_search&#39;</span><span class="p">]</span>

<span class="c1"># Standard Library imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># 3rd party imports</span>
<span class="kn">import</span> <span class="nn">BiblioParsing</span> <span class="k">as</span> <span class="nn">bp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Local imports</span>
<span class="kn">import</span> <span class="nn">bmfuncts.employees_globals</span> <span class="k">as</span> <span class="nn">eg</span>
<span class="kn">import</span> <span class="nn">bmfuncts.pub_globals</span> <span class="k">as</span> <span class="nn">pg</span>
<span class="kn">from</span> <span class="nn">bmfuncts.config_utils</span> <span class="kn">import</span> <span class="n">set_user_config</span>
<span class="kn">from</span> <span class="nn">bmfuncts.useful_functs</span> <span class="kn">import</span> <span class="n">read_parsing_dict</span>
<span class="kn">from</span> <span class="nn">bmfuncts.rename_cols</span> <span class="kn">import</span> <span class="n">build_col_conversion_dic</span>


<span class="k">def</span> <span class="nf">_check_names_spelling</span><span class="p">(</span><span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">init_df</span><span class="p">,</span> <span class="n">cols_tup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replace author names in &#39;init_df&#39; dataframe by the employee name </span>
<span class="sd">    when a name-spelling discrepency is given in the dedicated Excel file </span>
<span class="sd">    named &#39;orthograph_file_name&#39; and located in the &#39;orphan_treat_root&#39; </span>
<span class="sd">    folder of the working folder.</span>

<span class="sd">    Args:</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        init_df (dataframe): Publications list with one row per author </span>
<span class="sd">                             where author names should be corrected.</span>
<span class="sd">        cols_tup (tup): Tuple of useful column names in &#39;init_df&#39; dataframe</span>
<span class="sd">                        = (full name, last name, first name).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dataframe): Publications list with one row per author where </span>
<span class="sd">                     spelling of author names have been corrected.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting parameters from args</span>
    <span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">cols_tup</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">orphan_treat_root</span>    <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_ORPHAN</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span>
    <span class="n">orthograph_file_name</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_ORPHAN</span><span class="p">[</span><span class="s2">&quot;orthograph file&quot;</span><span class="p">]</span>
    <span class="n">ortho_lastname_init</span>  <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_ORTHO</span><span class="p">[</span><span class="s1">&#39;last name init&#39;</span><span class="p">]</span>
    <span class="n">ortho_initials_init</span>  <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_ORTHO</span><span class="p">[</span><span class="s1">&#39;initials init&#39;</span><span class="p">]</span>
    <span class="n">ortho_lastname_new</span>   <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_ORTHO</span><span class="p">[</span><span class="s1">&#39;last name new&#39;</span><span class="p">]</span>
    <span class="n">ortho_initials_new</span>   <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_ORTHO</span><span class="p">[</span><span class="s1">&#39;initials new&#39;</span><span class="p">]</span>

    <span class="c1"># Setting useful path</span>
    <span class="n">ortho_path</span> <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">orphan_treat_root</span><span class="p">)</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">orthograph_file_name</span><span class="p">)</span>

    <span class="c1"># Reading data file targeted by &#39;ortho_path&#39;</span>
    <span class="n">ortho_col_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_ORTHO</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="ne">UserWarning</span><span class="p">)</span>
    <span class="n">ortho_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ortho_path</span><span class="p">,</span> <span class="n">usecols</span> <span class="o">=</span> <span class="n">ortho_col_list</span><span class="p">)</span>

    <span class="n">new_df</span> <span class="o">=</span> <span class="n">init_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pub_row_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">init_df</span><span class="p">)):</span>
        <span class="n">lastname_init</span> <span class="o">=</span> <span class="n">init_df</span><span class="p">[</span><span class="n">col1</span><span class="p">][</span><span class="n">pub_row_num</span><span class="p">]</span>
        <span class="n">initials_init</span> <span class="o">=</span> <span class="n">init_df</span><span class="p">[</span><span class="n">col2</span><span class="p">][</span><span class="n">pub_row_num</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ortho_row_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ortho_df</span><span class="p">)):</span>
            <span class="n">lastname_pub_ortho</span> <span class="o">=</span> <span class="n">ortho_df</span><span class="p">[</span><span class="n">ortho_lastname_init</span> <span class="p">][</span><span class="n">ortho_row_num</span><span class="p">]</span>
            <span class="n">initials_pub_ortho</span> <span class="o">=</span> <span class="n">ortho_df</span><span class="p">[</span><span class="n">ortho_initials_init</span><span class="p">][</span><span class="n">ortho_row_num</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">lastname_init</span> <span class="o">==</span> <span class="n">lastname_pub_ortho</span> <span class="ow">and</span> <span class="n">initials_init</span> <span class="o">==</span> <span class="n">initials_pub_ortho</span><span class="p">:</span>
                <span class="n">lastname_eff_ortho</span> <span class="o">=</span> <span class="n">ortho_df</span><span class="p">[</span><span class="n">ortho_lastname_new</span><span class="p">][</span><span class="n">ortho_row_num</span><span class="p">]</span>
                <span class="n">initials_eff_ortho</span> <span class="o">=</span> <span class="n">ortho_df</span><span class="p">[</span><span class="n">ortho_initials_new</span><span class="p">][</span><span class="n">ortho_row_num</span><span class="p">]</span>
                <span class="n">new_df</span> <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pub_row_num</span><span class="p">,</span><span class="n">col1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastname_eff_ortho</span>
                <span class="n">new_df</span> <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pub_row_num</span><span class="p">,</span><span class="n">col2</span><span class="p">]</span> <span class="o">=</span> <span class="n">initials_eff_ortho</span>
                <span class="n">new_df</span> <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pub_row_num</span><span class="p">,</span><span class="n">col0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastname_eff_ortho</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">initials_eff_ortho</span>

    <span class="k">return</span> <span class="n">new_df</span>


<span class="k">def</span> <span class="nf">_check_names_to_replace</span><span class="p">(</span><span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">init_df</span><span class="p">,</span> <span class="n">cols_tup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replace author names in &#39;init_df&#39; dataframe by the correct author name </span>
<span class="sd">    when metadata error is reported in the dedicated Excel file named </span>
<span class="sd">    &#39;complements_file_name&#39; at sheet &#39;compl_to_replace_sheet&#39; and located </span>
<span class="sd">    in the &#39;orphan_treat_root&#39; folder of the working folder.</span>

<span class="sd">    Args:</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        year (str): Corpus year of publications list.</span>
<span class="sd">        init_df (dataframe): Publications list with one row per author </span>
<span class="sd">                             where author names should be corrected.</span>
<span class="sd">        cols_tup (tup): Tuple of useful column names in &#39;init_df&#39; dataframe</span>
<span class="sd">                        = (full name, last name, first name).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dataframe): Publications list with one row per author where </span>
<span class="sd">                     author names have been corrected.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting parameters from args</span>
    <span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">cols_tup</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">orphan_treat_root</span>      <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_ORPHAN</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span>
    <span class="n">complements_file_name</span>  <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_ORPHAN</span><span class="p">[</span><span class="s2">&quot;complementary file&quot;</span><span class="p">]</span>
    <span class="n">compl_to_replace_sheet</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">SHEET_NAMES_ORPHAN</span><span class="p">[</span><span class="s1">&#39;to replace&#39;</span><span class="p">]</span>
    <span class="n">compl_lastname_init</span>    <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_COMPL</span><span class="p">[</span><span class="s1">&#39;last name init&#39;</span><span class="p">]</span>
    <span class="n">compl_initials_init</span>    <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_COMPL</span><span class="p">[</span><span class="s1">&#39;initials init&#39;</span><span class="p">]</span>
    <span class="n">compl_lastname_new</span>     <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_COMPL</span><span class="p">[</span><span class="s1">&#39;last name new&#39;</span><span class="p">]</span>
    <span class="n">compl_initials_new</span>     <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_COMPL</span><span class="p">[</span><span class="s1">&#39;initials new&#39;</span><span class="p">]</span>
    <span class="n">compl_year_pub</span>         <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_COMPL</span><span class="p">[</span><span class="s1">&#39;publication year&#39;</span><span class="p">]</span>

    <span class="c1"># Setting useful path</span>
    <span class="n">complements_path</span> <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">orphan_treat_root</span><span class="p">)</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">complements_file_name</span><span class="p">)</span>

    <span class="c1"># Getting the information of the year in the complementary file</span>
    <span class="n">compl_col_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_COMPL</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="ne">UserWarning</span><span class="p">)</span>
    <span class="n">compl_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">complements_path</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">compl_to_replace_sheet</span><span class="p">,</span>
                             <span class="n">usecols</span> <span class="o">=</span> <span class="n">compl_col_list</span><span class="p">)</span>
    <span class="n">year_compl_df</span> <span class="o">=</span> <span class="n">compl_df</span><span class="p">[</span><span class="n">compl_df</span><span class="p">[</span><span class="n">compl_year_pub</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)]</span>
    <span class="n">year_compl_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">new_df</span> <span class="o">=</span> <span class="n">init_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pub_row_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">init_df</span><span class="p">)):</span>
        <span class="n">lastname_init</span> <span class="o">=</span> <span class="n">init_df</span><span class="p">[</span><span class="n">col1</span><span class="p">][</span><span class="n">pub_row_num</span><span class="p">]</span>
        <span class="n">initials_init</span> <span class="o">=</span> <span class="n">init_df</span><span class="p">[</span><span class="n">col2</span><span class="p">][</span><span class="n">pub_row_num</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">compl_row_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">year_compl_df</span><span class="p">)):</span>
            <span class="n">lastname_pub_compl</span> <span class="o">=</span> <span class="n">year_compl_df</span><span class="p">[</span><span class="n">compl_lastname_init</span><span class="p">][</span><span class="n">compl_row_num</span><span class="p">]</span>
            <span class="n">initials_pub_compl</span> <span class="o">=</span> <span class="n">year_compl_df</span><span class="p">[</span><span class="n">compl_initials_init</span><span class="p">][</span><span class="n">compl_row_num</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lastname_init</span> <span class="o">==</span> <span class="n">lastname_pub_compl</span> <span class="ow">and</span> <span class="n">initials_init</span> <span class="o">==</span> <span class="n">initials_pub_compl</span><span class="p">:</span>

                <span class="n">lastname_eff_compl</span> <span class="o">=</span> <span class="n">year_compl_df</span><span class="p">[</span><span class="n">compl_lastname_new</span><span class="p">][</span><span class="n">compl_row_num</span><span class="p">]</span>
                <span class="n">initials_eff_compl</span> <span class="o">=</span> <span class="n">year_compl_df</span><span class="p">[</span><span class="n">compl_initials_new</span><span class="p">][</span><span class="n">compl_row_num</span><span class="p">]</span>
                <span class="n">new_df</span> <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pub_row_num</span><span class="p">,</span><span class="n">col1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastname_eff_compl</span>
                <span class="n">new_df</span> <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pub_row_num</span><span class="p">,</span><span class="n">col2</span><span class="p">]</span> <span class="o">=</span> <span class="n">initials_eff_compl</span>
                <span class="n">new_df</span> <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pub_row_num</span><span class="p">,</span><span class="n">col0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastname_eff_compl</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">initials_eff_compl</span>

    <span class="k">return</span> <span class="n">new_df</span>


<span class="k">def</span> <span class="nf">_check_authors_to_remove</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">pub_df</span><span class="p">,</span> <span class="n">cols_tup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Drops rows of authors to be removed in the &#39;pub-df&#39; dataframe. </span>
<span class="sd">    The authors to remove are reported in the dedicated Excel </span>
<span class="sd">    file named &#39;outliers_file_name&#39; at sheet &#39;outliers_sheet&#39;  </span>
<span class="sd">    and located in the &#39;orphan_treat_root&#39; folder of the working folder.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        pub_df (dataframe): Publications list with one row per author  </span>
<span class="sd">                            where rows should be dropped.</span>
<span class="sd">        cols_tup (tup): Tuple of useful column names in &#39;pub_df&#39; dataframe</span>
<span class="sd">                        = (last name, first name).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dataframe): Publications list with one row per author where </span>
<span class="sd">                     rows of authors to be removed have been dropped.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting parameters from args</span>
    <span class="n">pub_last_col</span><span class="p">,</span> <span class="n">pub_initials_col</span> <span class="o">=</span> <span class="n">cols_tup</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">orphan_treat_root</span>     <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_ORPHAN</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span>
    <span class="n">outliers_file_name</span>    <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_ORPHAN</span><span class="p">[</span><span class="s2">&quot;complementary file&quot;</span><span class="p">]</span>
    <span class="n">outliers_sheet</span>        <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">SHEET_NAMES_ORPHAN</span><span class="p">[</span><span class="s2">&quot;to remove&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">institute</span>
    <span class="n">outliers_lastname_col</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_EXT</span><span class="p">[</span><span class="s1">&#39;last name&#39;</span><span class="p">]</span>
    <span class="n">outliers_initials_col</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_EXT</span><span class="p">[</span><span class="s1">&#39;initials&#39;</span><span class="p">]</span>

    <span class="c1"># Setting useful path</span>
    <span class="n">outliers_path</span> <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">orphan_treat_root</span><span class="p">)</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">outliers_file_name</span><span class="p">)</span>

    <span class="c1"># Reading the file giving the outliers</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="ne">UserWarning</span><span class="p">)</span>
    <span class="n">outliers_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">outliers_path</span><span class="p">,</span>
                                <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">outliers_sheet</span><span class="p">,</span>
                                <span class="n">usecols</span> <span class="o">=</span> <span class="p">[</span><span class="n">outliers_lastname_col</span><span class="p">,</span>
                                           <span class="n">outliers_initials_col</span><span class="p">])</span>
    <span class="c1"># Initializing the dataframe that will contain the rows to drop</span>
    <span class="c1"># with the same columns names as the dataframe to update</span>
    <span class="n">drop_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pub_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="c1"># Searching for the outliers in the dataframe to update by lastname and initials</span>
    <span class="k">for</span> <span class="n">pub_row_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pub_df</span><span class="p">)):</span>
        <span class="n">pub_lastname</span>  <span class="o">=</span> <span class="n">pub_df</span><span class="p">[</span><span class="n">pub_last_col</span><span class="p">][</span><span class="n">pub_row_num</span><span class="p">]</span>
        <span class="n">pub_initials</span> <span class="o">=</span> <span class="n">pub_df</span><span class="p">[</span><span class="n">pub_initials_col</span><span class="p">][</span><span class="n">pub_row_num</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">outliers_row_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outliers_df</span><span class="p">)):</span>
            <span class="n">outliers_lastname</span> <span class="o">=</span> <span class="n">outliers_df</span><span class="p">[</span><span class="n">outliers_lastname_col</span><span class="p">][</span><span class="n">outliers_row_num</span><span class="p">]</span>
            <span class="n">outliers_initials</span> <span class="o">=</span> <span class="n">outliers_df</span><span class="p">[</span><span class="n">outliers_initials_col</span><span class="p">][</span><span class="n">outliers_row_num</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pub_lastname</span> <span class="o">==</span> <span class="n">outliers_lastname</span> <span class="ow">and</span> <span class="n">pub_initials</span> <span class="o">==</span> <span class="n">outliers_initials</span><span class="p">:</span>
                <span class="c1"># Setting the row to drop as a dataframe</span>
                <span class="n">row_to_drop_df</span> <span class="o">=</span> <span class="n">pub_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pub_row_num</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
                <span class="c1"># Appending the row to drop to the dataframe that will contain all the rows to drop</span>
                <span class="n">drop_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">drop_df</span><span class="p">,</span> <span class="n">row_to_drop_df</span><span class="p">],</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Removing the rows to drop from the dataframe to update</span>
    <span class="n">new_pub_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pub_df</span><span class="p">,</span> <span class="n">drop_df</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_pub_df</span>


<span class="k">def</span> <span class="nf">_build_institute_pubs_authors</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Builds the publications list dataframe with one row per Institute author </span>
<span class="sd">    for each publication from the results of the corpus parsing.</span>
<span class="sd">    First, the parsing results are got through the `read_parsing_dict` function </span>
<span class="sd">    imported from `bmfuncts.useful_functs` module.</span>
<span class="sd">    After that, a publications list dataframe with one row per author affiliated </span>
<span class="sd">    to the Institute is built using the &#39;filt_authors_inst_&#39; filter.</span>
<span class="sd">    Then, the dataframe is complemented with useful new columns </span>
<span class="sd">    of full name, last name and first name of authors.</span>
<span class="sd">    Finally, the dataframe is cleaned as follows:</span>
<span class="sd">    - Author-name spelling is corrected through the `_check_names_spelling` </span>
<span class="sd">    internal function;</span>
<span class="sd">    - Errors on author names resulting from publication metadata errors </span>
<span class="sd">    are corrected through the `_check_names_to_replace` internal function.</span>
<span class="sd">    - The row of authors mistakenly affiliated to the Institute are dropped </span>
<span class="sd">    through the `_check_authors_to_remove` internal function.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        year (str): Contains the corpus year defined by 4 digits.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dataframe): Publications list with one row per author with correction </span>
<span class="sd">                     of author-names and drop of authors with inappropriate </span>
<span class="sd">                     affiliation to the Institute.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Internal functions</span>

    <span class="k">def</span> <span class="nf">_retain_firstname_initials</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">initials</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">initials</span>

    <span class="k">def</span> <span class="nf">_split_lastname_firstname</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">digits_min</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">names_list</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">first_names_list</span> <span class="o">=</span> <span class="n">names_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">last_names_list</span>  <span class="o">=</span> <span class="n">names_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name_idx</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">last_names_list</span><span class="p">):</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">&lt;</span><span class="n">digits_min</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">first_names_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">first_names_list</span> <span class="o">=</span> <span class="n">first_names_list</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">last_names_list</span>  <span class="o">=</span> <span class="n">last_names_list</span><span class="p">[:</span><span class="n">name_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">last_names_list</span><span class="p">[(</span><span class="n">name_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>

        <span class="n">first_name_initials</span> <span class="o">=</span> <span class="n">_retain_firstname_initials</span><span class="p">((</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_names_list</span><span class="p">))</span>
        <span class="n">last_name</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">last_names_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">last_name</span><span class="p">,</span> <span class="n">first_name_initials</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_filt_authors_inst</span><span class="p">(</span><span class="n">inst_col_list</span><span class="p">,</span> <span class="n">main_status</span><span class="p">,</span> <span class="n">main_inst_idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The function `_build_filt_authors_inst` builds the `filt_authors_inst_` filter</span>
<span class="sd">        to select the authors by their institution.</span>

<span class="sd">        Args:</span>
<span class="sd">            inst_col_list (list): List of column names (str) that contains </span>
<span class="sd">                                  affiliation status to the Institute.</span>
<span class="sd">            main_status (bool): Status of the combination of &#39;inst_col_list&#39; columns </span>
<span class="sd">                                to identify affiliation to the Institute. </span>
<span class="sd">            main_inst_idx (int): Index of the unique column name in &#39;inst_col_list&#39; list </span>
<span class="sd">                                 to be used for the Institute affiliation status </span>
<span class="sd">                                 for &#39;main_status&#39; set to False.                    </span>

<span class="sd">        Returns:</span>
<span class="sd">            (Pandas Series): A filter on specified columns depending on the status </span>
<span class="sd">                             of the combination of &#39;inst_col_list&#39; columns </span>
<span class="sd">                             of the &#39;authorsinst_authors_df&#39; dataframe that sets: </span>
<span class="sd">                                 - True if any in these columns is equal to 1 for the author;</span>
<span class="sd">                                 - False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">main_inst_col</span> <span class="o">=</span> <span class="n">inst_col_list</span><span class="p">[</span><span class="n">main_inst_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">main_status</span><span class="p">:</span>
            <span class="n">filt_authors_inst_</span> <span class="o">=</span> <span class="n">authorsinst_authors_df</span><span class="p">[</span><span class="n">main_inst_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first_inst_col</span> <span class="o">=</span> <span class="n">inst_col_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">filt_authors_inst_</span> <span class="o">=</span> <span class="n">authorsinst_authors_df</span><span class="p">[</span><span class="n">first_inst_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">inst_idx</span><span class="p">,</span> <span class="n">inst_col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inst_col_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">inst_idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">filt_authors_inst_</span> <span class="o">=</span> <span class="n">filt_authors_inst_</span> <span class="o">|</span> <span class="p">(</span><span class="n">authorsinst_authors_df</span><span class="p">[</span><span class="n">inst_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filt_authors_inst_</span>

    <span class="c1"># Setting useful col list</span>
    <span class="n">bp_auth_col_list</span>  <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">]</span>
    <span class="n">bp_pub_id_alias</span>   <span class="o">=</span> <span class="n">bp_auth_col_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bp_auth_idx_alias</span> <span class="o">=</span> <span class="n">bp_auth_col_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">bp_co_auth_alias</span>  <span class="o">=</span> <span class="n">bp_auth_col_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">articles_item_alias</span>   <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">PARSING_ITEMS_LIST</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">authors_item_alias</span>    <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">PARSING_ITEMS_LIST</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">auth_inst_item_alias</span>  <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">PARSING_ITEMS_LIST</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">bm_colnames_alias</span>     <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BM</span>
    <span class="n">corpus_year_col_alias</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BONUS</span><span class="p">[</span><span class="s1">&#39;corpus_year&#39;</span><span class="p">]</span>

    <span class="c1"># Getting the full paths of the working folder architecture for the corpus &quot;corpus_year&quot;</span>
    <span class="n">config_tup</span> <span class="o">=</span> <span class="n">set_user_config</span><span class="p">(</span><span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">pg</span><span class="o">.</span><span class="n">BDD_LIST</span><span class="p">)</span>
    <span class="n">parsing_path_dict</span><span class="p">,</span> <span class="n">item_filename_dict</span> <span class="o">=</span> <span class="n">config_tup</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">config_tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Setting parsing files extension of saved results</span>
    <span class="n">parsing_save_extent</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">TSV_SAVE_EXTENT</span>

    <span class="c1"># Setting path of deduplicated parsings</span>
    <span class="n">dedup_parsing_path</span> <span class="o">=</span> <span class="n">parsing_path_dict</span><span class="p">[</span><span class="s1">&#39;dedup&#39;</span><span class="p">]</span>

    <span class="c1"># Getting the dict of deduplication results</span>
    <span class="n">dedup_parsing_dict</span> <span class="o">=</span> <span class="n">read_parsing_dict</span><span class="p">(</span><span class="n">dedup_parsing_path</span><span class="p">,</span> <span class="n">item_filename_dict</span><span class="p">,</span>
                                           <span class="n">parsing_save_extent</span><span class="p">)</span>

    <span class="c1"># Getting ID of each author with institution by publication ID</span>
    <span class="n">authorsinst_df</span> <span class="o">=</span> <span class="n">dedup_parsing_dict</span><span class="p">[</span><span class="n">auth_inst_item_alias</span><span class="p">]</span>

    <span class="c1"># Getting ID of each author with author name</span>
    <span class="n">authors_df</span> <span class="o">=</span> <span class="n">dedup_parsing_dict</span><span class="p">[</span><span class="n">authors_item_alias</span><span class="p">]</span>

    <span class="c1"># Getting ID of each publication with complementary info</span>
    <span class="n">articles_df</span> <span class="o">=</span> <span class="n">dedup_parsing_dict</span><span class="p">[</span><span class="n">articles_item_alias</span><span class="p">]</span>

    <span class="c1"># Adding new column with year of initial publication which is the corpus year</span>
    <span class="n">articles_df</span><span class="p">[</span><span class="n">corpus_year_col_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span>

    <span class="c1"># Combining name of author to author ID with institution by publication ID</span>
    <span class="n">authorsinst_authors_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">authorsinst_df</span><span class="p">,</span>
                                      <span class="n">authors_df</span><span class="p">,</span>
                                      <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                                      <span class="n">left_on</span>  <span class="o">=</span> <span class="p">[</span><span class="n">bp_pub_id_alias</span><span class="p">,</span> <span class="n">bp_auth_idx_alias</span><span class="p">],</span>
                                      <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="n">bp_pub_id_alias</span><span class="p">,</span> <span class="n">bp_auth_idx_alias</span><span class="p">])</span>

    <span class="c1"># Building the authors filter of the institution INSTITUTE</span>
    <span class="n">inst_col_list</span> <span class="o">=</span> <span class="n">org_tup</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">main_inst_idx</span> <span class="o">=</span> <span class="n">org_tup</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">main_status</span>   <span class="o">=</span> <span class="n">org_tup</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">filt_authors_inst</span> <span class="o">=</span> <span class="n">_build_filt_authors_inst</span><span class="p">(</span><span class="n">inst_col_list</span><span class="p">,</span> <span class="n">main_status</span><span class="p">,</span> <span class="n">main_inst_idx</span><span class="p">)</span>

    <span class="c1"># Associating each publication (including its complementary info)</span>
    <span class="c1"># whith each of its INSTITUTE authors</span>
    <span class="c1"># The resulting dataframe contains a row for each INSTITUTE author</span>
    <span class="c1"># with the corresponding publication info</span>
    <span class="n">inst_merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">authorsinst_authors_df</span><span class="p">[</span><span class="n">filt_authors_inst</span><span class="p">],</span>
                              <span class="n">articles_df</span><span class="p">,</span>
                              <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span>
                              <span class="n">left_on</span>  <span class="o">=</span> <span class="p">[</span><span class="n">bp_pub_id_alias</span><span class="p">],</span>
                              <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="n">bp_pub_id_alias</span><span class="p">])</span>

    <span class="c1"># Transforming to uppercase the Institute author name</span>
    <span class="c1"># which is in column COL_NAMES[&#39;co_author&#39;]</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">bp_co_auth_alias</span>
    <span class="n">inst_merged_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst_merged_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="c1"># Splitting the Institute author name to firstname initials and lastname</span>
    <span class="c1"># and putting them as a tuple in column COL_NAMES_BM[&#39;Full_name&#39;]</span>
    <span class="n">col_in</span><span class="p">,</span> <span class="n">col_out</span> <span class="o">=</span> <span class="n">bp_co_auth_alias</span><span class="p">,</span> <span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;Full_name&#39;</span><span class="p">]</span>
    <span class="n">inst_merged_df</span><span class="p">[</span><span class="n">col_out</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst_merged_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span>
                                                   <span class="n">_split_lastname_firstname</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col_in</span><span class="p">]),</span>
                                                   <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Splitting tuples of column COL_NAMES_BM[&#39;Full_name&#39;]</span>
    <span class="c1"># into the two columns COL_NAMES_BM[&#39;Last_name&#39;] and COL_NAMES_BM[&#39;First_name&#39;]</span>
    <span class="n">col_in</span> <span class="o">=</span> <span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;Full_name&#39;</span><span class="p">]</span> <span class="c1"># Last_name + firstname initials</span>
    <span class="n">col1_out</span><span class="p">,</span> <span class="n">col2_out</span> <span class="o">=</span> <span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;Last_name&#39;</span><span class="p">],</span> <span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;First_name&#39;</span><span class="p">]</span>
    <span class="n">inst_merged_df</span><span class="p">[[</span><span class="n">col1_out</span><span class="p">,</span> <span class="n">col2_out</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">inst_merged_df</span><span class="p">[</span><span class="n">col_in</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="c1"># Recasting tuples (NAME, INITIALS) into a single string &#39;NAME INITIALS&#39;</span>
    <span class="n">col_in</span> <span class="o">=</span> <span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;Full_name&#39;</span><span class="p">]</span> <span class="c1"># Last_name + firstname initials</span>
    <span class="n">inst_merged_df</span><span class="p">[</span><span class="n">col_in</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst_merged_df</span><span class="p">[</span><span class="n">col_in</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  <span class="c1"># pylint: disable=unnecessary-lambda</span>

    <span class="c1"># Checking author name spelling and correct it then replacing author names</span>
    <span class="c1"># resulting from publication metadata errors</span>
    <span class="c1"># finally Searching for authors external to Institute but tagged as affiliated to it</span>
    <span class="c1"># and dropping their row in the returned dataframe</span>
    <span class="n">names_cols_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;Last_name&#39;</span><span class="p">],</span>
                      <span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;First_name&#39;</span><span class="p">])</span>
    <span class="n">cols_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;Full_name&#39;</span><span class="p">],)</span> <span class="o">+</span> <span class="n">names_cols_tup</span>
    <span class="n">inst_merged_df</span> <span class="o">=</span> <span class="n">_check_names_spelling</span><span class="p">(</span><span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">inst_merged_df</span><span class="p">,</span> <span class="n">cols_tup</span><span class="p">)</span>
    <span class="n">inst_merged_df</span> <span class="o">=</span> <span class="n">_check_names_to_replace</span><span class="p">(</span><span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span>
                                             <span class="n">inst_merged_df</span><span class="p">,</span> <span class="n">cols_tup</span><span class="p">)</span>
    <span class="n">inst_merged_df</span> <span class="o">=</span> <span class="n">_check_authors_to_remove</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span>
                                              <span class="n">inst_merged_df</span><span class="p">,</span> <span class="n">names_cols_tup</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inst_merged_df</span>


<span class="k">def</span> <span class="nf">_build_submit_df</span><span class="p">(</span><span class="n">empl_df</span><span class="p">,</span> <span class="n">pub_df</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">test_case</span> <span class="o">=</span> <span class="s1">&#39;No test&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Builds a dataframe of the merged employees information with the publication </span>
<span class="sd">    list with one row per author.</span>
<span class="sd">    The merge is based on test of similarities between last names and first names </span>
<span class="sd">    of employees and authors.</span>
<span class="sd">    Found homonyms are tagged by &#39;HOMONYM_FLAG&#39; global imported from globals </span>
<span class="sd">    module imported as pg.</span>

<span class="sd">    Args:</span>
<span class="sd">        empl_df (dataframe): Employees database of a given year.</span>
<span class="sd">        pub_df (dataframe): Institute publications list with one row per author. </span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        test_case (str): Optional test case for testing the function (default = &#39;No test&#39;).</span>
<span class="sd">        verbose (bool): Optional status of prints (default = False).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tup): Tuple = (dataframe of merged employees information with </span>
<span class="sd">                        the publications list with one row per Institute author </span>
<span class="sd">                        with identified homonyms, </span>
<span class="sd">                        dataframe of publications list with one row per author </span>
<span class="sd">                        that has not been identified as Institute employee).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_orphan_reduction</span><span class="p">(</span><span class="n">orphan_lastname</span><span class="p">,</span> <span class="n">eff_lastname</span><span class="p">):</span>
        <span class="c1"># A bug with &quot;if &#39; TRAN &#39; in &#39; TUAN TRAN &#39;:&quot;</span>
        <span class="n">orphan_lastname</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">orphan_lastname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
        <span class="n">lastname_match_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">eff_name</span> <span class="ow">in</span> <span class="n">eff_lastname</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">orphan_lastname</span> <span class="ow">in</span> <span class="n">eff_name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">eff_name</span> <span class="ow">in</span> <span class="n">orphan_lastname</span><span class="p">):</span>
                <span class="n">lastname_match_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eff_name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">lastname_match_list</span>

    <span class="k">def</span> <span class="nf">_test_full_match</span><span class="p">(</span><span class="n">empl_pub_match_df</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">,</span> <span class="n">emp_useful_cols_alias</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">empl_pub_match_df</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Match found for author lastname:&#39;</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Nb of matches:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">empl_pub_match_df</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Employee matricule:&#39;</span><span class="p">,</span>
                      <span class="n">empl_pub_match_df</span><span class="p">[</span><span class="n">emp_useful_cols_alias</span><span class="p">[</span><span class="s1">&#39;matricule&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Employee lastname:&#39;</span><span class="p">,</span>
                      <span class="n">empl_pub_match_df</span><span class="p">[</span><span class="n">emp_useful_cols_alias</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No match for author lastname:&#39;</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Nb first matches:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">empl_pub_match_df</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_test_similarity</span><span class="p">(</span><span class="n">empl_pub_match_df</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">,</span> <span class="n">emp_useful_cols_alias</span><span class="p">,</span>
                         <span class="n">lastname_match_list</span><span class="p">,</span> <span class="n">flag_lastname_match</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Similarities by orphan reduction for author lastname:&#39;</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Lastname flag match:&#39;</span><span class="p">,</span> <span class="n">flag_lastname_match</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Nb similarities by orphan reduction:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lastname_match_list</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  List of lastnames with similarities:&#39;</span><span class="p">,</span> <span class="n">lastname_match_list</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Employee matricules:&#39;</span><span class="p">,</span>
                  <span class="n">empl_pub_match_df</span><span class="p">[</span><span class="n">emp_useful_cols_alias</span><span class="p">[</span><span class="s1">&#39;matricule&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Employee lastnames:&#39;</span><span class="p">,</span>
                  <span class="n">empl_pub_match_df</span><span class="p">[</span><span class="n">emp_useful_cols_alias</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Employee firstnames:&#39;</span><span class="p">,</span>
                  <span class="n">empl_pub_match_df</span><span class="p">[</span><span class="n">emp_useful_cols_alias</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Employee fullnames:&#39;</span><span class="p">,</span>
                  <span class="n">empl_pub_match_df</span><span class="p">[</span><span class="n">emp_add_cols_alias</span><span class="p">[</span><span class="s1">&#39;employee_full_name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_test_no_similarity</span><span class="p">(</span><span class="n">pub_df_row</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">,</span> <span class="n">bp_colnames_alias</span><span class="p">,</span> <span class="n">bm_colnames_alias</span><span class="p">,</span>
                            <span class="n">lastname_match_list</span><span class="p">,</span> <span class="n">flag_lastname_match</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No similarity by orphan reduction for author lastname:&#39;</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Lastname flag match:&#39;</span><span class="p">,</span> <span class="n">flag_lastname_match</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Nb similarities by orphan reduction:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lastname_match_list</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Orphan full author name:&#39;</span><span class="p">,</span> <span class="n">pub_df_row</span><span class="p">[</span><span class="n">bp_colnames_alias</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Orphan author lastname:&#39;</span><span class="p">,</span>  <span class="n">pub_df_row</span><span class="p">[</span><span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;Last_name&#39;</span><span class="p">]])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Orphan author firstname initials:&#39;</span><span class="p">,</span>
                  <span class="n">pub_df_row</span><span class="p">[</span><span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;First_name&#39;</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">_test_match_of_firstname_initials</span><span class="p">(</span><span class="n">pub_df_row</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">,</span> <span class="n">pub_firstname</span><span class="p">,</span> <span class="n">eff_firstnames</span><span class="p">,</span>
                                           <span class="n">bp_colnames_alias</span><span class="p">,</span> <span class="n">list_idx</span><span class="p">,</span> <span class="n">eff_lastnames_spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Initials for author lastname:&#39;</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Author fullname:&#39;</span><span class="p">,</span> <span class="n">pub_df_row</span><span class="p">[</span><span class="n">bp_colnames_alias</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Author firstname initials:&#39;</span><span class="p">,</span> <span class="n">pub_firstname</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Initials of matching employees for author lastname:&#39;</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Employees firstname initials list:&#39;</span><span class="p">,</span> <span class="n">eff_firstnames</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Checking initials matching for author lastname:&#39;</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Nb of matching initials:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_idx</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Index list of matching initials:&#39;</span><span class="p">,</span> <span class="n">list_idx</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Employees lastnames list:&#39;</span><span class="p">,</span> <span class="n">eff_lastnames_spec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_spec_dfs</span><span class="p">(</span><span class="n">temp_df</span><span class="p">):</span>
        <span class="n">temp_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">checks_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;temp_df_&#39;</span> <span class="o">+</span> <span class="n">test_name</span> <span class="o">+</span> <span class="s1">&#39;.xlsx&#39;</span><span class="p">),</span>
                         <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">empl_pub_match_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">checks_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;empl_pub_match_df_&#39;</span> <span class="o">+</span> <span class="n">test_name</span> <span class="o">+</span> <span class="s1">&#39;.xlsx&#39;</span><span class="p">),</span>
                                  <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">bp_colnames_alias</span>     <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span>
    <span class="n">bm_colnames_alias</span>     <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BM</span>
    <span class="n">emp_useful_cols_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span>
    <span class="n">emp_add_cols_alias</span>    <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span>

    <span class="c1"># Initializing a Data frame that will contains all matches</span>
    <span class="c1"># between &#39;pub_df&#39; author-name and &#39;empl_df&#39; emmployee-name</span>
    <span class="n">submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Initializing a Data frame that will contains all &#39;pub_df&#39; author-names</span>
    <span class="c1"># which do not match with any of the &#39;empl_df&#39; emmployee-names</span>
    <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pub_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="c1"># Building the set of lastnames (without duplicates) of the dataframe &#39;empl_df&#39;</span>
    <span class="n">eff_lastnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">empl_df</span><span class="p">[</span><span class="n">emp_useful_cols_alias</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
    <span class="n">eff_lastnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eff_lastnames</span><span class="p">]</span>

    <span class="c1"># Setting the useful info for testing the function if verbose = True</span>
    <span class="c1"># Setting a dict keyyed by type of test with values for test states and</span>
    <span class="c1"># test name from column [COL_NAMES_BM[&#39;Last_name&#39;]] of the dataframe &#39;pub_df&#39;</span>
    <span class="c1"># for testing this function for year 2021</span>
    <span class="n">test_dict</span>   <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Full match&#39;</span>            <span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;SIMONATO&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;Lower value similarity&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;SILVA&#39;</span> <span class="p">],</span>
                   <span class="s1">&#39;Upper value similarity&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;TUAN TRAN&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;No similarity&#39;</span>         <span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;LUIS GABRIEL&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;No test&#39;</span>               <span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;None&#39;</span><span class="p">]</span>
                   <span class="p">}</span>
    <span class="n">test_nb</span>     <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_dict</span><span class="p">[</span><span class="n">test_case</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">test_name</span>   <span class="o">=</span> <span class="n">test_dict</span><span class="p">[</span><span class="n">test_case</span><span class="p">][</span><span class="n">test_nb</span><span class="p">]</span>
    <span class="n">test_states</span> <span class="o">=</span> <span class="n">test_dict</span><span class="p">[</span><span class="n">test_case</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">test_nb</span><span class="p">]</span>

    <span class="c1"># Building submit_df and orphan_df dataframes</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pub_df_row</span> <span class="ow">in</span> <span class="n">pub_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

        <span class="c1"># Building a dataframe &#39;empl_pub_match_df&#39; with rows of &#39;empl_df&#39;</span>
        <span class="c1"># where name in column COL_NAMES_BM[&#39;Last_name&#39;] of the dataframe &#39;pub_df&#39;</span>
        <span class="c1"># matches with name in column EMPLOYEES_USEFUL_COLS[&#39;name&#39;] of the dataframe &#39;empl_df&#39;</span>

        <span class="c1"># Initializing &#39;empl_pub_match_df&#39; as dataframe</span>
        <span class="n">empl_pub_match_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Initializing the flag &#39;flag_lastname_match&#39; as True by default</span>
        <span class="n">flag_lastname_match</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Getting the lastname from pub_df_row row of the dataframe pub_df</span>
        <span class="n">pub_lastname</span> <span class="o">=</span> <span class="n">pub_df_row</span><span class="p">[</span><span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;Last_name&#39;</span><span class="p">]]</span>

        <span class="c1"># Building the dataframe &#39;empl_pub_match_df&#39; with rows of dataframe empl_df</span>
        <span class="c1"># where item at EMPLOYEES_USEFUL_COLS[&#39;name&#39;] matches author lastname &#39;pub_lastname&#39;</span>
        <span class="n">empl_pub_match_df</span> <span class="o">=</span> <span class="n">empl_df</span><span class="p">[</span><span class="n">empl_df</span><span class="p">[</span><span class="n">emp_useful_cols_alias</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">pub_lastname</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Test of lastname full match</span>
        <span class="k">if</span> <span class="n">pub_lastname</span> <span class="o">==</span> <span class="n">test_name</span> <span class="ow">and</span> <span class="n">test_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">_test_full_match</span><span class="p">(</span><span class="n">empl_pub_match_df</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">,</span> <span class="n">emp_useful_cols_alias</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">empl_pub_match_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># No match found</span>
            <span class="n">flag_lastname_match</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Checking for a similarity</span>
            <span class="n">lastname_match_list</span> <span class="o">=</span> <span class="n">_orphan_reduction</span><span class="p">(</span><span class="n">pub_lastname</span><span class="p">,</span> <span class="n">eff_lastnames</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">lastname_match_list</span><span class="p">:</span>
                <span class="c1"># Concatenating in the dataframe &#39;empl_pub_match_df&#39;,</span>
                <span class="c1"># the rows of the dataframe &#39;empl_df&#39;</span>
                <span class="c1"># corresponding to each of the found similarities by orphan reduction</span>
                <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">lastname_match</span> <span class="ow">in</span> <span class="n">lastname_match_list</span><span class="p">:</span>
                    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">empl_df</span><span class="p">[</span><span class="n">empl_df</span><span class="p">[</span><span class="n">emp_useful_cols_alias</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">lastname_match</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="c1"># Replacing the employee last name by the publication last name</span>
                    <span class="c1"># for &#39;pub_emp_join_df&#39; building</span>
                    <span class="n">temp_df</span><span class="p">[</span><span class="n">emp_add_cols_alias</span><span class="p">[</span><span class="s1">&#39;employee_full_name&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                        <span class="n">pub_lastname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;First_name&#39;</span><span class="p">]]</span>
                    <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_df</span><span class="p">)</span>

                <span class="n">empl_pub_match_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">flag_lastname_match</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Test of lastnames similarity found by &#39;_orphan_reduction&#39; function</span>
                <span class="k">if</span> <span class="n">pub_lastname</span> <span class="o">==</span> <span class="n">test_name</span> <span class="ow">and</span> <span class="n">test_states</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">_test_similarity</span><span class="p">(</span><span class="n">empl_pub_match_df</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">,</span> <span class="n">emp_useful_cols_alias</span><span class="p">,</span>
                                     <span class="n">lastname_match_list</span><span class="p">,</span> <span class="n">flag_lastname_match</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Appending to dataframe orphan_df the row &#39;pub_df_row&#39;</span>
                <span class="c1"># as effective orphan after orphan reduction</span>
                <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">orphan_df</span><span class="p">,</span> <span class="n">pub_df_row</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>
                <span class="n">flag_lastname_match</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Test of lastnames no-similarity by &#39;_orphan_reduction&#39; function</span>
                <span class="k">if</span> <span class="n">pub_lastname</span> <span class="o">==</span> <span class="n">test_name</span> <span class="ow">and</span> <span class="n">test_states</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">_test_no_similarity</span><span class="p">(</span><span class="n">pub_df_row</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">,</span> <span class="n">bp_colnames_alias</span><span class="p">,</span>
                                        <span class="n">bm_colnames_alias</span><span class="p">,</span> <span class="n">lastname_match_list</span><span class="p">,</span>
                                        <span class="n">flag_lastname_match</span><span class="p">)</span>

        <span class="c1"># Checking match for a given lastname between the publication first-name</span>
        <span class="c1"># and the employee first-name</span>
        <span class="k">if</span> <span class="n">flag_lastname_match</span><span class="p">:</span>

            <span class="c1"># Finding the author name initials for the current publication</span>
            <span class="n">pub_firstname</span> <span class="o">=</span> <span class="n">pub_df_row</span><span class="p">[</span><span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;First_name&#39;</span><span class="p">]]</span>

            <span class="c1"># List of firstnames initials of a given name in the employees data</span>
            <span class="n">eff_firstnames</span> <span class="o">=</span> <span class="n">empl_pub_match_df</span><span class="p">[</span><span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;First_name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">eff_lastnames_spec</span> <span class="o">=</span> <span class="n">empl_pub_match_df</span><span class="p">[</span><span class="n">emp_useful_cols_alias</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

            <span class="c1"># Building the list of index of firs names initials</span>
            <span class="n">list_idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">eff_firstname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eff_firstnames</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">pub_firstname</span> <span class="o">==</span> <span class="n">eff_firstname</span><span class="p">:</span>
                    <span class="n">list_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">pub_firstname</span> <span class="o">==</span> <span class="n">eff_firstname</span><span class="p">:</span>
                    <span class="c1"># Replacing the employee first name initials</span>
                    <span class="c1"># by the publication first name initials</span>
                    <span class="c1"># for &#39;pub_emp_join_df&#39; building</span>
                    <span class="n">empl_pub_match_df</span><span class="p">[</span><span class="n">emp_add_cols_alias</span><span class="p">[</span><span class="s1">&#39;employee_full_name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">pub_lastname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">pub_firstname</span>
                    <span class="n">list_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

            <span class="c1"># Test of match of firstname initials for lastname match or similarity</span>
            <span class="k">if</span> <span class="n">pub_lastname</span> <span class="o">==</span> <span class="n">test_name</span> <span class="ow">and</span> <span class="n">test_states</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">_test_match_of_firstname_initials</span><span class="p">(</span><span class="n">pub_df_row</span><span class="p">,</span> <span class="n">pub_lastname</span><span class="p">,</span> <span class="n">pub_firstname</span><span class="p">,</span>
                                                  <span class="n">eff_firstnames</span><span class="p">,</span> <span class="n">bp_colnames_alias</span><span class="p">,</span>
                                                  <span class="n">list_idx</span><span class="p">,</span> <span class="n">eff_lastnames_spec</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">list_idx</span><span class="p">:</span>
                <span class="c1"># Building a dataframe &#39;temp_df&#39; with the row &#39;pub_df_row&#39;</span>
                <span class="c1"># related to a given publication</span>
                <span class="c1"># and adding the item value HOMONYM_FLAG</span>
                <span class="c1"># at column COL_NAMES_BM[&#39;Homonym&#39;]</span>
                <span class="c1"># when several matches on firstname initials are found</span>
                <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pub_df_row</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
                <span class="n">temp_df</span><span class="p">[</span><span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;Homonym&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                    <span class="n">pg</span><span class="o">.</span><span class="n">HOMONYM_FLAG</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;_&#39;</span>

                <span class="c1"># Saving specific dataframes &#39;temp_df&#39; and &#39;empl_pub_match_df&#39; for function testing</span>
                <span class="k">if</span> <span class="n">pub_lastname</span> <span class="o">==</span> <span class="n">test_name</span> <span class="ow">and</span> <span class="n">test_states</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
                    <span class="c1"># Creating path for saving test files</span>
                    <span class="n">checks_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">bibliometer_path</span><span class="p">)</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;Temp_checks&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">checks_path</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">checks_path</span><span class="p">)</span>
                    <span class="n">_save_spec_dfs</span><span class="p">(</span><span class="n">temp_df</span><span class="p">)</span>

                <span class="c1"># Merging the dataframe &#39;empl_pub_match_df&#39; to the dataframe &#39;temp_df&#39;</span>
                <span class="c1"># by matching column &#39;[COL_NAMES_BM[&#39;Last_name&#39;]]&#39; of the dataframe &#39;temp_df&#39;</span>
                <span class="c1"># to the column &#39;EMPLOYEES_ADD_COLS[&#39;employee_full_name&#39;]&#39;</span>
                <span class="c1"># of the dataframe &#39;empl_pub_match_df&#39;</span>
                <span class="n">pub_emp_join_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">temp_df</span><span class="p">,</span>
                                           <span class="n">empl_pub_match_df</span><span class="p">,</span>
                                           <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                           <span class="n">left_on</span>  <span class="o">=</span> <span class="p">[</span><span class="n">bm_colnames_alias</span><span class="p">[</span><span class="s1">&#39;Full_name&#39;</span><span class="p">]],</span>
                                           <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="n">emp_add_cols_alias</span><span class="p">[</span><span class="s1">&#39;employee_full_name&#39;</span><span class="p">]])</span>

                <span class="c1"># Appending to the dataframe &#39;submit_df&#39; the dataframe &#39;pub_emp_join_df&#39;</span>
                <span class="c1"># which is specific to a given publication</span>
                <span class="n">submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">submit_df</span><span class="p">,</span> <span class="n">pub_emp_join_df</span><span class="p">],</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Appending to the dataframe orphan_df the row &#39;pub_df_row&#39; as effective orphan</span>
                <span class="c1"># after complementary checking of match via first name initials</span>
                <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">orphan_df</span><span class="p">,</span> <span class="n">pub_df_row</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Dropping duplicate rows if both dataframes (mandatory)</span>
    <span class="n">submit_df</span> <span class="o">=</span> <span class="n">submit_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">orphan_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">submit_df</span><span class="p">,</span> <span class="n">orphan_df</span>


<span class="k">def</span> <span class="nf">_add_author_job_type</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">out_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_add_author_job_type` adds a new column </span>
<span class="sd">    containing the job type for each author of the publications </span>
<span class="sd">    list with one row per author and saves it as Excel file.</span>
<span class="sd">    The job type is got from the employee information available </span>
<span class="sd">    in 3 columns which names are given by &#39;category_col_alias&#39;, </span>
<span class="sd">    &#39;status_col_alias&#39; and &#39;qualification_col_alias&#39;.</span>
<span class="sd">    The name of the new column is given by &#39;author_type_col_alias&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        in_path (path):  Full path to the Excel file of the publications list </span>
<span class="sd">                         with one row per author with attributes as Institute </span>
<span class="sd">                         employee.</span>
<span class="sd">        out_path (path): Full path for saving the modified publications list.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): End message recalling the full path to the saved file </span>
<span class="sd">               of the modified publications list.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># internal functions:</span>
    <span class="k">def</span> <span class="nf">_get_author_type</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="n">author_type</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">dic</span> <span class="ow">in</span> <span class="n">author_types_dic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">values_list</span> <span class="ow">in</span> <span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">values_status</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values_list</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">values_status</span><span class="p">):</span>
                    <span class="n">author_type</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">return</span> <span class="n">author_type</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">category_col_alias</span>      <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>
    <span class="n">status_col_alias</span>        <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
    <span class="n">qualification_col_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;qualification&#39;</span><span class="p">]</span>
    <span class="n">author_type_col_alias</span>   <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BONUS</span><span class="p">[</span><span class="s1">&#39;author_type&#39;</span><span class="p">]</span>

    <span class="n">author_types_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">category_col_alias</span>      <span class="p">:</span> <span class="n">eg</span><span class="o">.</span><span class="n">CATEGORIES_DIC</span><span class="p">,</span>
                        <span class="n">status_col_alias</span>        <span class="p">:</span> <span class="n">eg</span><span class="o">.</span><span class="n">STATUS_DIC</span><span class="p">,</span>
                        <span class="n">qualification_col_alias</span> <span class="p">:</span> <span class="n">eg</span><span class="o">.</span><span class="n">QUALIFICATION_DIC</span><span class="p">}</span>

    <span class="c1"># Read of the excel file with dates conversion through EMPLOYEES_CONVERTERS_DIC</span>
    <span class="n">submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">converters</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_CONVERTERS_DIC</span><span class="p">)</span>

    <span class="n">submit_df</span><span class="p">[</span><span class="n">author_type_col_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">submit_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_get_author_type</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">submit_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">end_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Column with author job type added in file: </span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="k">return</span> <span class="n">end_message</span>


<span class="k">def</span> <span class="nf">_set_full_ref</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">first_author</span><span class="p">,</span> <span class="n">journal_name</span><span class="p">,</span> <span class="n">pub_year</span><span class="p">,</span> <span class="n">doi</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_set_full_ref` builds the full reference of a publication.</span>

<span class="sd">    Args:</span>
<span class="sd">        title (str): Title of the publication.</span>
<span class="sd">        first_author (str): First author of the publication formated as &#39;NAME IJ&#39;</span>
<span class="sd">                            with &#39;NAME&#39; the lastname and &#39;IJ&#39; the initials</span>
<span class="sd">                            of the firstname of the author.</span>
<span class="sd">        journal_name (str): Name of the journal where the publication is published.</span>
<span class="sd">        pub_year (str): Publication year defined by 4 digits.</span>
<span class="sd">        doi (str): Digital identification of the publication.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): Full reference of the publication.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">full_ref</span>  <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">, &#39;</span>                     <span class="c1"># add the reference&#39;s title</span>
    <span class="n">full_ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">first_author</span><span class="si">}</span><span class="s1">. et al., &#39;</span>      <span class="c1"># add the reference&#39;s first author</span>
    <span class="n">full_ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">journal_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1">, &#39;</span> <span class="c1"># add the reference&#39;s journal name</span>
    <span class="n">full_ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pub_year</span><span class="si">}</span><span class="s1">, &#39;</span>                  <span class="c1"># add the reference&#39;s publication year</span>
    <span class="n">full_ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s1">&#39;</span>                         <span class="c1"># add the reference&#39;s DOI</span>
    <span class="k">return</span> <span class="n">full_ref</span>


<span class="k">def</span> <span class="nf">_add_biblio_list</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">out_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_add_biblio_list` adds a new column </span>
<span class="sd">    containing the full reference of each publication </span>
<span class="sd">    of the publications list with one row per author and saves it as Excel file.</span>
<span class="sd">    The full reference is built by concatenating the folowing items:</span>
<span class="sd">    title, first author, year, journal, DOI.</span>
<span class="sd">    These items are got from the columns which names are given by </span>
<span class="sd">    &#39;pub_title_alias&#39;, &#39;pub_first_author_alias&#39;, &#39;pub_year_alias&#39;, </span>
<span class="sd">    &#39;pub_journal_alias&#39; and &#39;pub_doi_alias&#39;, respectively.</span>
<span class="sd">    The name of the new column is given by &#39;pub_full_ref_alias&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        in_path (path): Full path to the Excel file of the publications list.</span>
<span class="sd">        out_path (path): Full path for saving the modified publications list.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): End message recalling the full path to the saved file </span>
<span class="sd">               of the modified publications list.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">pub_id_alias</span>           <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;pub_id&#39;</span><span class="p">]</span>
    <span class="n">pub_first_author_alias</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;articles&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pub_year_alias</span>         <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;articles&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">pub_journal_alias</span>      <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;articles&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">pub_doi_alias</span>          <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;articles&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">pub_title_alias</span>        <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;articles&#39;</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">pub_full_ref_alias</span>     <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BONUS</span><span class="p">[</span><span class="s1">&#39;liste biblio&#39;</span><span class="p">]</span>

    <span class="c1"># Read of the excel file with dates convertion through EMPLOYEES_CONVERTERS_DIC</span>
    <span class="n">submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">converters</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_CONVERTERS_DIC</span><span class="p">)</span>

    <span class="n">articles_plus_full_ref_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="c1"># Splitting the frame into subframes with same Pub_id</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pub_id_df</span> <span class="ow">in</span> <span class="n">submit_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pub_id_alias</span><span class="p">):</span>
        <span class="c1"># Select the first row and build the full reference</span>
        <span class="n">pub_id_first_row</span> <span class="o">=</span> <span class="n">pub_id_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">title</span>        <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pub_id_first_row</span><span class="p">[</span><span class="n">pub_title_alias</span><span class="p">])</span>
        <span class="n">first_author</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pub_id_first_row</span><span class="p">[</span><span class="n">pub_first_author_alias</span><span class="p">])</span>
        <span class="n">journal_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pub_id_first_row</span><span class="p">[</span><span class="n">pub_journal_alias</span><span class="p">])</span>
        <span class="n">pub_year</span>     <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pub_id_first_row</span><span class="p">[</span><span class="n">pub_year_alias</span><span class="p">])</span>
        <span class="n">doi</span>          <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pub_id_first_row</span><span class="p">[</span><span class="n">pub_doi_alias</span><span class="p">])</span>
        <span class="n">pub_id_df</span><span class="p">[</span><span class="n">pub_full_ref_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">_set_full_ref</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">first_author</span><span class="p">,</span>
                                                      <span class="n">journal_name</span><span class="p">,</span> <span class="n">pub_year</span><span class="p">,</span> <span class="n">doi</span><span class="p">)</span>
        <span class="n">articles_plus_full_ref_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">articles_plus_full_ref_df</span><span class="p">,</span> <span class="n">pub_id_df</span><span class="p">])</span>

    <span class="n">articles_plus_full_ref_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">end_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Column with full reference of publication added in file: </span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="k">return</span> <span class="n">end_message</span>


<span class="k">def</span> <span class="nf">_add_ext_docs</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">orphan_path</span><span class="p">,</span> <span class="n">ext_docs_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_add_ext_docs` adds to the publications-list dataframe </span>
<span class="sd">    with one row per author new rows containing the information of authors </span>
<span class="sd">    that are PhD students at the Institute but not as employees of it.</span>
<span class="sd">    The list of these PhD students with the required information is got from</span>
<span class="sd">    the excel file which full path is given by &#39;ext_docs_path&#39; in sheet which </span>
<span class="sd">    name is given by &#39;ext_docs_sheet_name_alias&#39;.</span>
<span class="sd">    The row of the added PhD students is dropped in the publications list </span>
<span class="sd">    with one row per author that has not been identified as Institute employee.</span>
<span class="sd">    The new publications lists are saved as Excel files.</span>

<span class="sd">    Args:</span>
<span class="sd">        submit_path (path): Full path to the Excel file of the publications list </span>
<span class="sd">                            with one row per author with attributes as Institute </span>
<span class="sd">                            employee.</span>
<span class="sd">        orphan_path (path): Full path to the Excel file of the publications list </span>
<span class="sd">                            with one row per author that has not been identified </span>
<span class="sd">                            as Institute employee.</span>
<span class="sd">        ext_docs_path (path): Full path to the Excel file giving the PhD students </span>
<span class="sd">                              at the Institute but not employees of it.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tup): Tuple = (updated dataframe of the publications list with one row </span>
<span class="sd">                        per Institute author including external PhD students,  </span>
<span class="sd">                        updated dataframe of publications list with one row per author </span>
<span class="sd">                        that has not been identified as Institute employee).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting aliases for useful column names</span>
    <span class="n">pub_id_alias</span>                      <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">author_id_alias</span>                   <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">converters_alias</span>                  <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_CONVERTERS_DIC</span>
    <span class="n">firstname_initials_col_base_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="p">[</span><span class="s1">&#39;first_name_initials&#39;</span><span class="p">]</span>
    <span class="n">ext_docs_full_name_alias</span>          <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="p">[</span><span class="s1">&#39;employee_full_name&#39;</span><span class="p">]</span>
    <span class="n">ext_docs_useful_col_list_alias</span>    <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EXT_DOCS_USEFUL_COL_LIST</span>
    <span class="n">ext_docs_pub_last_name_alias</span>      <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_PUB_NAMES</span><span class="p">[</span><span class="s1">&#39;last name&#39;</span><span class="p">]</span>
    <span class="n">ext_docs_pub_initials_alias</span>       <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_PUB_NAMES</span><span class="p">[</span><span class="s1">&#39;initials&#39;</span><span class="p">]</span>
    <span class="n">ext_docs_sheet_name_alias</span>         <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">SHEET_NAMES_ORPHAN</span><span class="p">[</span><span class="s2">&quot;docs to add&quot;</span><span class="p">]</span>
    <span class="n">ext_docs_col_adds_list_alias</span>      <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">EXT_DOCS_COL_ADDS_LIST</span>
    <span class="n">orphan_full_name_alias</span>            <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BM</span><span class="p">[</span><span class="s1">&#39;Full_name&#39;</span><span class="p">]</span>
    <span class="n">orphan_last_name_alias</span>            <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BM</span><span class="p">[</span><span class="s1">&#39;Last_name&#39;</span><span class="p">]</span>

    <span class="c1"># Reading of the existing submit excel file of the corpus year</span>
    <span class="c1"># with dates conversion through converters_alias</span>
    <span class="n">init_submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">converters</span> <span class="o">=</span> <span class="n">converters_alias</span><span class="p">)</span>
    <span class="n">init_orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">orphan_path</span><span class="p">,</span> <span class="n">converters</span> <span class="o">=</span> <span class="n">converters_alias</span><span class="p">)</span>

    <span class="c1"># Initializing new_submit_df with same column names as init_submit_df</span>
    <span class="n">new_submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">init_submit_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="c1"># Initializing the dataframe to be concatenated to init_submit_df in new_submit_df</span>
    <span class="c1"># with same column names as init_submit_df</span>
    <span class="n">new_submit_adds_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">init_submit_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="c1"># Aligning column names between init_submit_df and init_orphan_df</span>
    <span class="c1"># to feed new_submit_adds_df with same column names as init_submit_df</span>
    <span class="n">col_rename_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">firstname_initials_col_base_alias</span> <span class="p">:</span> <span class="n">firstname_initials_col_base_alias</span> <span class="o">+</span> <span class="s2">&quot;_x&quot;</span><span class="p">}</span>
    <span class="n">init_orphan_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">col_rename_dic</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">orphan_initials_alias</span> <span class="o">=</span> <span class="n">col_rename_dic</span><span class="p">[</span><span class="n">firstname_initials_col_base_alias</span><span class="p">]</span>

    <span class="c1"># Initializing new_orphan_df as copy of init_orphan_df</span>
    <span class="c1">#new_orphan_df = init_orphan_df.copy()</span>
    <span class="n">new_orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">init_orphan_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="c1"># Initializing the dataframe to be droped from init_orphan_df</span>
    <span class="c1"># with same column names as init_orphan_df</span>
    <span class="n">orphan_drop_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">init_orphan_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="c1"># Reading of the external phd students excel file</span>
    <span class="c1"># using the same useful columns as init_submit_df defined by EXT_DOCS_USEFUL_COL_LIST</span>
    <span class="c1"># with dates conversion through converters_alias</span>
    <span class="c1"># and drop of empty rows</span>
    <span class="n">ext_docs_usecols</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([[</span><span class="n">ext_docs_pub_last_name_alias</span><span class="p">,</span> <span class="n">ext_docs_pub_initials_alias</span><span class="p">],</span>
                            <span class="n">ext_docs_col_adds_list_alias</span><span class="p">,</span>
                            <span class="n">ext_docs_useful_col_list_alias</span><span class="p">,],</span>
                           <span class="p">[])</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span> <span class="o">=</span> <span class="ne">UserWarning</span><span class="p">)</span>
    <span class="n">ext_docs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">ext_docs_path</span><span class="p">,</span>
                                <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">ext_docs_sheet_name_alias</span><span class="p">,</span>
                                <span class="n">usecols</span>    <span class="o">=</span> <span class="n">ext_docs_usecols</span><span class="p">,</span>
                                <span class="n">converters</span> <span class="o">=</span> <span class="n">converters_alias</span><span class="p">)</span>
    <span class="n">ext_docs_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span> <span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Searching for last names of init_orphan_df in ext_docs_df</span>
    <span class="c1"># to update submit and orphan files using new_submit_adds_df and new_orphan_drop_df</span>
    <span class="k">for</span> <span class="n">orphan_row_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">init_orphan_df</span><span class="p">)):</span>
        <span class="n">author_last_name</span> <span class="o">=</span> <span class="n">init_orphan_df</span><span class="p">[</span><span class="n">orphan_last_name_alias</span><span class="p">][</span><span class="n">orphan_row_num</span><span class="p">]</span>
        <span class="n">author_initials</span>  <span class="o">=</span> <span class="n">init_orphan_df</span><span class="p">[</span><span class="n">orphan_initials_alias</span><span class="p">][</span><span class="n">orphan_row_num</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ext_docs_row_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ext_docs_df</span><span class="p">)):</span>
            <span class="n">ext_docs_pub_last_name</span> <span class="o">=</span> <span class="n">ext_docs_df</span><span class="p">[</span><span class="n">ext_docs_pub_last_name_alias</span><span class="p">][</span><span class="n">ext_docs_row_num</span><span class="p">]</span>
            <span class="n">ext_docs_pub_initials</span>  <span class="o">=</span> <span class="n">ext_docs_df</span><span class="p">[</span><span class="n">ext_docs_pub_initials_alias</span><span class="p">][</span><span class="n">ext_docs_row_num</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ext_docs_pub_last_name</span> <span class="o">==</span> <span class="n">author_last_name</span>
                    <span class="ow">and</span> <span class="n">ext_docs_pub_initials</span> <span class="o">==</span> <span class="n">author_initials</span><span class="p">):</span>
                <span class="c1"># Setting the row to move from init_orphan_df as a dataframe</span>
                <span class="n">row_to_move_df</span> <span class="o">=</span> <span class="n">init_orphan_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">orphan_row_num</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

                <span class="c1"># Setting the row to copy from ext_docs_df as a dataframe</span>
                <span class="n">row_to_copy_df</span> <span class="o">=</span> <span class="n">ext_docs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ext_docs_row_num</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

                <span class="c1"># Dropping the columns of row_to_copy_df that should not be present in row_to_add_df</span>
                <span class="n">row_to_copy_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">ext_docs_pub_last_name_alias</span><span class="p">,</span> <span class="n">ext_docs_pub_initials_alias</span><span class="p">],</span>
                                    <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Merging the two dataframes on respective full name column</span>
                <span class="n">row_to_add_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">row_to_move_df</span><span class="p">,</span>
                                         <span class="n">row_to_copy_df</span><span class="p">,</span>
                                         <span class="n">left_on</span>  <span class="o">=</span> <span class="p">[</span><span class="n">orphan_full_name_alias</span><span class="p">],</span>
                                         <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="n">ext_docs_full_name_alias</span><span class="p">],</span>
                                         <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>

                <span class="c1"># Appending the merged df to new_submit_adds_df</span>
                <span class="n">new_submit_adds_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">new_submit_adds_df</span><span class="p">,</span> <span class="n">row_to_add_df</span><span class="p">],</span>
                                               <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Appending row_to_move_df to  orphan_drop_df</span>
                <span class="n">orphan_drop_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">orphan_drop_df</span><span class="p">,</span> <span class="n">row_to_move_df</span><span class="p">],</span>
                                           <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Concatenating init_submit_df and new_submit_adds_df</span>
    <span class="n">new_submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">init_submit_df</span><span class="p">,</span> <span class="n">new_submit_adds_df</span><span class="p">])</span>
    <span class="n">new_submit_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">pub_id_alias</span><span class="p">,</span> <span class="n">author_id_alias</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Droping orphan_drop_df rows from init_orphan_df</span>
    <span class="n">new_orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">init_orphan_df</span><span class="p">,</span> <span class="n">orphan_drop_df</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Recovering the initial column names of init_orphan_df</span>
    <span class="n">col_invert_rename_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">firstname_initials_col_base_alias</span> <span class="o">+</span> <span class="s2">&quot;_x&quot;</span><span class="p">:</span> \
                                 <span class="n">firstname_initials_col_base_alias</span><span class="p">}</span>
    <span class="n">new_orphan_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">col_invert_rename_dic</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Saving new_submit_df and new_orphan_df replacing init_submit_df and init_submit_df</span>
    <span class="n">new_submit_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">new_orphan_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">orphan_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">new_submit_df</span><span class="p">,</span> <span class="n">new_orphan_df</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_other_ext</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">orphan_path</span><span class="p">,</span> <span class="n">others_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_add_other_ext` adds to the publications-list dataframe </span>
<span class="sd">    with one row per author new rows containing the information of authors </span>
<span class="sd">    that are under external hiring contract at the Institute.</span>
<span class="sd">    The list of these employees with the required information is got from</span>
<span class="sd">    the excel file which full path is given by &#39;others_path&#39; in sheet which </span>
<span class="sd">    name is given by &#39;others_sheet_name_alias&#39;.</span>
<span class="sd">    The row of the added employees is dropped in the publications list </span>
<span class="sd">    with one row per author that has not been identified as Institute employee.</span>
<span class="sd">    The new publications lists are saved as Excel files.</span>

<span class="sd">    Args:</span>
<span class="sd">        submit_path (path): Full path to the Excel file of the publications list </span>
<span class="sd">                            with one row per author with attributes as Institute </span>
<span class="sd">                            employee.</span>
<span class="sd">        orphan_path (path): Full path to the Excel file of the publications list </span>
<span class="sd">                            with one row per author that has not been identified </span>
<span class="sd">                            as Institute employee.</span>
<span class="sd">        ext_docs_path (path): Full path to the Excel file giving the employees </span>
<span class="sd">                              under external hiring contract at the Institute.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tup): Tuple = (updated dataframe of the publications list with one row </span>
<span class="sd">                        per Institute author including employees under external </span>
<span class="sd">                        hiring contract at the Institute, </span>
<span class="sd">                        updated dataframe of publications list with one row per author </span>
<span class="sd">                        that has not been identified as Institute employee).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting aliases for useful column names</span>
    <span class="n">pub_id_alias</span>                      <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">author_id_alias</span>                   <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">converters_alias</span>                  <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_CONVERTERS_DIC</span>
    <span class="n">firstname_initials_col_base_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="p">[</span><span class="s1">&#39;first_name_initials&#39;</span><span class="p">]</span>
    <span class="n">others_full_name_alias</span>            <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_ADD_COLS</span><span class="p">[</span><span class="s1">&#39;employee_full_name&#39;</span><span class="p">]</span>
    <span class="n">ext_docs_useful_col_list_alias</span>    <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EXT_DOCS_USEFUL_COL_LIST</span>
    <span class="n">others_pub_last_name_alias</span>        <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_PUB_NAMES</span><span class="p">[</span><span class="s1">&#39;last name&#39;</span><span class="p">]</span>
    <span class="n">others_pub_initials_alias</span>         <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_PUB_NAMES</span><span class="p">[</span><span class="s1">&#39;initials&#39;</span><span class="p">]</span>
    <span class="n">others_sheet_name_alias</span>           <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">SHEET_NAMES_ORPHAN</span><span class="p">[</span><span class="s2">&quot;others to add&quot;</span><span class="p">]</span>
    <span class="n">ext_docs_col_adds_list_alias</span>      <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">EXT_DOCS_COL_ADDS_LIST</span>
    <span class="n">orphan_full_name_alias</span>            <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BM</span><span class="p">[</span><span class="s1">&#39;Full_name&#39;</span><span class="p">]</span>
    <span class="n">orphan_last_name_alias</span>            <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BM</span><span class="p">[</span><span class="s1">&#39;Last_name&#39;</span><span class="p">]</span>

    <span class="c1"># Reading of the existing submit excel file of the corpus year</span>
    <span class="c1"># with dates conversion through converters_alias</span>
    <span class="n">init_submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">converters</span> <span class="o">=</span> <span class="n">converters_alias</span><span class="p">)</span>
    <span class="n">init_orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">orphan_path</span><span class="p">,</span> <span class="n">converters</span> <span class="o">=</span> <span class="n">converters_alias</span><span class="p">)</span>

    <span class="c1"># Initializing new_submit_df with same column names as init_submit_df</span>
    <span class="n">new_submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">init_submit_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="c1"># Initializing the dataframe to be concatenated to init_submit_df in new_submit_df</span>
    <span class="c1"># with same column names as init_submit_df</span>
    <span class="n">new_submit_adds_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">init_submit_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="c1"># Aligning column names between init_submit_df and init_orphan_df</span>
    <span class="c1"># to feed new_submit_adds_df with same column names as init_submit_df</span>
    <span class="n">col_rename_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">firstname_initials_col_base_alias</span> <span class="p">:</span> <span class="n">firstname_initials_col_base_alias</span> <span class="o">+</span> <span class="s2">&quot;_x&quot;</span><span class="p">}</span>
    <span class="n">init_orphan_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">col_rename_dic</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">orphan_initials_alias</span> <span class="o">=</span> <span class="n">col_rename_dic</span><span class="p">[</span><span class="n">firstname_initials_col_base_alias</span><span class="p">]</span>

    <span class="c1"># Initializing new_orphan_df as copy of init_orphan_df</span>
    <span class="c1">#new_orphan_df = init_orphan_df.copy()</span>
    <span class="n">new_orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">init_orphan_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="c1"># Initializing the dataframe to be droped from init_orphan_df</span>
    <span class="c1"># with same column names as init_orphan_df</span>
    <span class="n">orphan_drop_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">init_orphan_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="c1"># Reading of the external phd students excel file</span>
    <span class="c1"># using the same useful columns as init_submit_df defined by EXT_DOCS_USEFUL_COL_LIST</span>
    <span class="c1"># with dates conversion through converters_alias</span>
    <span class="c1"># and drop of empty rows</span>
    <span class="n">others_usecols</span>   <span class="o">=</span> <span class="nb">sum</span><span class="p">([[</span><span class="n">others_pub_last_name_alias</span><span class="p">,</span> <span class="n">others_pub_initials_alias</span><span class="p">],</span>
                            <span class="n">ext_docs_col_adds_list_alias</span><span class="p">,</span>
                            <span class="n">ext_docs_useful_col_list_alias</span><span class="p">,],</span>
                           <span class="p">[])</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
    <span class="n">others_df</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">others_path</span><span class="p">,</span>
                                <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">others_sheet_name_alias</span><span class="p">,</span>
                                <span class="n">usecols</span>   <span class="o">=</span> <span class="n">others_usecols</span><span class="p">,</span>
                                <span class="n">converters</span> <span class="o">=</span> <span class="n">converters_alias</span><span class="p">)</span>
    <span class="n">others_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Searching for last names of init_orphan_df in others_df</span>
    <span class="c1"># to update submit and orphan files using new_submit_adds_df and new_orphan_drop_df</span>
    <span class="k">for</span> <span class="n">orphan_row_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">init_orphan_df</span><span class="p">)):</span>
        <span class="n">author_last_name</span> <span class="o">=</span> <span class="n">init_orphan_df</span><span class="p">[</span><span class="n">orphan_last_name_alias</span><span class="p">][</span><span class="n">orphan_row_num</span><span class="p">]</span>
        <span class="n">author_initials</span>  <span class="o">=</span> <span class="n">init_orphan_df</span><span class="p">[</span><span class="n">orphan_initials_alias</span><span class="p">][</span><span class="n">orphan_row_num</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">others_row_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">others_df</span><span class="p">)):</span>
            <span class="n">others_pub_last_name</span> <span class="o">=</span> <span class="n">others_df</span><span class="p">[</span><span class="n">others_pub_last_name_alias</span><span class="p">][</span><span class="n">others_row_num</span><span class="p">]</span>
            <span class="n">others_pub_initials</span>  <span class="o">=</span> <span class="n">others_df</span><span class="p">[</span><span class="n">others_pub_initials_alias</span><span class="p">][</span><span class="n">others_row_num</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">others_pub_last_name</span> <span class="o">==</span> <span class="n">author_last_name</span> <span class="ow">and</span> <span class="n">others_pub_initials</span> <span class="o">==</span> <span class="n">author_initials</span><span class="p">:</span>
                <span class="c1"># Setting the row to move from init_orphan_df as a dataframe</span>
                <span class="n">row_to_move_df</span> <span class="o">=</span> <span class="n">init_orphan_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">orphan_row_num</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

                <span class="c1"># Setting the row to copy from others_df as a dataframe</span>
                <span class="n">row_to_copy_df</span> <span class="o">=</span> <span class="n">others_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">others_row_num</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

                <span class="c1"># Droping the columns of row_to_copy_df that should not be present in row_to_add_df</span>
                <span class="n">row_to_copy_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">others_pub_last_name_alias</span><span class="p">,</span> <span class="n">others_pub_initials_alias</span><span class="p">],</span>
                                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Merging the two dataframes on respective full name column</span>
                <span class="n">row_to_add_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">row_to_move_df</span><span class="p">,</span>
                                         <span class="n">row_to_copy_df</span><span class="p">,</span>
                                         <span class="n">left_on</span>  <span class="o">=</span> <span class="p">[</span><span class="n">orphan_full_name_alias</span><span class="p">],</span>
                                         <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="n">others_full_name_alias</span><span class="p">],</span>
                                         <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>

                <span class="c1"># Appending the merged df to new_submit_adds_df</span>
                <span class="n">new_submit_adds_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">new_submit_adds_df</span><span class="p">,</span> <span class="n">row_to_add_df</span><span class="p">],</span>
                                               <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Appending row_to_move_df to  orphan_drop_df</span>
                <span class="n">orphan_drop_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">orphan_drop_df</span><span class="p">,</span> <span class="n">row_to_move_df</span><span class="p">],</span>
                                           <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Concatenating init_submit_df and new_submit_adds_df</span>
    <span class="n">new_submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">init_submit_df</span><span class="p">,</span> <span class="n">new_submit_adds_df</span><span class="p">])</span>
    <span class="n">new_submit_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">pub_id_alias</span><span class="p">,</span> <span class="n">author_id_alias</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Dropping orphan_drop_df rows from init_orphan_df</span>
    <span class="n">new_orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">init_orphan_df</span><span class="p">,</span> <span class="n">orphan_drop_df</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Recovering the initial column names of init_orphan_df</span>
    <span class="n">col_invert_rename_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">firstname_initials_col_base_alias</span> <span class="o">+</span> <span class="s2">&quot;_x&quot;</span><span class="p">:</span> \
                                 <span class="n">firstname_initials_col_base_alias</span><span class="p">}</span>
    <span class="n">new_orphan_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">col_invert_rename_dic</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Saving new_submit_df and new_orphan_df replacing init_submit_df and init_submit_df</span>
    <span class="n">new_submit_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">new_orphan_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">orphan_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">new_submit_df</span><span class="p">,</span> <span class="n">new_orphan_df</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_change_col_names</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">submit_path</span><span class="p">,</span> <span class="n">orphan_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets new column names to the files pointed by &#39;submit_path&#39; </span>
<span class="sd">    and &#39;orphan_path&#39; paths through the `build_col_conversion_dic` </span>
<span class="sd">    function imported from `bmfuncts.rename_cols` module.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        submit_path (path): Full path to the Excel file of the publications list </span>
<span class="sd">                            with one row per author with attributes as Institute employee.</span>
<span class="sd">        orphan_path (path): Full path to the Excel file of the publications list </span>
<span class="sd">                            with one row per author that has not been identified </span>
<span class="sd">                            as Institute employee.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): End message recalling the full paths to the modified files.        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#  Setting useful col names</span>
    <span class="n">col_rename_tup</span> <span class="o">=</span> <span class="n">build_col_conversion_dic</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">)</span>
    <span class="n">orphan_col_rename_dic</span> <span class="o">=</span> <span class="n">col_rename_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">submit_col_rename_dic</span> <span class="o">=</span> <span class="n">col_rename_tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Read of the &#39;submit&#39; file with dates convertion through EMPLOYEES_CONVERTERS_DIC</span>
    <span class="n">submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">converters</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_CONVERTERS_DIC</span><span class="p">)</span>
    <span class="n">submit_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">submit_col_rename_dic</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Resaving submit_df</span>
    <span class="n">submit_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Read of the &#39;orphan&#39; file</span>
    <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">orphan_path</span><span class="p">)</span>
    <span class="n">orphan_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">orphan_col_rename_dic</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Resaving orphan_df</span>
    <span class="n">orphan_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">orphan_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">end_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Column renamed in files: </span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">{</span><span class="n">submit_path</span><span class="si">}</span><span class="s2">&#39; </span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">{</span><span class="n">orphan_path</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
    <span class="k">return</span> <span class="n">end_message</span>


<span class="k">def</span> <span class="nf">_split_orphan</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Splits the publications list with one row per author that has not been identified </span>
<span class="sd">    as Institute employee in separate lists of publications depending on values in columns </span>
<span class="sd">    given by &#39;inst_col_list&#39; list that is specific to the Institute. </span>
<span class="sd">    These lists are then saved as Excel files in the folder which full path </span>
<span class="sd">    is given by &#39;orphan_path&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        corpus_year (str): Contains the corpus year defined by 4 digits.</span>
<span class="sd">        verbose (bool): Status of prints (default = False).       </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Internal function</span>
    <span class="k">def</span> <span class="nf">_save_inst_col_df</span><span class="p">(</span><span class="n">inst_col</span><span class="p">,</span> <span class="n">inst_col_df</span><span class="p">):</span>
        <span class="n">inst_col_file_name</span> <span class="o">=</span> <span class="n">inst_col</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">orphan_file_name_alias</span>
        <span class="n">inst_col_file_path</span> <span class="o">=</span> <span class="n">bdd_mensuelle_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">inst_col_file_name</span><span class="p">)</span>
        <span class="n">inst_col_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">inst_col_file_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Excel file of orphan authors created for Institute subdivision: </span><span class="si">{</span><span class="n">inst_col</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">converters_alias</span> <span class="o">=</span> <span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_CONVERTERS_DIC</span>
    <span class="n">bdd_mensuelle_alias</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;bdd mensuelle&quot;</span><span class="p">]</span>
    <span class="n">orphan_file_name_alias</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;orphan file name&quot;</span><span class="p">]</span>

    <span class="c1"># Setting useful column names list</span>
    <span class="n">inst_col_list</span> <span class="o">=</span> <span class="n">org_tup</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

    <span class="c1"># Setting spliting status</span>
    <span class="n">orphan_split_status</span> <span class="o">=</span> <span class="n">org_tup</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>

    <span class="c1"># Setting useful paths</span>
    <span class="n">corpus_year_path</span> <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">corpus_year</span><span class="p">)</span>
    <span class="n">bdd_mensuelle_path</span> <span class="o">=</span> <span class="n">corpus_year_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">bdd_mensuelle_alias</span><span class="p">)</span>

    <span class="c1"># Reading of the existing orphan excel file</span>
    <span class="c1"># with dates conversion through converters_alias</span>
    <span class="n">orphan_path</span> <span class="o">=</span> <span class="n">bdd_mensuelle_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">orphan_file_name_alias</span><span class="p">)</span>
    <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">orphan_path</span><span class="p">,</span> <span class="n">converters</span> <span class="o">=</span> <span class="n">converters_alias</span><span class="p">)</span>

    <span class="c1"># Creating, and saving as Excel file, orphan authors for each Institute subdivision</span>
    <span class="n">institute_df</span> <span class="o">=</span> <span class="n">orphan_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">inst_col</span> <span class="ow">in</span> <span class="n">inst_col_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">inst_col_df</span> <span class="o">=</span> <span class="n">orphan_df</span><span class="p">[</span><span class="n">orphan_df</span><span class="p">[</span><span class="n">inst_col</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_save_inst_col_df</span><span class="p">(</span><span class="n">inst_col</span><span class="p">,</span> <span class="n">inst_col_df</span><span class="p">)</span>
        <span class="n">institute_df</span> <span class="o">=</span> <span class="n">institute_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">inst_col_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">_save_inst_col_df</span><span class="p">(</span><span class="n">inst_col_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">institute_df</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_my_hash</span><span class="p">(</span><span class="n">text</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Builts hash given the string &#39;text&#39; </span>
<span class="sd">    with a fixed prime numbers to mix up the bits.&quot;&quot;&quot;</span>

    <span class="n">my_hash</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">facts</span> <span class="o">=</span> <span class="p">(</span><span class="mi">257</span><span class="p">,</span><span class="mi">961</span><span class="p">)</span> <span class="c1"># prime numbers to mix up the bits</span>
    <span class="n">minus_one</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span> <span class="c1"># &quot;-1&quot; hex code</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">my_hash</span> <span class="o">=</span> <span class="p">(</span><span class="n">my_hash</span><span class="o">*</span><span class="n">facts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="o">*</span><span class="n">facts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">minus_one</span>
    <span class="k">return</span> <span class="n">my_hash</span>


<span class="k">def</span> <span class="nf">_creating_hash_id</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a dataframe which columns are given by &#39;hash_id_col_alias&#39; and &#39;pub_id_alias&#39;:</span>
<span class="sd">        - the &#39;hash_id_col_alias&#39; column contains the unique hash ID built for each publication </span>
<span class="sd">    through the `_my_hash` internal function on the basis of the values of</span>
<span class="sd">    &#39;year_alias&#39;, &#39;first_auth_alias&#39;, &#39;title_alias&#39;, &#39;issn_alias&#39; and &#39;doi_alias&#39;</span>
<span class="sd">    columns. </span>
<span class="sd">        - the &#39;pub_id_alias&#39; column contains the publication order number in the publications list.</span>
<span class="sd">    The dataframe is saved as Excel file which full path is given by &#39;hash_id_file_path&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        corpus_year (str): Contains the corpus year defined by 4 digits.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): End message recalling path to the saved file.        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting useful col names</span>
    <span class="n">col_rename_tup</span> <span class="o">=</span> <span class="n">build_col_conversion_dic</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">)</span>
    <span class="n">submit_col_rename_dic</span> <span class="o">=</span> <span class="n">col_rename_tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">bdd_mensuelle_alias</span>  <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;bdd mensuelle&quot;</span><span class="p">]</span>
    <span class="n">submit_file_alias</span>    <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;submit file name&quot;</span><span class="p">]</span>
    <span class="n">orphan_file_alias</span>    <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;orphan file name&quot;</span><span class="p">]</span>
    <span class="n">hash_id_file_alias</span>   <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;hash_id file name&quot;</span><span class="p">]</span>
    <span class="n">hash_id_col_alias</span>    <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_HASH</span><span class="p">[</span><span class="s1">&#39;hash_id&#39;</span><span class="p">]</span>
    <span class="n">pub_id_alias</span>         <span class="o">=</span> <span class="n">submit_col_rename_dic</span><span class="p">[</span><span class="s1">&#39;Pub_id&#39;</span><span class="p">]</span>
    <span class="n">year_alias</span>           <span class="o">=</span> <span class="n">submit_col_rename_dic</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span>
    <span class="n">first_auth_alias</span>     <span class="o">=</span> <span class="n">submit_col_rename_dic</span><span class="p">[</span><span class="s1">&#39;Authors&#39;</span><span class="p">]</span>
    <span class="n">title_alias</span>          <span class="o">=</span> <span class="n">submit_col_rename_dic</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">]</span>
    <span class="n">issn_alias</span>           <span class="o">=</span> <span class="n">submit_col_rename_dic</span><span class="p">[</span><span class="s1">&#39;ISSN&#39;</span><span class="p">]</span>
    <span class="n">doi_alias</span>            <span class="o">=</span> <span class="n">submit_col_rename_dic</span><span class="p">[</span><span class="s1">&#39;DOI&#39;</span><span class="p">]</span>

    <span class="c1"># Setting useful paths</span>
    <span class="n">corpus_year_path</span>   <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">corpus_year</span><span class="p">)</span>
    <span class="n">bdd_mensuelle_path</span> <span class="o">=</span> <span class="n">corpus_year_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">bdd_mensuelle_alias</span><span class="p">)</span>
    <span class="n">submit_file_path</span>   <span class="o">=</span> <span class="n">bdd_mensuelle_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">submit_file_alias</span><span class="p">)</span>
    <span class="n">orphan_file_path</span>   <span class="o">=</span> <span class="n">bdd_mensuelle_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">orphan_file_alias</span><span class="p">)</span>
    <span class="n">hash_id_file_path</span>  <span class="o">=</span> <span class="n">bdd_mensuelle_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">hash_id_file_alias</span><span class="p">)</span>

    <span class="c1"># Setting useful columns list</span>
    <span class="n">useful_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">pub_id_alias</span><span class="p">,</span> <span class="n">year_alias</span><span class="p">,</span> <span class="n">first_auth_alias</span><span class="p">,</span>
                   <span class="n">title_alias</span><span class="p">,</span> <span class="n">issn_alias</span><span class="p">,</span> <span class="n">doi_alias</span><span class="p">]</span>

    <span class="c1"># Getting dataframes to hash</span>
    <span class="n">submit_to_hash</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">submit_file_path</span><span class="p">,</span> <span class="n">usecols</span> <span class="o">=</span> <span class="n">useful_cols</span><span class="p">)</span>
    <span class="n">orphan_to_hash</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">orphan_file_path</span><span class="p">,</span> <span class="n">usecols</span> <span class="o">=</span> <span class="n">useful_cols</span><span class="p">)</span>

    <span class="c1"># Concatenate de dataframes to hash</span>
    <span class="n">dg_to_hash</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">submit_to_hash</span><span class="p">,</span> <span class="n">orphan_to_hash</span><span class="p">])</span>

    <span class="c1"># Dropping rows of same pub_id_alias and reindexing the rows using ignore_index</span>
    <span class="n">dg_to_hash</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">pub_id_alias</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">hash_id_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dg_to_hash</span><span class="p">)):</span>
        <span class="n">pub_id</span> <span class="o">=</span> <span class="n">dg_to_hash</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">pub_id_alias</span><span class="p">]</span>
        <span class="n">text</span>   <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dg_to_hash</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">year_alias</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dg_to_hash</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">first_auth_alias</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dg_to_hash</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">title_alias</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dg_to_hash</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">issn_alias</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dg_to_hash</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">doi_alias</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">hash_id</span> <span class="o">=</span> <span class="n">_my_hash</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">hash_id_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">hash_id_col_alias</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hash_id</span><span class="p">)</span>
        <span class="n">hash_id_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">pub_id_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">pub_id</span>

    <span class="n">hash_id_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">hash_id_file_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hash IDs of publications created and saved in file: </span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">hash_id_file_path</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">message</span>


<div class="viewcode-block" id="recursive_year_search">
<a class="viewcode-back" href="../../functions.html#bmfuncts.merge_pub_employees.recursive_year_search">[docs]</a>
<span class="k">def</span> <span class="nf">recursive_year_search</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">empl_df</span><span class="p">,</span> <span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span>
                          <span class="n">corpus_year</span><span class="p">,</span> <span class="n">search_depth</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_bar_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Searches in the employees database of the Institute the information for the authors </span>
<span class="sd">    of the publications of a corpus through the following steps:</span>
<span class="sd">        - First, the publications list dataframe with one row per Institute author for each </span>
<span class="sd">        publication is built from the results of the corpus parsing through </span>
<span class="sd">        the `_build_institute_pubs_authors` internal function.</span>
<span class="sd">        - After that, the &#39;submit_df&#39; dataframe of the publications list containing all matches </span>
<span class="sd">        between Institute authors and employee names is initialized using the most recent year </span>
<span class="sd">        of the employees database through the `_build_submit_df` internal function; </span>
<span class="sd">        this is done together with the initialization of &#39;orphan_df&#39; dataframe of the publications </span>
<span class="sd">        list with authors not found in the employees database; these two dataframes contains </span>
<span class="sd">        one row per author of each publication.</span>
<span class="sd">        - Then, new rows containing the information of authors that are PhD students </span>
<span class="sd">        at the Institute but not as employees of it are added through the `_add_ext_docs` </span>
<span class="sd">        internal function updating &#39;submit_df&#39; and &#39;orphan_df&#39; dataframes.</span>
<span class="sd">        - Then, new rows containing the information of authors that are under external hiring </span>
<span class="sd">        contract at the Institute are added through the `_add_other_ext` internal function </span>
<span class="sd">        updating &#39;submit_df&#39; and &#39;orphan_df&#39; dataframes.</span>
<span class="sd">        - Then, &#39;submit_df&#39; and &#39;orphan_df&#39; dataframes are updated by search in the employees </span>
<span class="sd">        database through the `_build_submit_df` internal function using recusively items from</span>
<span class="sd">        &#39;years&#39; list for the search year; the dataframes are saved as Excel files which full </span>
<span class="sd">        paths are given by &#39;submit_path&#39; and &#39;orphan_path&#39;, respectively.</span>
<span class="sd">        - Then, a new column containing the job type for each author is added in the file which </span>
<span class="sd">        full path is given by &#39;submit_path&#39; through the `_add_author_job_type` internal function.</span>
<span class="sd">        - Then, a new column containing the full reference of each publication is added </span>
<span class="sd">        in the file which full path is given by &#39;submit_path&#39; through the `_add_biblio_list` </span>
<span class="sd">        internal function.</span>
<span class="sd">        - Then, column names are changed in the two files which full path are given by </span>
<span class="sd">        respectively, &#39;submit_path&#39; and &#39;orphan_path&#39; through the `_change_col_names` internal </span>
<span class="sd">        function.</span>
<span class="sd">        - Finally, an Excel file containing the unique hash ID built for each publication </span>
<span class="sd">        is created through the `_creating_hash_id` internal function.</span>

<span class="sd">    Args:</span>
<span class="sd">        out_path (path): Full path to the folder for saving built dataframes. </span>
<span class="sd">        empl_df (dataframe): Hierarchical employees database keyyed by &#39;years&#39; list.</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        corpus_year (str): Contains the corpus year defined by 4 digits.</span>
<span class="sd">        search_depth (int): Depth for search in &#39;empl_df&#39; using &#39;years&#39; list.</span>
<span class="sd">        progress_callback (function): Function for updating ProgressBar </span>
<span class="sd">                                      tkinter widget status (default = None).</span>
<span class="sd">        progress_bar_state (int): Initial status of ProgressBar tkinter widget </span>
<span class="sd">                                  (default = None).</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        (tup): Tuple = (end_message (str), empty status (bool) of the publications </span>
<span class="sd">                        list with authors not found in the employees database)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Internal functions</span>
    <span class="k">def</span> <span class="nf">_unique_pub_id</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transforms the column &#39;Pub_id&#39; of df</span>
<span class="sd">        by adding &quot;yyyy_&quot; (year in 4 digits) to the values.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): data that we want to modify.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (pandas.DataFrame): df with its changed column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">year_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">year_col_alias</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">_rename_pub_id</span><span class="p">(</span><span class="n">old_pub_id</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
            <span class="n">pub_id_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">old_pub_id</span><span class="p">))</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pub_id_str</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">pub_id_str</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="n">pub_id_str</span>
            <span class="n">new_pub_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">pub_id_str</span>
            <span class="k">return</span> <span class="n">new_pub_id</span>

        <span class="n">df</span><span class="p">[</span><span class="n">pub_id_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">pub_id_alias</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_rename_pub_id</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">year_df</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">unknown_alias</span>          <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">UNKNOWN</span>
    <span class="n">year_col_alias</span>         <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;articles&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">pub_id_alias</span>           <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;pub_id&#39;</span><span class="p">]</span>
    <span class="n">submit_file_name_alias</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;submit file name&quot;</span><span class="p">]</span>
    <span class="n">orphan_file_name_alias</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;orphan file name&quot;</span><span class="p">]</span>
    <span class="n">orphan_treat_alias</span>     <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_ORPHAN</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span>
    <span class="n">adds_file_name_alias</span>   <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_ORPHAN</span><span class="p">[</span><span class="s2">&quot;employees adds file&quot;</span><span class="p">]</span>

    <span class="c1"># Setting useful paths</span>
    <span class="n">submit_path</span>   <span class="o">=</span> <span class="n">out_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">submit_file_name_alias</span><span class="p">)</span>
    <span class="n">orphan_path</span>   <span class="o">=</span> <span class="n">out_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">orphan_file_name_alias</span><span class="p">)</span>
    <span class="n">ext_docs_path</span> <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">orphan_treat_alias</span><span class="p">)</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">adds_file_name_alias</span><span class="p">)</span>
    <span class="n">others_path</span>   <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">orphan_treat_alias</span><span class="p">)</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">adds_file_name_alias</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">progress_bar_state</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="n">progress_bar_state</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Building the articles dataframe</span>
    <span class="n">pub_df</span> <span class="o">=</span> <span class="n">_build_institute_pubs_authors</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="n">progress_bar_state</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Building the search time depth of Institute co-authors among the employees dataframe</span>
    <span class="n">eff_available_years</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">empl_df</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">corpus_year_status</span> <span class="o">=</span> <span class="n">corpus_year</span> <span class="ow">in</span> <span class="n">eff_available_years</span>
    <span class="n">year_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">corpus_year</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">corpus_year_status</span> <span class="p">:</span>
        <span class="n">year_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">corpus_year</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">year_stop</span> <span class="o">=</span> <span class="n">year_start</span> <span class="o">-</span> <span class="p">(</span><span class="n">search_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_stop</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="n">progress_bar_state</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c1"># *******************************************************************</span>
    <span class="c1"># * Building recursively the `submit_df` and `orphan_df` dataframes *</span>
    <span class="c1"># *                 using `empl_df` files of years                   *</span>
    <span class="c1"># *******************************************************************</span>

    <span class="c1"># Initializing the dataframes to be built</span>
    <span class="c1"># a Data frame containing all matches between article Institute authors and employee names</span>
    <span class="n">submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="c1"># a Data frame containing containing article Institute authors</span>
    <span class="c1"># not matching with any employee name</span>
    <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Setting the test case selected within the following list</span>
    <span class="c1"># [&#39;Full match&#39;,</span>
    <span class="c1">#  &#39;Lower value similarity&#39;,</span>
    <span class="c1">#  &#39;Upper value similarity&#39;,</span>
    <span class="c1">#  &#39;No similarity&#39;,</span>
    <span class="c1">#  &#39;No test&#39;]</span>
    <span class="n">test_case</span> <span class="o">=</span> <span class="s1">&#39;Upper value similarity&#39;</span>

    <span class="c1"># Building the initial dataframes</span>
    <span class="n">submit_df</span><span class="p">,</span> <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">_build_submit_df</span><span class="p">(</span><span class="n">empl_df</span><span class="p">[</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                            <span class="n">pub_df</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span>
                                            <span class="n">test_case</span> <span class="o">=</span> <span class="n">test_case</span><span class="p">)</span>

    <span class="c1"># Saving initial files of submit_df and orphan_df</span>
    <span class="n">submit_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">orphan_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">orphan_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="n">progress_bar_state</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="c1"># Adding authors from list of external_phd students and saving new submit_df and orphan_df</span>
    <span class="n">submit_df</span><span class="p">,</span> <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">_add_ext_docs</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">orphan_path</span><span class="p">,</span> <span class="n">ext_docs_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="n">progress_bar_state</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">25</span><span class="p">)</span>

    <span class="c1"># Adding authors from list of external employees under other hiring contract</span>
    <span class="c1"># and saving new submit_df and orphan_df</span>
    <span class="n">submit_df</span><span class="p">,</span> <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">_add_other_ext</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">orphan_path</span><span class="p">,</span> <span class="n">others_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">new_progress_bar_state</span> <span class="o">=</span> <span class="n">progress_bar_state</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">30</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="n">new_progress_bar_state</span><span class="p">)</span>
        <span class="n">progress_bar_loop_progression</span> <span class="o">=</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">50</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">years</span><span class="p">):</span>
        <span class="c1"># Updating the dataframes submit_df_add and orphan_df</span>
        <span class="n">submit_df_add</span><span class="p">,</span> <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">_build_submit_df</span><span class="p">(</span><span class="n">empl_df</span><span class="p">[</span><span class="n">year</span><span class="p">],</span>
                                                    <span class="n">orphan_df</span><span class="p">,</span>
                                                    <span class="n">bibliometer_path</span><span class="p">,</span>
                                                    <span class="n">test_case</span><span class="p">)</span>

        <span class="c1"># Updating submit_df and orphan_df</span>
        <span class="n">submit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">submit_df</span><span class="p">,</span> <span class="n">submit_df_add</span><span class="p">])</span>

        <span class="c1"># Updating progress bar state</span>
        <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
            <span class="n">new_progress_bar_state</span> <span class="o">+=</span> <span class="n">progress_bar_loop_progression</span>
            <span class="n">progress_callback</span><span class="p">(</span><span class="n">new_progress_bar_state</span><span class="p">)</span>

    <span class="c1"># *************************************************************************************</span>
    <span class="c1"># * Saving results in &#39;submit_file_name_alias&#39; file and &#39;orphan_file_name_alias&#39; file *</span>
    <span class="c1"># *************************************************************************************</span>

    <span class="c1"># Replace NaN values by UNKNOWN string</span>
    <span class="n">submit_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">unknown_alias</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">orphan_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">unknown_alias</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">orphan_status</span> <span class="o">=</span> <span class="n">orphan_df</span><span class="o">.</span><span class="n">empty</span>

    <span class="c1"># Changing Pub_id columns to a unique Pub_id depending on the year</span>
    <span class="n">submit_df</span> <span class="o">=</span> <span class="n">_unique_pub_id</span><span class="p">(</span><span class="n">submit_df</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">orphan_status</span><span class="p">:</span>
        <span class="n">orphan_df</span> <span class="o">=</span> <span class="n">_unique_pub_id</span><span class="p">(</span><span class="n">orphan_df</span><span class="p">)</span>

    <span class="c1"># Saving orphan_df</span>
    <span class="n">orphan_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">orphan_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Saving submit_df</span>
    <span class="n">submit_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Adding author job type and saving new submit_df</span>
    <span class="n">_add_author_job_type</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">submit_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="n">new_progress_bar_state</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Adding full article reference and saving new submit_df</span>
    <span class="n">_add_biblio_list</span><span class="p">(</span><span class="n">submit_path</span><span class="p">,</span> <span class="n">submit_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="n">new_progress_bar_state</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Renaming column names using submit_col_rename_dic and orphan_col_rename_dic</span>
    <span class="n">_change_col_names</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">submit_path</span><span class="p">,</span> <span class="n">orphan_path</span><span class="p">)</span>

    <span class="c1"># Splitting orphan file in subdivisions of Institute</span>
    <span class="n">_split_orphan</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="n">new_progress_bar_state</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>

    <span class="c1"># Creating universal identification of articles independent of database extraction</span>
    <span class="n">_creating_hash_id</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="n">progress_callback</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">end_message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Results of search of authors in employees list &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;saved in folder: </span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">end_message</span><span class="p">,</span> <span class="n">orphan_status</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, BiblioMeter team, Liten, Leti, CEA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>