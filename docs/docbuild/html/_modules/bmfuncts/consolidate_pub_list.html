

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bmfuncts.consolidate_pub_list &mdash; BiblioMeter 5.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=ce74c6a2"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BiblioMeter
              <img src="../../_static/BM-logo.ico" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Description</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../description.html">BiblioMeter description</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GUI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gui.html">BiblioMeter <cite>bmgui</cite> package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../functions.html">BiblioMeter <cite>bmfuncts</cite> package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BiblioMeter</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bmfuncts.consolidate_pub_list</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bmfuncts.consolidate_pub_list</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module of functions for the consolidation of the publications-list </span>
<span class="sd">in terms of:</span>
<span class="sd">- effective affiliation of the authors to the Institute;</span>
<span class="sd">- attributing department affiliation to the Institute authors;</span>
<span class="sd">- reduction of homonyms among the Institute authors;</span>
<span class="sd">- attributing OTPs to each publication;</span>
<span class="sd">- attributing impact factor (IF) to each publication.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;add_if&#39;</span><span class="p">,</span>
           <span class="s1">&#39;add_otp&#39;</span><span class="p">,</span>
           <span class="s1">&#39;concatenate_pub_lists&#39;</span><span class="p">,</span>
           <span class="s1">&#39;built_final_pub_list&#39;</span><span class="p">,</span>
           <span class="s1">&#39;get_if_db&#39;</span><span class="p">,</span>
           <span class="s1">&#39;solving_homonyms&#39;</span><span class="p">,</span>
           <span class="s1">&#39;split_pub_list_by_doc_type&#39;</span><span class="p">,</span>
          <span class="p">]</span>


<span class="c1"># Standard library imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># 3rd party imports</span>
<span class="kn">import</span> <span class="nn">BiblioParsing</span> <span class="k">as</span> <span class="nn">bp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">openpyxl.worksheet.datavalidation</span> <span class="kn">import</span> <span class="n">DataValidation</span> \
    <span class="k">as</span> <span class="n">openpyxl_DataValidation</span>
<span class="kn">from</span> <span class="nn">openpyxl.utils</span> <span class="kn">import</span> <span class="n">get_column_letter</span> \
    <span class="k">as</span> <span class="n">openpyxl_get_column_letter</span>

<span class="c1"># Local imports</span>
<span class="kn">import</span> <span class="nn">bmfuncts.employees_globals</span> <span class="k">as</span> <span class="nn">eg</span>
<span class="kn">import</span> <span class="nn">bmfuncts.institute_globals</span> <span class="k">as</span> <span class="nn">ig</span>
<span class="kn">import</span> <span class="nn">bmfuncts.pub_globals</span> <span class="k">as</span> <span class="nn">pg</span>
<span class="kn">from</span> <span class="nn">bmfuncts.rename_cols</span> <span class="kn">import</span> <span class="n">set_homonym_col_names</span>
<span class="kn">from</span> <span class="nn">bmfuncts.rename_cols</span> <span class="kn">import</span> <span class="n">set_otp_col_names</span>
<span class="kn">from</span> <span class="nn">bmfuncts.rename_cols</span> <span class="kn">import</span> <span class="n">build_col_conversion_dic</span>
<span class="kn">from</span> <span class="nn">bmfuncts.rename_cols</span> <span class="kn">import</span> <span class="n">set_final_col_names</span>
<span class="kn">from</span> <span class="nn">bmfuncts.rename_cols</span> <span class="kn">import</span> <span class="n">set_if_col_names</span>
<span class="kn">from</span> <span class="nn">bmfuncts.save_final_results</span> <span class="kn">import</span> <span class="n">save_final_results</span>
<span class="kn">from</span> <span class="nn">bmfuncts.useful_functs</span> <span class="kn">import</span> <span class="n">mise_en_page</span>
<span class="kn">from</span> <span class="nn">bmfuncts.use_pub_attributes</span> <span class="kn">import</span> <span class="n">save_otps</span>
<span class="kn">from</span> <span class="nn">bmfuncts.use_pub_attributes</span> <span class="kn">import</span> <span class="n">save_shaped_homonyms_file</span>


<div class="viewcode-block" id="solving_homonyms">
<a class="viewcode-back" href="../../functions.html#bmfuncts.consolidate_pub_list.solving_homonyms">[docs]</a>
<span class="k">def</span> <span class="nf">solving_homonyms</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">in_path</span><span class="p">,</span> <span class="n">out_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates the file for homonyms solving by the user. </span>
<span class="sd">    First, a dataframe is built from specific columns </span>
<span class="sd">    of the list of publications merged with employees database </span>
<span class="sd">    given by the file pointed by &#39;in_path&#39; path.</span>
<span class="sd">    In this dataframe the homonyms are tagged by &#39;HOMONYM_FLAG&#39; </span>
<span class="sd">    global imported from `bmfuncts.pub_globals` module.</span>
<span class="sd">    Then this dataframe is saved as Excel file pointed </span>
<span class="sd">    by &#39;out_path&#39; path through `save_shaped_homonyms_file` </span>
<span class="sd">    function imported from `bmfuncts.use_pub_attributes` module.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): The Intitute name.</span>
<span class="sd">        org_tup (tup): The tuple of the organization structure of the Institute </span>
<span class="sd">                       used here to set column names for homonyms.</span>
<span class="sd">        in_path (path): The full path to the input file of list of publications </span>
<span class="sd">                        merged with employees database.</span>
<span class="sd">        out_path (path): The full path to the output file of homonyms solving </span>
<span class="sd">                         by the user.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tup): The tuple composed of end message (str) </span>
<span class="sd">               and homonyms status (bool; True if homonyms are found).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting useful column names</span>
    <span class="n">homonyms_col_dic</span> <span class="o">=</span> <span class="n">set_homonym_col_names</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">)</span>
    <span class="n">homonyms_col_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">homonyms_col_dic</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">homonym_col_alias</span> <span class="o">=</span> <span class="n">homonyms_col_dic</span><span class="p">[</span><span class="s1">&#39;homonym&#39;</span><span class="p">]</span>

    <span class="c1"># Reading the submit file #</span>
    <span class="n">df_submit</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span>

    <span class="c1"># Getting rid of the columns we don&#39;t want #</span>
    <span class="n">df_homonyms</span> <span class="o">=</span> <span class="n">df_submit</span><span class="p">[</span><span class="n">homonyms_col_list</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Setting homonyms status</span>
    <span class="n">homonyms_status</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">pg</span><span class="o">.</span><span class="n">HOMONYM_FLAG</span> <span class="ow">in</span> <span class="n">df_homonyms</span><span class="p">[</span><span class="n">homonym_col_alias</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
        <span class="n">homonyms_status</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Saving shaped df_homonyms</span>
    <span class="n">save_shaped_homonyms_file</span><span class="p">(</span><span class="n">df_homonyms</span><span class="p">,</span> <span class="n">out_path</span><span class="p">)</span>

    <span class="n">end_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;File for solving homonymies saved in folder: </span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">end_message</span><span class="p">,</span> <span class="n">homonyms_status</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_add_authors_name_list</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">in_path</span><span class="p">,</span> <span class="n">out_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The function `_add_authors_name_list` adds two columns to the dataframe got</span>
<span class="sd">    from the Excel file pointed by &#39;in_path&#39;.</span>
<span class="sd">    The columns contain respectively the full name of each author as &quot;NAME, Firstname&quot;</span>
<span class="sd">    and the institute co-authors list with attributes of each author as follows:</span>
<span class="sd">    &quot;NAME1, Firstame1 (matricule,job type,department affiliation,</span>
<span class="sd">                       service affiliation,laboratoire affiliation);</span>
<span class="sd">     NAME2, Firstame2 (matricule,job type,department affiliation,</span>
<span class="sd">                       service affiliation,laboratoire affiliation);</span>
<span class="sd">     ...&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): The Intitute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        in_path (path): Fullpath of the excel file of the publications list</span>
<span class="sd">                        with a row per Institute author and their attributes columns.</span>
<span class="sd">        out_path (path): Fullpath of the processed dataframe as an Excel file</span>
<span class="sd">                         saved after going through its treatment.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): End message recalling out_path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Internal functions</span>
    <span class="k">def</span> <span class="nf">_get_dpt_key</span><span class="p">(</span><span class="n">dpt_raw</span><span class="p">):</span>
        <span class="n">return_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">dpt_label_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">dpt_raw</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">return_key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">return</span> <span class="n">return_key</span>


    <span class="c1"># Setting institute parameters</span>
    <span class="n">dpt_label_dict</span> <span class="o">=</span> <span class="n">org_tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Setting useful column names</span>
    <span class="n">col_rename_tup</span> <span class="o">=</span> <span class="n">build_col_conversion_dic</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">)</span>
    <span class="n">bm_col_rename_dic</span> <span class="o">=</span> <span class="n">col_rename_tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">pub_id_alias</span>         <span class="o">=</span> <span class="n">bm_col_rename_dic</span><span class="p">[</span><span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;pub_id&#39;</span><span class="p">]]</span>
    <span class="n">idx_authors_alias</span>    <span class="o">=</span> <span class="n">bm_col_rename_dic</span><span class="p">[</span><span class="n">bp</span><span class="o">.</span><span class="n">COL_NAMES</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">nom_alias</span>            <span class="o">=</span> <span class="n">bm_col_rename_dic</span><span class="p">[</span><span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span>
    <span class="n">prenom_alias</span>         <span class="o">=</span> <span class="n">bm_col_rename_dic</span><span class="p">[</span><span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]]</span>
    <span class="n">matricule_alias</span>      <span class="o">=</span> <span class="n">bm_col_rename_dic</span><span class="p">[</span><span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;matricule&#39;</span><span class="p">]]</span>
    <span class="n">full_name_alias</span>      <span class="o">=</span> <span class="n">bm_col_rename_dic</span><span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BONUS</span><span class="p">[</span><span class="s1">&#39;nom prénom&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">institute</span><span class="p">]</span>
    <span class="n">author_type_alias</span>    <span class="o">=</span> <span class="n">bm_col_rename_dic</span><span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BONUS</span><span class="p">[</span><span class="s1">&#39;author_type&#39;</span><span class="p">]]</span>
    <span class="n">full_name_list_alias</span> <span class="o">=</span> <span class="n">bm_col_rename_dic</span><span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BONUS</span><span class="p">[</span><span class="s1">&#39;nom prénom liste&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">institute</span><span class="p">]</span>
    <span class="n">dept_alias</span>           <span class="o">=</span> <span class="n">bm_col_rename_dic</span><span class="p">[</span><span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;dpt&#39;</span><span class="p">]]</span>
    <span class="n">serv_alias</span>           <span class="o">=</span> <span class="n">bm_col_rename_dic</span><span class="p">[</span><span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;serv&#39;</span><span class="p">]]</span>
    <span class="n">lab_alias</span>            <span class="o">=</span> <span class="n">bm_col_rename_dic</span><span class="p">[</span><span class="n">eg</span><span class="o">.</span><span class="n">EMPLOYEES_USEFUL_COLS</span><span class="p">[</span><span class="s1">&#39;lab&#39;</span><span class="p">]]</span>

    <span class="c1"># Reading the excel file</span>
    <span class="n">df_in</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span>

    <span class="c1"># Adding the column &#39;full_name_alias&#39; that will be used to create the authors fullname list</span>
    <span class="n">df_in</span><span class="p">[</span><span class="n">prenom_alias</span><span class="p">]</span>    <span class="o">=</span> <span class="n">df_in</span><span class="p">[</span><span class="n">prenom_alias</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
    <span class="n">df_in</span><span class="p">[</span><span class="n">full_name_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_in</span><span class="p">[</span><span class="n">nom_alias</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">df_in</span><span class="p">[</span><span class="n">prenom_alias</span><span class="p">]</span>

    <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">pub_id_df</span> <span class="ow">in</span> <span class="n">df_in</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pub_id_alias</span><span class="p">):</span>

        <span class="n">authors_tup_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pub_id_df</span><span class="p">[</span><span class="n">idx_authors_alias</span><span class="p">],</span>
                                               <span class="n">pub_id_df</span><span class="p">[</span><span class="n">full_name_alias</span><span class="p">],</span>
                                               <span class="n">pub_id_df</span><span class="p">[</span><span class="n">matricule_alias</span><span class="p">],</span>
                                               <span class="n">pub_id_df</span><span class="p">[</span><span class="n">author_type_alias</span><span class="p">],</span>
                                               <span class="n">pub_id_df</span><span class="p">[</span><span class="n">dept_alias</span><span class="p">],</span>
                                               <span class="n">pub_id_df</span><span class="p">[</span><span class="n">serv_alias</span><span class="p">],</span>
                                               <span class="n">pub_id_df</span><span class="p">[</span><span class="n">lab_alias</span><span class="p">]))))</span>

        <span class="n">authors_str_list</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">,&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">_get_dpt_key</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">authors_tup_list</span><span class="p">]</span>
        <span class="n">authors_full_str</span> <span class="o">=</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">authors_str_list</span><span class="p">)</span>
        <span class="n">pub_id_df</span><span class="p">[</span><span class="n">full_name_list_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">authors_full_str</span>
        <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_out</span><span class="p">,</span> <span class="n">pub_id_df</span><span class="p">])</span>

    <span class="c1"># Saving &#39;df_out&#39; in an excel file &#39;out_path&#39;</span>
    <span class="n">df_out</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">end_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Column with co-authors list is added to the file: </span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="k">return</span> <span class="n">end_message</span>


<span class="k">def</span> <span class="nf">_save_dpt_otp_file</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">dpt</span><span class="p">,</span> <span class="n">dpt_df</span><span class="p">,</span> <span class="n">dpt_otp_list</span><span class="p">,</span>
                       <span class="n">otp_alias</span><span class="p">,</span> <span class="n">excel_dpt_path</span><span class="p">,</span> <span class="n">otp_col_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates the file for setting OTP attribute of publications by the user </span>
<span class="sd">    for the Institute department labelled &#39;dpt&#39;.     </span>
<span class="sd">    A new column named &#39;otp_alias&#39; is added to the dataframe &#39;dpt_df&#39;.</span>
<span class="sd">    A list data validation rules is added to each cells of the column</span>
<span class="sd">    &#39;otp_alias&#39; based on the list of OTPs of the department given </span>
<span class="sd">    by &#39;dpt_otp_list&#39; list.</span>
<span class="sd">    The dataframe columns are renamed using &#39;otp_col_list&#39;.</span>
<span class="sd">    Then the dataframe is saved as a formatted Excel file pointed </span>
<span class="sd">    by &#39;excel_dpt_path&#39; path through the `mise_en_page` function </span>
<span class="sd">    imported from `bmfuncts.useful_functs` module.</span>

<span class="sd">    Arg:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        dpt (str): Institute department.</span>
<span class="sd">        dpt_df (dataframe): The publications-list dataframe of the &#39;dpt&#39; department.</span>
<span class="sd">        dpt_otp_list (list): List of Institute departments (str).</span>
<span class="sd">        otp_alias (str): OTPs column name.</span>
<span class="sd">        excel_dpt_path (path): Full path to the file for setting publication OTP.  </span>
<span class="sd">        otp_col_list (list): Column names for rename of columns of the file created </span>
<span class="sd">                             for setting publications OTP.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Building validation list of OTPs for &#39;dpt&#39; department</span>
    <span class="n">validation_list</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dpt_otp_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
    <span class="n">data_val</span> <span class="o">=</span> <span class="n">openpyxl_DataValidation</span><span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span>
                                       <span class="n">formula1</span> <span class="o">=</span> <span class="n">validation_list</span><span class="p">,</span>
                                       <span class="n">showErrorMessage</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Adding a column containing OTPs of &#39;dpt&#39; department</span>
    <span class="n">dpt_df</span><span class="p">[</span><span class="n">otp_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_list</span>

    <span class="c1"># Renaming the columns</span>
    <span class="n">dpt_df</span> <span class="o">=</span> <span class="n">dpt_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">otp_col_list</span><span class="p">)</span>

    <span class="c1"># Formatting the EXCEL file</span>
    <span class="n">wb</span><span class="p">,</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">mise_en_page</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">dpt_df</span><span class="p">)</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">OTP_SHEET_NAME_BASE</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span>  <span class="n">dpt</span>

    <span class="c1"># Setting num of first col and first row in EXCEL files</span>
    <span class="n">excel_first_col_num</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">excel_first_row_num</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># Getting the column letter for the OTPs column</span>
    <span class="n">otp_alias_df_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dpt_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">otp_alias</span><span class="p">)</span>
    <span class="n">otp_alias_excel_index</span> <span class="o">=</span> <span class="n">otp_alias_df_index</span> <span class="o">+</span> <span class="n">excel_first_col_num</span>
    <span class="n">otp_alias_column_letter</span> <span class="o">=</span> <span class="n">openpyxl_get_column_letter</span><span class="p">(</span><span class="n">otp_alias_excel_index</span><span class="p">)</span>

    <span class="c1"># Activating the validation data list in all cells of the OTPs column</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dpt_df</span><span class="p">):</span>
        <span class="c1"># Adding a validation data list</span>
        <span class="n">ws</span><span class="o">.</span><span class="n">add_data_validation</span><span class="p">(</span><span class="n">data_val</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">df_index_row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dpt_df</span><span class="p">)):</span>
            <span class="n">otp_cell_alias</span> <span class="o">=</span> <span class="n">otp_alias_column_letter</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">df_index_row</span> <span class="o">+</span> <span class="n">excel_first_row_num</span><span class="p">)</span>
            <span class="n">data_val</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ws</span><span class="p">[</span><span class="n">otp_cell_alias</span><span class="p">])</span>

    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">excel_dpt_path</span><span class="p">)</span>


<div class="viewcode-block" id="add_otp">
<a class="viewcode-back" href="../../functions.html#bmfuncts.consolidate_pub_list.add_otp">[docs]</a>
<span class="k">def</span> <span class="nf">add_otp</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">in_path</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">out_file_base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates the files for setting OTP attribute of publications by the user </span>
<span class="sd">    for the Institute departments.</span>
<span class="sd">    First, useful columns are added to the dataframe got from the Excel file </span>
<span class="sd">    where homonyms have been solved by the user and pointed by &#39;in_path&#39; path </span>
<span class="sd">    through the `_add_authors_name_list` internal function.</span>
<span class="sd">    Then, for each department, a sub_dataframe is extracted selecting rows  </span>
<span class="sd">    of publications where at least one author is affiliated to the department.</span>
<span class="sd">    Each sub-dataframe is saved through the `_save_dpt_otp_file` internal function.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        in_path (path): Full path to the file where homonyms have been solved.</span>
<span class="sd">        out_path (path): Full path to the files for setting OTPs attributes by the user.</span>
<span class="sd">        out_file_base (str): Base for building created-files names.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): end message recalling out_path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Internal functions</span>
    <span class="k">def</span> <span class="nf">_set_dpt</span><span class="p">(</span><span class="n">dpt_label_list</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dpt_label_list</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># Setting institute parameters</span>
    <span class="n">dpt_attributs_dict</span> <span class="o">=</span> <span class="n">org_tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Setting useful column names</span>
    <span class="n">otp_col_dic</span> <span class="o">=</span> <span class="n">set_otp_col_names</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">)</span>
    <span class="n">otp_col_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">otp_col_dic</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">pub_id_alias</span>     <span class="o">=</span> <span class="n">otp_col_dic</span><span class="p">[</span><span class="s1">&#39;pub_id&#39;</span><span class="p">]</span>
    <span class="n">idx_author_alias</span> <span class="o">=</span> <span class="n">otp_col_dic</span><span class="p">[</span><span class="s1">&#39;author_id&#39;</span><span class="p">]</span>
    <span class="n">dpt_alias</span>        <span class="o">=</span> <span class="n">otp_col_dic</span><span class="p">[</span><span class="s1">&#39;dpt&#39;</span><span class="p">]</span>
    <span class="n">otp_alias</span>        <span class="o">=</span> <span class="n">otp_col_dic</span><span class="p">[</span><span class="s1">&#39;otp_list&#39;</span><span class="p">]</span>
    <span class="n">dpt_label_alias</span>  <span class="o">=</span> <span class="n">ig</span><span class="o">.</span><span class="n">DPT_LABEL_KEY</span>
    <span class="n">dpt_otp_alias</span>    <span class="o">=</span> <span class="n">ig</span><span class="o">.</span><span class="n">DPT_OTP_KEY</span>

    <span class="c1"># Adding a column with a list of the authors in the file where homonymies</span>
    <span class="c1"># have been solved and pointed by in_path</span>
    <span class="n">end_message</span> <span class="o">=</span> <span class="n">_add_authors_name_list</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">in_path</span><span class="p">,</span> <span class="n">in_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="p">,</span><span class="n">end_message</span><span class="p">)</span>

    <span class="n">solved_homonymies_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span>
    <span class="n">solved_homonymies_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">dpt_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dpt_attributs_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># For each department adding a column containing 1 or 0</span>
    <span class="c1"># depending on if the author belongs or not to the department</span>
    <span class="k">for</span> <span class="n">dpt</span> <span class="ow">in</span> <span class="n">dpt_list</span><span class="p">:</span>
        <span class="n">dpt_label_list</span> <span class="o">=</span> <span class="n">dpt_attributs_dict</span><span class="p">[</span><span class="n">dpt</span><span class="p">][</span><span class="n">dpt_label_alias</span><span class="p">]</span>
        <span class="n">solved_homonymies_df</span><span class="p">[</span><span class="n">dpt</span><span class="p">]</span> <span class="o">=</span> <span class="n">solved_homonymies_df</span><span class="p">[</span><span class="n">dpt_alias</span><span class="p">]</span>
        <span class="n">solved_homonymies_df</span><span class="p">[</span><span class="n">dpt</span><span class="p">]</span> <span class="o">=</span> <span class="n">solved_homonymies_df</span><span class="p">[</span><span class="n">dpt</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_set_dpt</span><span class="p">(</span><span class="n">dpt_label_list</span><span class="p">))</span>

    <span class="c1"># Building &#39;df_out&#39; out of &#39;solved_homonymies_df&#39; with a row per pub_id</span>
    <span class="c1"># 1 or 0 is assigned to each department column depending</span>
    <span class="c1"># on if at least one co-author is a member of this department,</span>
    <span class="c1"># the detailed information is related to the first author only</span>
    <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dg</span> <span class="ow">in</span> <span class="n">solved_homonymies_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pub_id_alias</span><span class="p">):</span>
        <span class="n">dg</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx_author_alias</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">dpt</span> <span class="ow">in</span> <span class="n">dpt_list</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">dg</span><span class="p">[</span><span class="n">dpt</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">dg</span><span class="p">[</span><span class="n">dpt</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_out</span><span class="p">,</span> <span class="n">dg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">1</span><span class="p">]])</span>

    <span class="c1"># Configuring an Excel file per department with the list of OTPs</span>
    <span class="k">for</span> <span class="n">dpt</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dpt_list</span><span class="p">):</span>
        <span class="c1"># Setting df_dpt with only pub_ids for which the first author</span>
        <span class="c1"># is from the &#39;dpt&#39; department</span>
        <span class="n">filtre_dpt</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">dpt_value</span> <span class="ow">in</span> <span class="n">dpt_attributs_dict</span><span class="p">[</span><span class="n">dpt</span><span class="p">][</span><span class="n">dpt_label_alias</span><span class="p">]:</span>
            <span class="n">filtre_dpt</span> <span class="o">=</span> <span class="n">filtre_dpt</span> <span class="o">|</span> <span class="p">(</span><span class="n">df_out</span><span class="p">[</span><span class="n">dpt_alias</span><span class="p">]</span> <span class="o">==</span> <span class="n">dpt_value</span><span class="p">)</span>
        <span class="n">df_dpt</span> <span class="o">=</span> <span class="n">df_out</span><span class="p">[</span><span class="n">filtre_dpt</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Setting the list of OTPs for the &#39;dpt&#39; department</span>
        <span class="n">dpt_otp_list</span> <span class="o">=</span> <span class="n">dpt_attributs_dict</span><span class="p">[</span><span class="n">dpt</span><span class="p">][</span><span class="n">dpt_otp_alias</span><span class="p">]</span>

        <span class="c1"># Setting the full path of the EXCEl file for the &#39;dpt&#39; department</span>
        <span class="n">otp_file_name_dpt</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">out_file_base</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">dpt</span><span class="si">}</span><span class="s1">.xlsx&#39;</span>
        <span class="n">excel_dpt_path</span>    <span class="o">=</span> <span class="n">out_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">otp_file_name_dpt</span><span class="p">)</span>

        <span class="c1"># Adding a column with validation list for OTPs and saving the file</span>
        <span class="n">_save_dpt_otp_file</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">dpt</span><span class="p">,</span> <span class="n">df_dpt</span><span class="p">,</span> <span class="n">dpt_otp_list</span><span class="p">,</span>
                           <span class="n">otp_alias</span><span class="p">,</span> <span class="n">excel_dpt_path</span><span class="p">,</span> <span class="n">otp_col_list</span><span class="p">)</span>

    <span class="n">end_message</span>  <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Files for setting publication OTPs per department &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;saved in folder: </span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">end_message</span></div>



<span class="k">def</span> <span class="nf">_create_if_column</span><span class="p">(</span><span class="n">issn_column</span><span class="p">,</span> <span class="n">if_dict</span><span class="p">,</span> <span class="n">if_empty_word</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_create_if_column` builds a dataframe column &#39;if_column&#39;</span>
<span class="sd">    using the column &#39;issn_column&#39; of this dataframe and the dict &#39;if_dict&#39;</span>
<span class="sd">    that make the link between ISSNs (&#39;if_dict&#39; keys) and IFs (&#39;if_dict&#39; values).</span>
<span class="sd">    The &#39;nan&#39; values in the column &#39;if_column&#39; are replaced by &#39;empty_word&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        issn_column (pandas serie): The column of the dataframe of interest</span>
<span class="sd">                                    that contains the ISSNs values.</span>
<span class="sd">        if_dict (dict): The dict which keys are ISSNs and values are IFs.</span>
<span class="sd">        if_empty_word (str): The word that will replace nan values in </span>
<span class="sd">                             the returned column.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (pandas serie): The column of the dataframe of interest</span>
<span class="sd">                        that contains the IFs values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">if_column</span> <span class="o">=</span> <span class="n">issn_column</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">if_dict</span><span class="p">)</span>
    <span class="n">if_column</span> <span class="o">=</span> <span class="n">if_column</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">if_empty_word</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">if_column</span>


<span class="k">def</span> <span class="nf">_build_inst_issn_df</span><span class="p">(</span><span class="n">if_db_df</span><span class="p">,</span> <span class="n">use_col_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_build_inst_issn_df` builds a dataframe of &#39;use_col_list&#39; columns </span>
<span class="sd">    composed of journal name, ISSN and eISSN.</span>
<span class="sd">    First, a subset dataframe is built from the hierarchical dataframe &#39;if_db_df&#39;</span>
<span class="sd">    using &#39;use_col_list&#39; columns for each year (key of &#39;if_db_df&#39;).</span>
<span class="sd">    Then, a single dataframe results from concatenation of these dataframes.</span>
<span class="sd">    Finally, duplicates are dropped after setting unique ISSN and eISSN values </span>
<span class="sd">    for each journal name.</span>

<span class="sd">    Args:</span>
<span class="sd">        if_db_df (dataframe): Hierarchical dataframe of impact-factors database </span>
<span class="sd">                              keyyed by years.</span>
<span class="sd">        use_col_list (list): List of subset columns names </span>
<span class="sd">                             of &#39;if_db_df[&lt;year&gt;]&#39; dataframes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dataframe): Dataframe with &#39;use_col_list&#39; columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">journal_col_alias</span> <span class="o">=</span> <span class="n">use_col_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">issn_col_alias</span>    <span class="o">=</span> <span class="n">use_col_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">eissn_col_alias</span>   <span class="o">=</span> <span class="n">use_col_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">unknown_alias</span>     <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">UNKNOWN</span>

    <span class="n">years_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">if_db_df</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">init_inst_issn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">use_col_list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years_list</span><span class="p">:</span>
        <span class="n">year_sub_df</span> <span class="o">=</span> <span class="n">if_db_df</span><span class="p">[</span><span class="n">year</span><span class="p">][</span><span class="n">use_col_list</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">init_inst_issn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">init_inst_issn_df</span><span class="p">,</span> <span class="n">year_sub_df</span><span class="p">])</span>
    <span class="n">init_inst_issn_df</span><span class="p">[</span><span class="n">journal_col_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_inst_issn_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span>
                                                                   <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">journal_col_alias</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span>
                                                                   <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">inst_issn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="p">,</span> <span class="n">dg</span> <span class="ow">in</span> <span class="n">init_inst_issn_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">journal_col_alias</span><span class="p">):</span>

        <span class="n">issn_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dg</span><span class="p">[</span><span class="n">issn_col_alias</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span> <span class="o">-</span> <span class="p">{</span><span class="n">unknown_alias</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">issn_list</span><span class="p">:</span>
            <span class="n">issn_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">unknown_alias</span><span class="p">]</span>
        <span class="n">dg</span><span class="p">[</span><span class="n">issn_col_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">issn_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">eissn_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dg</span><span class="p">[</span><span class="n">eissn_col_alias</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span> <span class="o">-</span> <span class="p">{</span><span class="n">unknown_alias</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eissn_list</span><span class="p">:</span>
            <span class="n">eissn_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">unknown_alias</span><span class="p">]</span>
        <span class="n">dg</span><span class="p">[</span><span class="n">eissn_col_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">eissn_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">inst_issn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">inst_issn_df</span><span class="p">,</span><span class="n">dg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">1</span><span class="p">]])</span>

    <span class="n">inst_issn_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="n">journal_col_alias</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">inst_issn_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inst_issn_df</span>


<span class="k">def</span> <span class="nf">_fullfill_issn</span><span class="p">(</span><span class="n">corpus_df</span><span class="p">,</span> <span class="n">issn_df</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">col_tup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_fullfill_issn` fills the unknown values </span>
<span class="sd">    in the &#39;issn_col&#39; column in the &#39;corpus_df&#39; dataframe, </span>
<span class="sd">    using the ISSN or eISSN&#39; available in the &#39;issn_df&#39; dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        corpus_df (dataframe): Corpus of publications to be updated.</span>
<span class="sd">        issn_df (dataframe): Data of journals with their ISSN and eISSN.</span>
<span class="sd">        unknown (str): Value of unknown ISSN or eISSN.</span>
<span class="sd">        col_tup (tup): Tuple of columns names = (journal name, ISSN, eISSN).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dataframe): Updated dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting parameters from args</span>
    <span class="n">journal_col</span><span class="p">,</span> <span class="n">issn_col</span><span class="p">,</span> <span class="n">eissn_col</span> <span class="o">=</span> <span class="n">col_tup</span>

    <span class="k">for</span> <span class="n">corpus_idx</span><span class="p">,</span> <span class="n">corpus_row</span> <span class="ow">in</span> <span class="n">corpus_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">corpus_row</span><span class="p">[</span><span class="n">issn_col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">unknown</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">corpus_journal</span> <span class="o">=</span> <span class="n">corpus_row</span><span class="p">[</span><span class="n">journal_col</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">issn_row</span> <span class="ow">in</span> <span class="n">issn_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">issn_journal</span> <span class="o">=</span> <span class="n">issn_row</span><span class="p">[</span><span class="n">journal_col</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">corpus_journal</span> <span class="o">!=</span> <span class="n">issn_journal</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">issn_row</span><span class="p">[</span><span class="n">issn_col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">unknown</span><span class="p">:</span>
                <span class="n">corpus_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corpus_idx</span><span class="p">,</span> <span class="n">issn_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">issn_row</span><span class="p">[</span><span class="n">issn_col</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">issn_row</span><span class="p">[</span><span class="n">eissn_col</span><span class="p">]</span> <span class="o">!=</span> <span class="n">unknown</span><span class="p">:</span>
                <span class="n">corpus_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">corpus_idx</span><span class="p">,</span> <span class="n">issn_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">issn_row</span><span class="p">[</span><span class="n">eissn_col</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="n">corpus_df</span>


<span class="k">def</span> <span class="nf">_build_if_dict</span><span class="p">(</span><span class="n">if_df</span><span class="p">,</span> <span class="n">if_year</span><span class="p">,</span> <span class="n">args_tup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_build_if_dict` builds a dict keyyed by ISSN or eISSN values</span>
<span class="sd">    and valued by impact factors.</span>

<span class="sd">    Args:</span>
<span class="sd">        if_df (dataframe): Database of impact-factors.</span>
<span class="sd">        if_year (str): 4 digits-year key for using values from the database </span>
<span class="sd">                       of impact-factors.</span>
<span class="sd">        args_tup (tup): Tuple = (value of unknown ISSN or eISSN,</span>
<span class="sd">                        ISSN-column name, eISSN-column name, impact-factors-column name).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dict): dict keyyed by ISSN (str) or eISSN (str) values </span>
<span class="sd">                and valued by impact factors (float).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting parameters from args</span>
    <span class="n">unknown</span><span class="p">,</span> <span class="n">issn_col</span><span class="p">,</span> <span class="n">eissn_col</span><span class="p">,</span> <span class="n">if_col</span> <span class="o">=</span> <span class="n">args_tup</span>

    <span class="n">issn_if_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">if_df</span><span class="p">[</span><span class="n">if_year</span><span class="p">][</span><span class="n">issn_col</span><span class="p">],</span>
                            <span class="n">if_df</span><span class="p">[</span><span class="n">if_year</span><span class="p">][</span><span class="n">if_col</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">unknown</span> <span class="ow">in</span> <span class="n">issn_if_dict</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">issn_if_dict</span><span class="p">[</span><span class="n">unknown</span><span class="p">]</span>
    <span class="n">eissn_if_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">eissn_col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">if_df</span><span class="p">[</span><span class="n">if_year</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">eissn_if_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">if_df</span><span class="p">[</span><span class="n">if_year</span><span class="p">][</span><span class="n">eissn_col</span><span class="p">],</span>
                                 <span class="n">if_df</span><span class="p">[</span><span class="n">if_year</span><span class="p">][</span><span class="n">if_col</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">unknown</span> <span class="ow">in</span> <span class="n">eissn_if_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">eissn_if_dict</span><span class="p">[</span><span class="n">unknown</span><span class="p">]</span>
    <span class="n">if_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">issn_if_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">eissn_if_dict</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">if_dict</span>


<span class="k">def</span> <span class="nf">_get_id</span><span class="p">(</span><span class="n">issn_df</span><span class="p">,</span> <span class="n">journal_name</span><span class="p">,</span> <span class="n">journal_col</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">unknown</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_get_id` sets a unique journal name </span>
<span class="sd">    for the ISSN value at &#39;journal_name&#39; key in &#39;issn_df&#39; dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        issn_df (dataframe): Data of journals with their ISSN and eISSN.</span>
<span class="sd">        journal_name (str): Name of journal for which the unique name will be defined.</span>
<span class="sd">        journal_col (str): Name of the journal-names column in the &#39;issn_df&#39; dataframe.</span>
<span class="sd">        id_col (str): Name of the ISSN or eISSN column to be used in the &#39;issn_df&#39; dataframe.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str): Unified journal name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting parameters from args</span>
    <span class="n">id_lower_df</span> <span class="o">=</span> <span class="n">issn_df</span><span class="p">[</span><span class="n">issn_df</span><span class="p">[</span><span class="n">journal_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">journal_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="n">id_col</span><span class="p">]</span>
    <span class="n">id_lower</span> <span class="o">=</span> <span class="n">unknown</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">id_lower_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">id_lower</span> <span class="o">=</span> <span class="n">id_lower_df</span><span class="o">.</span><span class="n">to_list</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">id_upper_df</span> <span class="o">=</span> <span class="n">issn_df</span><span class="p">[</span><span class="n">issn_df</span><span class="p">[</span><span class="n">journal_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">journal_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">id_col</span><span class="p">]</span>
    <span class="n">id_upper</span> <span class="o">=</span> <span class="n">unknown</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">id_upper_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">id_upper</span> <span class="o">=</span> <span class="n">id_upper_df</span><span class="o">.</span><span class="n">to_list</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">journal_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">id_lower</span><span class="p">,</span><span class="n">id_upper</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">unknown</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">journal_id</span>


<span class="k">def</span> <span class="nf">_format_missing_df</span><span class="p">(</span><span class="n">results_df</span><span class="p">,</span> <span class="n">common_args_tup</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">add_cols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `_format_missing_df` formats the &#39;results_df&#39; dataframe </span>
<span class="sd">    with final column names.</span>

<span class="sd">    Args:</span>
<span class="sd">        results_df (dataframe): Corpus of publications to be updated.</span>
<span class="sd">        common_args_tup (tup): Tuple of columns name (str) = (year (4 digits),</span>
<span class="sd">                               corpus-year impact-factor, impact-factors most-recent year,</span>
<span class="sd">                               journal-name, ISSN, eISNN, number of publications, </span>
<span class="sd">                               impact-factors year, ISSN in &#39;result_df&#39; dataframe).</span>
<span class="sd">        unknown (str): Value of unknown ISSN or eISSN in &#39;results_df&#39; dataframe.</span>
<span class="sd">        add_cols (bool): True if suplementary columns for ISSN and eISSN </span>
<span class="sd">                         are to be filled with unknown values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dataframe): Formatted dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">year_col</span><span class="p">,</span> <span class="n">corpus_year_if_col</span><span class="p">,</span>
     <span class="n">most_recent_year_if_col</span><span class="p">,</span>
     <span class="n">journal_col</span><span class="p">,</span> <span class="n">issn_col</span><span class="p">,</span> <span class="n">eissn_col</span><span class="p">,</span>
     <span class="n">pub_id_nb_col</span><span class="p">,</span> <span class="n">year_db_if_col</span><span class="p">,</span>
     <span class="n">corpus_issn_col</span><span class="p">)</span> <span class="o">=</span> <span class="n">common_args_tup</span>

    <span class="c1"># Setting final year column</span>
    <span class="n">final_year_col</span> <span class="o">=</span> <span class="n">year_col</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>

    <span class="c1"># Setting the ordered final columns</span>
    <span class="n">final_order_col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">final_year_col</span><span class="p">,</span> <span class="n">journal_col</span><span class="p">,</span>
                            <span class="n">issn_col</span><span class="p">,</span> <span class="n">eissn_col</span><span class="p">,</span>
                            <span class="n">most_recent_year_if_col</span><span class="p">,</span>
                            <span class="n">year_db_if_col</span><span class="p">,</span>
                            <span class="n">pub_id_nb_col</span><span class="p">,</span>
                            <span class="n">corpus_issn_col</span><span class="p">]</span>

    <span class="c1"># Formatting &#39;results_df&#39;</span>
    <span class="n">results_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">year_col</span>           <span class="p">:</span> <span class="n">final_year_col</span><span class="p">,</span>
                                 <span class="n">corpus_year_if_col</span> <span class="p">:</span> <span class="n">year_db_if_col</span><span class="p">},</span>
                      <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">add_cols</span><span class="p">:</span>
        <span class="n">results_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">issn_col</span> <span class="p">:</span> <span class="n">corpus_issn_col</span><span class="p">},</span>
                          <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">results_df</span><span class="p">[</span><span class="n">issn_col</span><span class="p">]</span>  <span class="o">=</span> <span class="n">unknown</span>
        <span class="n">results_df</span><span class="p">[</span><span class="n">eissn_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">unknown</span>
        <span class="n">results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="n">final_order_col_list</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">results_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">results_df</span><span class="p">[</span><span class="n">eissn_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">unknown</span>
        <span class="n">results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="n">final_order_col_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">sorted_results_df</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="n">journal_col</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sorted_results_df</span>


<div class="viewcode-block" id="get_if_db">
<a class="viewcode-back" href="../../functions.html#bmfuncts.consolidate_pub_list.get_if_db">[docs]</a>
<span class="k">def</span> <span class="nf">get_if_db</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `get_if_db` builds a dataframe of impact-factors</span>
<span class="sd">    of the Institute.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tup): Tuple = (impact-factors (dataframe), </span>
<span class="sd">                        available-years of impact-factors in the dataframe (list),</span>
<span class="sd">                        most-recent year of available impact-factors (4-digits str)).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Setting institute parameters</span>
    <span class="n">if_db_status</span> <span class="o">=</span> <span class="n">org_tup</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">if_root_folder_alias</span>   <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_IF</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span>
    <span class="n">if_filename_alias</span>      <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_IF</span><span class="p">[</span><span class="s2">&quot;all IF&quot;</span><span class="p">]</span>
    <span class="n">inst_if_filename_alias</span> <span class="o">=</span> <span class="n">institute</span> <span class="o">+</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_IF</span><span class="p">[</span><span class="s2">&quot;institute_if_all_years&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">if_db_status</span><span class="p">:</span>
        <span class="n">if_filename_alias</span> <span class="o">=</span> <span class="n">inst_if_filename_alias</span>

    <span class="c1"># Setting useful paths</span>
    <span class="n">if_root_folder_path</span> <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">if_root_folder_alias</span><span class="p">)</span>
    <span class="n">if_path</span>             <span class="o">=</span> <span class="n">if_root_folder_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">if_filename_alias</span><span class="p">)</span>

    <span class="c1"># Getting the df of the IFs database</span>
    <span class="n">if_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">if_path</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Setting list of years for which IF are available</span>
    <span class="n">if_available_years_list</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">if_df</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Setting the most recent year for which IF are available</span>
    <span class="n">if_most_recent_year</span> <span class="o">=</span> <span class="n">if_available_years_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">if_df</span><span class="p">,</span> <span class="n">if_available_years_list</span><span class="p">,</span> <span class="n">if_most_recent_year</span></div>



<div class="viewcode-block" id="add_if">
<a class="viewcode-back" href="../../functions.html#bmfuncts.consolidate_pub_list.add_if">[docs]</a>
<span class="k">def</span> <span class="nf">add_if</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">paths_tup</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot; The function `add_if` adds two new columns containing impact factors </span>
<span class="sd">    to the corpus dataframe &#39;corpus_df&#39; got from a file which full path </span>
<span class="sd">    is &#39;in_file_path&#39;.</span>
<span class="sd">    The two columns are named through &#39;corpus_year_if_col_alias&#39; </span>
<span class="sd">    and &#39;most_recent_year_if_col&#39;.</span>
<span class="sd">    The impact factors are got using `get_if_db` function that returns </span>
<span class="sd">    in particular the dataframe &#39;if_df&#39; of impact-factors database.</span>
<span class="sd">    The column &#39;corpus_year_if_col_alias&#39; is filled with the impact-factors </span>
<span class="sd">    values of the corpus year &#39;corpus_year&#39; if available in the dataframe &#39;if_df&#39;, </span>
<span class="sd">    otherwise the values are set to &#39;not_available_if_alias&#39; value.</span>
<span class="sd">    The column &#39;most_recent_year_if_col&#39; is filled with the impact-factors </span>
<span class="sd">    values of the most recent year available in the dataframe &#39;if_df&#39;.</span>
<span class="sd">    In these columns, the NaN values of impact-factors are replaced </span>
<span class="sd">    by &#39;unknown_if_fill_alias&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        paths_tup (tup): Tuple = (full path to get the corpus dataframe &#39;corpus_df&#39;, </span>
<span class="sd">                         full path to save the missing impact-factors information, </span>
<span class="sd">                         full path to save the missing ISSNs information, </span>
<span class="sd">                         year (4 digits str) of the corpus to be appended with the two </span>
<span class="sd">                         new impact-factors columns).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tup): Tuple = (message indicating which file has been mofified and how,</span>
<span class="sd">                        completion status of the impact-factors database).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Setting parameters from args</span>
    <span class="p">(</span><span class="n">in_file_path</span><span class="p">,</span> <span class="n">out_file_path</span><span class="p">,</span>
     <span class="n">missing_if_path</span><span class="p">,</span> <span class="n">missing_issn_path</span><span class="p">)</span> <span class="o">=</span> <span class="n">paths_tup</span>
    
    <span class="c1"># Setting useful column names</span>
    <span class="n">final_col_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">set_final_col_names</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">)</span>
    <span class="n">base_col_list</span>    <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_col_dic</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">if_maj_col_dic</span>   <span class="o">=</span> <span class="n">set_if_col_names</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">)</span>

    <span class="c1"># Setting useful column aliases</span>
    <span class="n">pub_id_col_alias</span>         <span class="o">=</span> <span class="n">final_col_dic</span><span class="p">[</span><span class="s1">&#39;pub_id&#39;</span><span class="p">]</span>
    <span class="n">year_col_alias</span>           <span class="o">=</span> <span class="n">final_col_dic</span><span class="p">[</span><span class="s1">&#39;corpus_year&#39;</span><span class="p">]</span>
    <span class="n">journal_col_alias</span>        <span class="o">=</span> <span class="n">final_col_dic</span><span class="p">[</span><span class="s1">&#39;journal&#39;</span><span class="p">]</span>
    <span class="n">doctype_col_alias</span>        <span class="o">=</span> <span class="n">final_col_dic</span><span class="p">[</span><span class="s1">&#39;doc_type&#39;</span><span class="p">]</span>
    <span class="n">issn_col_alias</span>           <span class="o">=</span> <span class="n">final_col_dic</span><span class="p">[</span><span class="s1">&#39;issn&#39;</span><span class="p">]</span>
    <span class="n">otp_col_alias</span>            <span class="o">=</span> <span class="n">final_col_dic</span><span class="p">[</span><span class="s1">&#39;otp&#39;</span><span class="p">]</span>
    <span class="n">current_if_col_alias</span>     <span class="o">=</span> <span class="n">if_maj_col_dic</span><span class="p">[</span><span class="s1">&#39;current_if&#39;</span><span class="p">]</span>
    <span class="n">corpus_year_if_col_alias</span> <span class="o">=</span> <span class="n">if_maj_col_dic</span><span class="p">[</span><span class="s1">&#39;pub_year_if&#39;</span><span class="p">]</span>
    <span class="n">corpus_issn_col_alias</span>    <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BONUS</span><span class="p">[</span><span class="s2">&quot;database ISSN&quot;</span><span class="p">]</span>
    <span class="n">database_if_col_alias</span>    <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BONUS</span><span class="p">[</span><span class="s1">&#39;IF clarivate&#39;</span><span class="p">]</span>
    <span class="n">eissn_col_alias</span>          <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BONUS</span><span class="p">[</span><span class="s1">&#39;e-ISSN&#39;</span><span class="p">]</span>
    <span class="n">otp_col_new_alias</span>        <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BONUS</span><span class="p">[</span><span class="s1">&#39;final OTP&#39;</span><span class="p">]</span>
    <span class="n">pub_id_nb_col_alias</span>      <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">COL_NAMES_BONUS</span><span class="p">[</span><span class="s1">&#39;pub number&#39;</span><span class="p">]</span>

    <span class="c1"># Setting globals aliases</span>
    <span class="n">doc_type_dict_alias</span>       <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">DOC_TYPE_DICT</span>
    <span class="n">not_available_if_alias</span>    <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">NOT_AVAILABLE_IF</span>
    <span class="n">unknown_if_fill_alias</span>     <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">FILL_EMPTY_KEY_WORD</span>
    <span class="n">unknown_alias</span>             <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">FILL_EMPTY_KEY_WORD</span>
    <span class="n">outside_if_analysis_alias</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">OUTSIDE_ANALYSIS</span>
    
    <span class="c1"># Setting tuples for passing args</span>
    <span class="n">col_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">journal_col_alias</span><span class="p">,</span> <span class="n">issn_col_alias</span><span class="p">,</span> <span class="n">eissn_col_alias</span><span class="p">)</span>
    <span class="n">aliases_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">unknown_alias</span><span class="p">,</span> <span class="n">issn_col_alias</span><span class="p">,</span> <span class="n">eissn_col_alias</span><span class="p">,</span> <span class="n">database_if_col_alias</span><span class="p">)</span>

    <span class="c1"># Setting institute parameters</span>
    <span class="n">if_db_status</span>            <span class="o">=</span> <span class="n">org_tup</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">no_if_doctype_keys_list</span> <span class="o">=</span> <span class="n">org_tup</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

    <span class="c1"># Setting list of document types to drop</span>
    <span class="n">no_if_doctype</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">doc_type_dict_alias</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">no_if_doctype_keys_list</span><span class="p">]</span> <span class="p">,</span> <span class="p">[])</span>
    <span class="n">doctype_to_drop_list_alias</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">no_if_doctype</span><span class="p">]</span>

    <span class="c1"># Getting the df of the IFs database</span>
    <span class="n">if_df</span><span class="p">,</span> <span class="n">if_available_years_list</span><span class="p">,</span> <span class="n">if_most_recent_year</span> <span class="o">=</span> <span class="n">get_if_db</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span>
                                                                    <span class="n">bibliometer_path</span><span class="p">)</span>

    <span class="c1"># Taking care all IF column names in if_df are set to database_if_col_alias</span>
    <span class="k">if</span> <span class="n">if_db_status</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">if_available_years_list</span><span class="p">:</span>
            <span class="n">year_database_if_col_alias</span> <span class="o">=</span> <span class="n">database_if_col_alias</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">year</span>
            <span class="n">if_df</span><span class="p">[</span><span class="n">year</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">year_database_if_col_alias</span><span class="p">:</span> <span class="n">database_if_col_alias</span><span class="p">},</span>
                               <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Replacing NAN in if_df</span>
    <span class="n">values_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">issn_col_alias</span>       <span class="p">:</span> <span class="n">unknown_alias</span><span class="p">,</span>
                   <span class="n">eissn_col_alias</span>      <span class="p">:</span> <span class="n">unknown_alias</span><span class="p">,</span>
                   <span class="n">database_if_col_alias</span><span class="p">:</span> <span class="n">not_available_if_alias</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">if_available_years_list</span><span class="p">:</span>
        <span class="n">if_df</span><span class="p">[</span><span class="n">year</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">values_dict</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Building the IF dict keyed by issn or e-issn of journals for the most recent year</span>
    <span class="n">most_recent_year_if_dict</span> <span class="o">=</span> <span class="n">_build_if_dict</span><span class="p">(</span><span class="n">if_df</span><span class="p">,</span> <span class="n">if_most_recent_year</span><span class="p">,</span> <span class="n">aliases_tup</span><span class="p">)</span>

    <span class="c1"># Setting local column names</span>
    <span class="n">most_recent_year_if_col</span> <span class="o">=</span> <span class="n">current_if_col_alias</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">if_most_recent_year</span>
    <span class="n">year_db_if_col</span>          <span class="o">=</span> <span class="n">database_if_col_alias</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">corpus_year</span>
    <span class="c1">#final_year_col          = year_col_alias[0:5]</span>
    <span class="n">journal_upper_col</span>       <span class="o">=</span> <span class="n">journal_col_alias</span> <span class="o">+</span> <span class="s1">&#39;_Upper&#39;</span>

    <span class="c1"># Getting the df where to add IFs</span>
    <span class="n">corpus_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">in_file_path</span><span class="p">)</span>

    <span class="c1"># Recasting column names</span>
    <span class="n">new_base_col_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">otp_col_alias</span><span class="p">,</span> <span class="n">otp_col_new_alias</span><span class="p">),</span>
            <span class="n">base_col_list</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">otp_col_alias</span> <span class="ow">in</span> <span class="n">corpus_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">corpus_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">otp_col_alias</span> <span class="p">:</span> <span class="n">otp_col_new_alias</span><span class="p">},</span>
                         <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Setting type of values in &#39;year_col_alias&#39; as string</span>
    <span class="n">corpus_df</span> <span class="o">=</span> <span class="n">corpus_df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">year_col_alias</span> <span class="p">:</span> <span class="nb">str</span><span class="p">})</span>

    <span class="c1"># Initializing &#39;corpus_df_bis&#39; as copy of &#39;corpus_df&#39;</span>
    <span class="n">corpus_df_bis</span> <span class="o">=</span> <span class="n">corpus_df</span><span class="p">[</span><span class="n">new_base_col_list</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Getting the df of ISSN and eISSN database of the institut</span>
    <span class="n">use_col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">journal_col_alias</span><span class="p">,</span> <span class="n">issn_col_alias</span><span class="p">,</span> <span class="n">eissn_col_alias</span><span class="p">]</span>
    <span class="n">inst_issn_df</span> <span class="o">=</span> <span class="n">_build_inst_issn_df</span><span class="p">(</span><span class="n">if_df</span><span class="p">,</span> <span class="n">use_col_list</span><span class="p">)</span>

    <span class="c1"># Filling unknown ISSN in &#39;corpus_df_bis&#39; using &#39;inst_issn_df&#39;</span>
    <span class="c1"># through _fullfill_issn function</span>
    <span class="n">corpus_df_bis</span> <span class="o">=</span> <span class="n">_fullfill_issn</span><span class="p">(</span><span class="n">corpus_df_bis</span><span class="p">,</span> <span class="n">inst_issn_df</span><span class="p">,</span> <span class="n">unknown_alias</span><span class="p">,</span> <span class="n">col_tup</span><span class="p">)</span>

    <span class="c1"># Adding &#39;most_recent_year_if_col&#39; column to &#39;corpus_df_bis&#39;</span>
    <span class="c1"># with values defined by internal function &#39;_create_if_column&#39;</span>
    <span class="n">corpus_df_bis</span><span class="p">[</span><span class="n">most_recent_year_if_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">_create_if_column</span><span class="p">(</span><span class="n">corpus_df_bis</span><span class="p">[</span><span class="n">issn_col_alias</span><span class="p">],</span>
                                                               <span class="n">most_recent_year_if_dict</span><span class="p">,</span>
                                                               <span class="n">unknown_if_fill_alias</span><span class="p">)</span>

    <span class="c1"># Adding &#39;corpus_year_if_col_alias&#39; column to &#39;corpus_df_bis&#39;</span>
    <span class="k">if</span> <span class="n">corpus_year</span> <span class="ow">in</span> <span class="n">if_available_years_list</span><span class="p">:</span>
        <span class="c1"># with values defined by internal function &#39;_create_if_column&#39;</span>
        <span class="c1"># Building the IF dict keyed by issn or e-issn of journals for the corpus year</span>
        <span class="n">current_year_if_dict</span> <span class="o">=</span> <span class="n">_build_if_dict</span><span class="p">(</span><span class="n">if_df</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">,</span> <span class="n">aliases_tup</span><span class="p">)</span>
        <span class="n">corpus_df_bis</span><span class="p">[</span><span class="n">corpus_year_if_col_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">_create_if_column</span><span class="p">(</span><span class="n">corpus_df_bis</span><span class="p">[</span><span class="n">issn_col_alias</span><span class="p">],</span>
                                                                    <span class="n">current_year_if_dict</span><span class="p">,</span>
                                                                    <span class="n">unknown_if_fill_alias</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># with &#39;not_available_if_alias&#39; value</span>
        <span class="n">corpus_df_bis</span><span class="p">[</span><span class="n">corpus_year_if_col_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_available_if_alias</span>

    <span class="c1"># Sorting &#39;corpus_df_bis&#39; pub_id values</span>
    <span class="n">corpus_df_bis</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="n">pub_id_col_alias</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Building &#39;year_pub_if_df&#39; with subset of &#39;corpus_df_bis&#39; columns</span>
    <span class="n">subsetcols</span> <span class="o">=</span> <span class="p">[</span><span class="n">pub_id_col_alias</span><span class="p">,</span>
                  <span class="n">year_col_alias</span><span class="p">,</span>
                  <span class="n">journal_col_alias</span><span class="p">,</span>
                  <span class="n">doctype_col_alias</span><span class="p">,</span>
                  <span class="n">issn_col_alias</span><span class="p">,</span>
                  <span class="n">most_recent_year_if_col</span><span class="p">,</span>
                  <span class="n">corpus_year_if_col_alias</span><span class="p">,]</span>
    <span class="n">year_pub_if_df</span> <span class="o">=</span> <span class="n">corpus_df_bis</span><span class="p">[</span><span class="n">subsetcols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Building &#39;year_article_if_df&#39; by keeping only rows which doc type has usually an IF</span>
    <span class="c1"># then droping the doc type column</span>
    <span class="n">year_article_if_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">year_pub_if_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">doc_type</span><span class="p">,</span> <span class="n">doc_type_df</span> <span class="ow">in</span> <span class="n">year_pub_if_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">doctype_col_alias</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">doc_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">doctype_to_drop_list_alias</span><span class="p">:</span>
            <span class="n">year_article_if_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">year_article_if_df</span><span class="p">,</span> <span class="n">doc_type_df</span><span class="p">])</span>
    <span class="n">year_article_if_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">doctype_col_alias</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Building &#39;year_if_df&#39; by keeping one row for each issn</span>
    <span class="c1"># adding a column with number of related articles</span>
    <span class="c1"># then droping &quot;Pub_id&quot; column</span>
    <span class="n">year_if_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">year_article_if_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="p">[</span><span class="mi">1</span><span class="p">:]</span> \
                                        <span class="o">+</span> <span class="p">[</span><span class="n">pub_id_nb_col_alias</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">issn_df</span> <span class="ow">in</span> <span class="n">year_article_if_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">issn_col_alias</span><span class="p">):</span>
        <span class="n">pub_id_nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">issn_df</span><span class="p">)</span>
        <span class="n">issn_df</span><span class="p">[</span><span class="n">pub_id_nb_col_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">pub_id_nb</span>
        <span class="n">issn_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">pub_id_col_alias</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">issn_df</span><span class="p">[</span><span class="n">journal_upper_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">issn_df</span><span class="p">[</span><span class="n">journal_col_alias</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">issn_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">journal_upper_col</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">issn_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">journal_upper_col</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">year_if_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">year_if_df</span><span class="p">,</span> <span class="n">issn_df</span><span class="p">])</span>

    <span class="c1"># Removing from &#39;year_if_df&#39; the rows which ISSN value is not in IF database</span>
    <span class="c1"># and keeping them in &#39;year_missing_issn_df&#39;</span>
    <span class="n">year_missing_issn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">year_if_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">year_missing_if_df</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">year_if_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">inst_issn_list</span>  <span class="o">=</span> <span class="n">inst_issn_df</span><span class="p">[</span><span class="n">issn_col_alias</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">inst_eissn_list</span> <span class="o">=</span> <span class="n">inst_issn_df</span><span class="p">[</span><span class="n">eissn_col_alias</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">year_if_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">row_issn</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">issn_col_alias</span><span class="p">]</span>
        <span class="n">row_most_recent_year_if</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">most_recent_year_if_col</span><span class="p">]</span>
        <span class="n">row_corpus_year_if</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">corpus_year_if_col_alias</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">row_issn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inst_issn_list</span> <span class="ow">and</span> <span class="n">row_issn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inst_eissn_list</span><span class="p">:</span>
            <span class="n">year_missing_issn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">year_missing_issn_df</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">unknown_alias</span> <span class="ow">in</span> <span class="p">[</span><span class="n">row_most_recent_year_if</span><span class="p">,</span> <span class="n">row_corpus_year_if</span><span class="p">]:</span>
            <span class="n">row_journal</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">journal_col_alias</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="n">issn_col_alias</span><span class="p">]</span>  <span class="o">=</span> <span class="n">_get_id</span><span class="p">(</span><span class="n">inst_issn_df</span><span class="p">,</span> <span class="n">row_journal</span><span class="p">,</span>
                                           <span class="n">journal_col_alias</span><span class="p">,</span> <span class="n">issn_col_alias</span><span class="p">,</span>
                                           <span class="n">unknown_alias</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="n">eissn_col_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_id</span><span class="p">(</span><span class="n">inst_issn_df</span><span class="p">,</span> <span class="n">row_journal</span><span class="p">,</span>
                                           <span class="n">journal_col_alias</span><span class="p">,</span> <span class="n">eissn_col_alias</span><span class="p">,</span>
                                           <span class="n">unknown_alias</span><span class="p">)</span>
            <span class="n">year_missing_if_df</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">year_missing_if_df</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>

    <span class="n">if_database_complete</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">year_missing_issn_df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">year_missing_if_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">if_database_complete</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># replace remaining unknown IF values by &#39;not_available_if_alias&#39; value</span>
        <span class="n">corpus_df_bis</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="n">most_recent_year_if_col</span><span class="p">:</span> <span class="n">unknown_if_fill_alias</span><span class="p">,</span>
                               <span class="n">corpus_year_if_col_alias</span>    <span class="p">:</span> <span class="n">unknown_if_fill_alias</span><span class="p">,</span>
                              <span class="p">},</span> <span class="n">outside_if_analysis_alias</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Formatting and saving &#39;corpus_df_bis&#39; as EXCEL file at full path &#39;out_file_path&#39;</span>
    <span class="n">wb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mise_en_page</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">corpus_df_bis</span><span class="p">)</span>
    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_file_path</span><span class="p">)</span>

    <span class="c1"># Setting common args list for &#39;_format_missing_df&#39; function</span>
    <span class="n">common_args_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">year_col_alias</span><span class="p">,</span> <span class="n">corpus_year_if_col_alias</span><span class="p">,</span>
                       <span class="n">most_recent_year_if_col</span><span class="p">,</span>
                       <span class="n">journal_col_alias</span><span class="p">,</span> <span class="n">issn_col_alias</span><span class="p">,</span> <span class="n">eissn_col_alias</span><span class="p">,</span>
                       <span class="n">pub_id_nb_col_alias</span><span class="p">,</span> <span class="n">year_db_if_col</span><span class="p">,</span>
                       <span class="n">corpus_issn_col_alias</span><span class="p">)</span>

    <span class="c1"># Formatting &#39;year_missing_issn_df&#39; and &#39;year_missing_if_df&#39;</span>
    <span class="n">sorted_year_missing_issn_df</span> <span class="o">=</span> <span class="n">_format_missing_df</span><span class="p">(</span>
        <span class="n">year_missing_issn_df</span><span class="p">,</span> <span class="n">common_args_tup</span><span class="p">,</span> <span class="n">unknown_alias</span><span class="p">,</span> <span class="n">add_cols</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">sorted_year_missing_if_df</span>   <span class="o">=</span> <span class="n">_format_missing_df</span><span class="p">(</span>
        <span class="n">year_missing_if_df</span><span class="p">,</span> <span class="n">common_args_tup</span><span class="p">,</span> <span class="n">unknown_alias</span><span class="p">,</span> <span class="n">add_cols</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Saving &#39;year_missing_issn_df&#39; as EXCEL file at full path &#39;missing_issn_path&#39;</span>
    <span class="n">wb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mise_en_page</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">sorted_year_missing_issn_df</span><span class="p">)</span>
    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">missing_issn_path</span><span class="p">)</span>

    <span class="c1"># Saving &#39;year_missing_if_df&#39; as EXCEL file at full path &#39;missing_if_path&#39;</span>
    <span class="n">wb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mise_en_page</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">sorted_year_missing_if_df</span><span class="p">)</span>
    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">missing_if_path</span><span class="p">)</span>

    <span class="n">end_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;IFs added for year </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> in file : </span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">{</span><span class="n">out_file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="k">return</span> <span class="n">end_message</span><span class="p">,</span> <span class="n">if_database_complete</span></div>



<div class="viewcode-block" id="split_pub_list_by_doc_type">
<a class="viewcode-back" href="../../functions.html#bmfuncts.consolidate_pub_list.split_pub_list_by_doc_type">[docs]</a>
<span class="k">def</span> <span class="nf">split_pub_list_by_doc_type</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `split_pub_list_by_doc_type` splits the dataframe </span>
<span class="sd">    of the publications final list of the &#39;corpus_year&#39; corpus into </span>
<span class="sd">    separated dataframes corresponding to different documents types.</span>
<span class="sd">    Then these dataframes are saved through the `mise_en_page` function </span>
<span class="sd">    imported from `bmfuncts.useful_functs` module. </span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        corpus_year (str): 4 digits year of the corpus.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (int): Split ratio in % of the publications final list.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1"># Setting useful aliases</span>
    <span class="n">pub_list_path_alias</span>      <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;pub list folder&quot;</span><span class="p">]</span>
    <span class="n">pub_list_file_base_alias</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;pub list file name base&quot;</span><span class="p">]</span>
    <span class="n">year_pub_list_file_alias</span> <span class="o">=</span> <span class="n">pub_list_file_base_alias</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">corpus_year</span>
    <span class="n">pub_list_file_alias</span>      <span class="o">=</span> <span class="n">year_pub_list_file_alias</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span>
    <span class="n">other_dg_file_alias</span>      <span class="o">=</span> <span class="n">year_pub_list_file_alias</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">pg</span><span class="o">.</span><span class="n">OTHER_DOCTYPE</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span>
    <span class="n">corpus_year_path</span>         <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">corpus_year</span><span class="p">)</span>
    <span class="n">pub_list_path</span>            <span class="o">=</span> <span class="n">corpus_year_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">pub_list_path_alias</span><span class="p">)</span>
    <span class="n">pub_list_file_path</span>       <span class="o">=</span> <span class="n">pub_list_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">pub_list_file_alias</span><span class="p">)</span>
    <span class="n">other_dg_path</span>            <span class="o">=</span> <span class="n">pub_list_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">other_dg_file_alias</span><span class="p">)</span>

    <span class="c1"># Setting useful column names</span>
    <span class="n">final_col_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">set_final_col_names</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">)</span>
    <span class="n">pub_id_col_alias</span> <span class="o">=</span> <span class="n">final_col_dic</span><span class="p">[</span><span class="s1">&#39;pub_id&#39;</span><span class="p">]</span>
    <span class="n">doc_type_alias</span>   <span class="o">=</span> <span class="n">final_col_dic</span><span class="p">[</span><span class="s1">&#39;doc_type&#39;</span><span class="p">]</span>

    <span class="n">full_pub_list_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">pub_list_file_path</span><span class="p">)</span>
    <span class="n">other_dg</span> <span class="o">=</span> <span class="n">full_pub_list_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">pub_nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_pub_list_df</span><span class="p">)</span>
    <span class="n">key_pub_nb</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">doctype_list</span> <span class="ow">in</span> <span class="n">pg</span><span class="o">.</span><span class="n">DOCTYPE_TO_SAVE_DICT</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">doctype_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="n">doctype_list</span><span class="p">]</span>
        <span class="n">key_dg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">full_pub_list_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">doc_type</span><span class="p">,</span> <span class="n">dg</span> <span class="ow">in</span> <span class="n">full_pub_list_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">doc_type_alias</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">doc_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">doctype_list</span><span class="p">:</span>
                <span class="n">key_dg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">key_dg</span><span class="p">,</span> <span class="n">dg</span><span class="p">])</span>
                <span class="n">other_dg</span> <span class="o">=</span> <span class="n">other_dg</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dg</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">key_pub_nb</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_dg</span><span class="p">)</span>

        <span class="n">key_dg_file_alias</span> <span class="o">=</span> <span class="n">year_pub_list_file_alias</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span>
        <span class="n">key_dg_path</span> <span class="o">=</span> <span class="n">pub_list_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">key_dg_file_alias</span><span class="p">)</span>

        <span class="n">key_dg</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">pub_id_col_alias</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">wb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mise_en_page</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">key_dg</span><span class="p">)</span>
        <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">key_dg_path</span><span class="p">)</span>

    <span class="n">other_dg</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="n">pub_id_col_alias</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">wb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mise_en_page</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">other_dg</span><span class="p">)</span>
    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">other_dg_path</span><span class="p">)</span>

    <span class="n">split_ratio</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">if</span> <span class="n">pub_nb</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">split_ratio</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">key_pub_nb</span> <span class="o">/</span> <span class="n">pub_nb</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">split_ratio</span></div>



<div class="viewcode-block" id="built_final_pub_list">
<a class="viewcode-back" href="../../functions.html#bmfuncts.consolidate_pub_list.built_final_pub_list">[docs]</a>
<span class="k">def</span> <span class="nf">built_final_pub_list</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span>
                         <span class="n">in_path</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">in_file_base</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `built_final_pub_list` builds the dataframe </span>
<span class="sd">    of the publications final list of the &#39;corpus_year&#39; corpus.</span>
<span class="sd">    First, a &#39;consolidate_pub_list_df&#39; dataframe is built through </span>
<span class="sd">    the concatenation of the dataframes got from the files of  </span>
<span class="sd">    OTPs attribution to publications of each of the Institute </span>
<span class="sd">    departments.</span>
<span class="sd">    Meanwhile, the set OTPS are saved through the `save_otps` </span>
<span class="sd">    function imported from `bmfuncts.use_pub_attributes` module.</span>
<span class="sd">    The publications attributed with &#39;INVALIDE&#39; OTP value, </span>
<span class="sd">    (imported from globals module, imported as gg) are dropped </span>
<span class="sd">    in the &#39;consolidate_pub_list_df&#39; dataframe and kept in </span>
<span class="sd">    the &#39;invalid_pub_list_df&#39; dedicated dataframe.</span>
<span class="sd">    These two dataframes are then saved as Excel file.</span>
<span class="sd">    The file saved from the &#39;consolidate_pub_list_df&#39; dataframe </span>
<span class="sd">    is added with impact factors values through the `add_if` function </span>
<span class="sd">    of the present module.</span>
<span class="sd">    Finally, it is split by documents type through the </span>
<span class="sd">    `split_pub_list_by_doc_type` function of the present module.</span>
<span class="sd">    A copy of all the created files is made in a folder specific to </span>
<span class="sd">    the combination type of data specified by &#39;datatype&#39; arg </span>
<span class="sd">    through the `save_final_results` function imported from </span>
<span class="sd">    the `bmfuncts.save_final_results` module.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        datatype (str): Data combination type from corpuses databases.</span>
<span class="sd">        in_path (path): Full path to folder of files where OTPs </span>
<span class="sd">                        have been attributed.</span>
<span class="sd">        out_path (path): Full path to folder where file of </span>
<span class="sd">                         publications final list and associated files </span>
<span class="sd">                         are saved.</span>
<span class="sd">        in_file_base (str): Base of OTPs files names.</span>
<span class="sd">        corpus_year (str): 4 digits year of the corpus.</span>

<span class="sd">    Returns :</span>
<span class="sd">        (tup): Tuple = (end message recalling the full path to the saved file </span>
<span class="sd">                        of the publication final list, </span>
<span class="sd">                        split ratio in % of the publications final list, </span>
<span class="sd">                        completion status of the impact-factors database).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># internal functions</span>
    <span class="k">def</span> <span class="nf">_set_df_otp_dpt</span><span class="p">(</span><span class="n">dpt_label</span><span class="p">):</span>
        <span class="n">otp_file_name_dpt_ok</span> <span class="o">=</span> <span class="n">in_file_base</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">dpt_label</span> <span class="o">+</span> <span class="s1">&#39;_ok.xlsx&#39;</span>

        <span class="n">dpt_path</span> <span class="o">=</span> <span class="n">in_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">otp_file_name_dpt_ok</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dpt_path</span><span class="p">):</span>
            <span class="n">otp_file_name_dpt</span> <span class="o">=</span> <span class="n">in_file_base</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">dpt_label</span> <span class="o">+</span> <span class="s1">&#39;.xlsx&#39;</span>
            <span class="n">dpt_path</span> <span class="o">=</span> <span class="n">in_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">otp_file_name_dpt</span><span class="p">)</span>
        <span class="n">dpt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">dpt_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dpt_df</span>

    <span class="c1"># Setting useful column names</span>
    <span class="n">final_col_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">set_final_col_names</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">)</span>
    <span class="n">final_col_list</span>   <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">final_col_dic</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">pub_list_filename_base_alias</span>     <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;pub list file name base&quot;</span><span class="p">]</span>
    <span class="n">missing_if_filename_base_alias</span>   <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_IF</span><span class="p">[</span><span class="s2">&quot;missing_if_base&quot;</span><span class="p">]</span>
    <span class="n">missing_issn_filename_base_alias</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_IF</span><span class="p">[</span><span class="s2">&quot;missing_issn_base&quot;</span><span class="p">]</span>
    <span class="n">invalid_pub_filename_base_alias</span>  <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;invalid file name base&quot;</span><span class="p">]</span>
    <span class="n">pub_id_alias</span>                     <span class="o">=</span> <span class="n">final_col_dic</span><span class="p">[</span><span class="s1">&#39;pub_id&#39;</span><span class="p">]</span>
    <span class="n">otp_alias</span>                        <span class="o">=</span> <span class="n">final_col_dic</span><span class="p">[</span><span class="s1">&#39;otp&#39;</span><span class="p">]</span>   <span class="c1"># Choix de l&#39;OTP</span>

    <span class="c1"># Setting useful paths</span>
    <span class="n">pub_list_file_path</span> <span class="o">=</span> <span class="n">out_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">pub_list_filename_base_alias</span> 
                                         <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">corpus_year</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span> <span class="p">)</span>
    <span class="n">missing_if_path</span>   <span class="o">=</span> <span class="n">out_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">corpus_year</span> <span class="o">+</span> <span class="n">missing_if_filename_base_alias</span><span class="p">)</span>
    <span class="n">missing_issn_path</span> <span class="o">=</span> <span class="n">out_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">corpus_year</span> <span class="o">+</span> <span class="n">missing_issn_filename_base_alias</span><span class="p">)</span>
    <span class="n">invalid_file_path</span> <span class="o">=</span> <span class="n">out_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">invalid_pub_filename_base_alias</span>
                                        <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">corpus_year</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">)</span>

    <span class="c1"># Setting institute parameters</span>
    <span class="n">dpt_label_dict</span> <span class="o">=</span> <span class="n">org_tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Getting dept OTPs df and concatenating them</span>
    <span class="n">dpt_label_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dpt_label_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">otp_df_init_status</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">dpt_label</span> <span class="ow">in</span> <span class="n">dpt_label_list</span><span class="p">:</span>
        <span class="n">dpt_df</span> <span class="o">=</span> <span class="n">_set_df_otp_dpt</span><span class="p">(</span><span class="n">dpt_label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">otp_df_init_status</span><span class="p">:</span>
            <span class="n">otp_df</span> <span class="o">=</span> <span class="n">dpt_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">otp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">otp_df</span><span class="p">,</span> <span class="n">dpt_df</span><span class="p">])</span>
        <span class="n">otp_df_init_status</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Deduplicating rows on Pub_id</span>
    <span class="n">otp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">pub_id_alias</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Selecting useful columns using final_col_list</span>
    <span class="n">consolidate_pub_list_df</span> <span class="o">=</span> <span class="n">otp_df</span><span class="p">[</span><span class="n">final_col_list</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Saving df to EXCEL file</span>
    <span class="n">consolidate_pub_list_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">pub_list_file_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Saving set OTPs</span>
    <span class="n">otp_message</span> <span class="o">=</span> <span class="n">save_otps</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">)</span>

    <span class="c1"># Setting pub ID as index for unique identification of rows</span>
    <span class="n">consolidate_pub_list_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">pub_id_alias</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Droping invalide publications by pub Id as index</span>
    <span class="n">invalid_pub_list_df</span> <span class="o">=</span> <span class="n">consolidate_pub_list_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="n">consolidate_pub_list_df</span><span class="p">[</span><span class="n">consolidate_pub_list_df</span><span class="p">[</span><span class="n">otp_alias</span><span class="p">]</span> \
                                <span class="o">!=</span> <span class="n">ig</span><span class="o">.</span><span class="n">INVALIDE</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">consolidate_pub_list_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">consolidate_pub_list_df</span><span class="p">[</span><span class="n">consolidate_pub_list_df</span><span class="p">[</span><span class="n">otp_alias</span><span class="p">]</span> \
                                                         <span class="o">==</span> <span class="n">ig</span><span class="o">.</span><span class="n">INVALIDE</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                 <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Resetting pub ID as a standard column</span>
    <span class="n">consolidate_pub_list_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Re_saving df to EXCEL file</span>
    <span class="n">consolidate_pub_list_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">pub_list_file_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">invalid_pub_list_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">invalid_file_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Adding Impact Factors and saving new consolidate_pub_list_df</span>
    <span class="c1"># this also for saving results files to complete IFs database</span>
    <span class="n">paths_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">pub_list_file_path</span><span class="p">,</span> <span class="n">pub_list_file_path</span><span class="p">,</span>
                 <span class="n">missing_if_path</span><span class="p">,</span> <span class="n">missing_issn_path</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">if_database_complete</span> <span class="o">=</span> <span class="n">add_if</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span>
                                     <span class="n">paths_tup</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">)</span>

    <span class="c1"># Splitting saved file by documents types (ARTICLES, BOOKS and PROCEEDINGS)</span>
    <span class="n">split_ratio</span> <span class="o">=</span> <span class="n">split_pub_list_by_doc_type</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">)</span>

    <span class="c1"># Saving pub list as final result</span>
    <span class="n">status_values</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">RESULTS_TO_SAVE</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span>
    <span class="n">results_to_save_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">RESULTS_TO_SAVE</span><span class="p">,</span> <span class="n">status_values</span><span class="p">))</span>
    <span class="n">results_to_save_dict</span><span class="p">[</span><span class="s2">&quot;pub_lists&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">if_analysis_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">final_save_message</span> <span class="o">=</span> <span class="n">save_final_results</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span>
                                            <span class="n">datatype</span><span class="p">,</span> <span class="n">corpus_year</span><span class="p">,</span> <span class="n">if_analysis_name</span><span class="p">,</span>
                                            <span class="n">results_to_save_dict</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">end_message</span>  <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">otp_message</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">OTPs identification integrated in file: </span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">{</span><span class="n">pub_list_file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Publications list for year </span><span class="si">{</span><span class="n">corpus_year</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;has been </span><span class="si">{</span><span class="n">split_ratio</span><span class="si">}</span><span class="s2"> % split &quot;</span>
                    <span class="s2">&quot;in several files by group of document types. </span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">final_save_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">end_message</span><span class="p">,</span> <span class="n">split_ratio</span><span class="p">,</span> <span class="n">if_database_complete</span></div>



<div class="viewcode-block" id="concatenate_pub_lists">
<a class="viewcode-back" href="../../functions.html#bmfuncts.consolidate_pub_list.concatenate_pub_lists">[docs]</a>
<span class="k">def</span> <span class="nf">concatenate_pub_lists</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">bibliometer_path</span><span class="p">,</span> <span class="n">years_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function `concatenate_pub_lists` builds the concatenated dataframe </span>
<span class="sd">    of the publications lists of the corpuses listed in &#39;years_list&#39;.</span>
<span class="sd">    Then, the dataframe is saved through the `mise_en_page` function </span>
<span class="sd">    imported from `bmfuncts.useful_functs` module.</span>

<span class="sd">    Args:</span>
<span class="sd">        institute (str): Institute name.</span>
<span class="sd">        org_tup (tup): Contains Institute parameters.</span>
<span class="sd">        bibliometer_path (path): Full path to working folder.</span>
<span class="sd">        years_list (list): List of 4 digits years of the available </span>
<span class="sd">                           publications lists.</span>

<span class="sd">    Returns :</span>
<span class="sd">        (str): End message recalling folder and file name where file is saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setting useful aliases</span>
    <span class="n">pub_list_path_alias</span>      <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;pub list folder&quot;</span><span class="p">]</span>
    <span class="n">pub_list_file_base_alias</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_YEAR</span><span class="p">[</span><span class="s2">&quot;pub list file name base&quot;</span><span class="p">]</span>
    <span class="n">bdd_multi_annuelle_folder_alias</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_BDD_MULTI_ANNUELLE</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span>
    <span class="n">bdd_multi_annuelle_file_alias</span>   <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ARCHI_BDD_MULTI_ANNUELLE</span><span class="p">[</span><span class="s2">&quot;concat file name base&quot;</span><span class="p">]</span>

    <span class="c1"># Building the concatenated dataframe of available publications lists</span>
    <span class="n">df_concat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">available_liste_conso</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">corpus_folder_path</span> <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="n">pub_list_folder_path</span> <span class="o">=</span> <span class="n">corpus_folder_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">pub_list_path_alias</span><span class="p">)</span>
            <span class="n">pub_list_file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pub_list_file_base_alias</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.xlsx&quot;</span>
            <span class="n">pub_list_path</span> <span class="o">=</span> <span class="n">pub_list_folder_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">pub_list_file_name</span><span class="p">)</span>
            <span class="n">df_inter</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">pub_list_path</span><span class="p">)</span>
            <span class="n">df_concat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_concat</span><span class="p">,</span> <span class="n">df_inter</span><span class="p">])</span>
            <span class="n">available_liste_conso</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># Formatting and saving the concatenated dataframe in an EXCEL file</span>
    <span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())[:</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">bdd_multi_annuelle_file_alias</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">available_liste_conso</span><span class="si">}</span><span class="s2">.xlsx&quot;</span><span class="p">)</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">bibliometer_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">bdd_multi_annuelle_folder_alias</span><span class="p">)</span>
    <span class="n">out_file_path</span> <span class="o">=</span> <span class="n">out_path</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>

    <span class="n">wb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mise_en_page</span><span class="p">(</span><span class="n">institute</span><span class="p">,</span> <span class="n">org_tup</span><span class="p">,</span> <span class="n">df_concat</span><span class="p">)</span>
    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_file_path</span><span class="p">)</span>

    <span class="n">end_message</span>  <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Concatenation of consolidated pub lists saved in folder: </span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="n">end_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> under filename: </span><span class="se">\n</span><span class="s2">  &#39;</span><span class="si">{</span><span class="n">out_file</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
    <span class="k">return</span> <span class="n">end_message</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, BiblioMeter team, Liten, Leti, CEA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>